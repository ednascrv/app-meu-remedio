<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meu Rem√©dio Avan√ßado</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2196f3">
<link rel="icon" href="icon-192.png" sizes="192x192" />
<style>
:root{--blue1:#4fc3f7;--blue2:#0288d1;--accent:#01579b;--bg:#ffffff;--card-shadow:0 6px 18px rgba(1,25,60,0.08);}
*{box-sizing:border-box} body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased;}
header{background:linear-gradient(90deg,var(--blue1), var(--blue2));color:white;padding:22px 16px;text-align:center;font-size:22px;font-weight:700;border-bottom-left-radius:18px;border-bottom-right-radius:18px;}
.app{padding:16px;padding-bottom:90px;max-width:720px;margin:0 auto;}
.btn-primary{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:18px;font-size:20px;font-weight:700;border-radius:16px;border:none;color:white;background:linear-gradient(90deg,var(--blue1),var(--blue2));box-shadow: var(--card-shadow);cursor:pointer;margin-bottom:8px;}
.btn-small{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--blue1),var(--blue2));color:white;font-weight:700;cursor:pointer;}
.row{display:flex; gap:12px; align-items:center;}
.card{background:#f8fafc; border-radius:16px; padding:14px; box-shadow: var(--card-shadow); margin-top:14px;}
.block{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px; border-radius:14px; background:linear-gradient(180deg,#fff,#f2fbff); box-shadow:0 3px 10px rgba(2,136,209,0.06);}
.block .left{display:flex; gap:12px; align-items:center;}
.pill-img{width:84px;height:84px;border-radius:12px;object-fit:cover;border:3px solid rgba(2,136,209,0.12); background:#fff}
h2.title{margin:0;font-size:20px;}
p.time{margin:0;font-size:28px;font-weight:800;color:var(--accent);}
.actions{display:flex; gap:8px;}
.btn-took{padding:12px 18px;border-radius:28px;border:none;font-weight:800;color:white;}
.green{background:linear-gradient(90deg,#66bb6a,#2e7d32);}
.red{background:linear-gradient(90deg,#ef5350,#c62828);}
.ghost{background:transparent;border:2px solid rgba(1,87,155,0.12); color:var(--accent)}
table{width:100%;border-collapse:collapse;margin-top:14px;font-size:16px}
th,td{padding:8px;border-bottom:1px solid #e6f0f7;text-align:left}
th{color:#012b48;font-weight:700}
footer{position:fixed; left:0; right:0; bottom:0; height:68px; background: linear-gradient(90deg,var(--blue1), var(--blue2)); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; border-top-left-radius:14px;border-top-right-radius:14px;}
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:9999;}
.modal.open{display:flex;}
.modal-content{width:94%; max-width:540px; background:white; border-radius:12px; padding:16px;}
.form-row{margin-bottom:10px}
label{display:block; font-size:14px; margin-bottom:6px}
input[type="text"], input[type="time"], textarea, select, input[type="file"], input[type="number"]{width:100%; padding:10px; border-radius:8px; border:1px solid #d8eefb;}
.small{font-size:13px;color:#666;margin-top:6px}
.history-list{max-height:260px; overflow:auto; padding:6px}
.history-item{padding:10px;border-radius:8px;background:#f6fdff;margin-bottom:8px;font-size:14px}
.flex-space{display:flex; justify-content:space-between; align-items:center}
@media(min-width:680px){ .app{padding:28px} }
#ariaStatus{position:absolute; left:-9999px; top:auto;}
#fullAlert{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:36px;font-weight:700;color:#01579b;display:none;z-index:99999;text-align:center;}
</style>
</head>
<body>
<header>üíä Meu Rem√©dio Avan√ßado</header>
<div class="app">
  <button id="btnManual" class="btn-primary">‚úèÔ∏è Adicionar medicamento manualmente</button>
  <button id="btnAdd" class="btn-primary">üì∏ Adicionar receita (OCR)</button>
  <button id="btnVoz" class="btn-primary">üéôÔ∏è Comando de voz</button>
  <button id="btnAlarm" class="btn-primary">‚è∞ Abrir alarme do dispositivo</button>
  <input id="inpFotoOCR" type="file" accept="image/*" capture="environment" style="display:none;">
  <div id="blocosContainer" aria-live="polite"></div>

  <div class="card">
    <div class="flex-space">
      <h2 style="margin:0">Lista de medicamentos</h2>
      <div>
        <button id="btnExport" class="btn-small">Exportar JSON</button>
        <button id="btnImport" class="btn-small">Importar JSON</button>
      </div>
    </div>
    <table id="tblRemedios" aria-label="Lista de medicamentos">
      <thead>
        <tr><th scope="col">Foto</th><th scope="col">Paciente</th><th scope="col">Nome</th><th scope="col">Hor√°rios</th><th scope="col">A√ß√µes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="flex-space">
      <h2 style="margin:0">Hist√≥rico</h2>
      <button id="btnLimparHistorico" class="btn-small ghost">Limpar</button>
    </div>
    <div id="historyList" class="history-list" aria-live="polite"></div>
  </div>
</div>

<footer>üíô Meu Rem√©dio</footer>
<div id="ariaStatus" aria-live="polite"></div>
<div id="fullAlert"></div>

<!-- Modal e input foto/rem√©dio aqui (igual ao c√≥digo anterior) -->

<!-- Som de alerta -->
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>

<script>
/* =======================
   ARMAZENAMENTO
======================= */
const LS_KEY='meu_remedio_avancado', LS_HIST='meu_remedio_hist_avancado';
let remedios=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
let historico=JSON.parse(localStorage.getItem(LS_HIST)||'[]');

/* =======================
   UTILIDADES
======================= */
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function salvarTudo(){ localStorage.setItem(LS_KEY,JSON.stringify(remedios)); localStorage.setItem(LS_HIST,JSON.stringify(historico)); }
function speak(text){ if(!text) return; if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(text); u.lang='pt-BR'; speechSynthesis.speak(u); } }
function playAlertSound(){ document.getElementById('alertSound').currentTime=0; document.getElementById('alertSound').play().catch(()=>{}); }
function nowBrasilia(){ const now=new Date(); const utc=now.getTime()+now.getTimezoneOffset()*60000; return new Date(utc+(-3*3600000)); }

/* =======================
   GERAR HOR√ÅRIOS AUTOM√ÅTICOS
======================= */
function gerarHorariosAutomaticos(instrucao,horaInicial="08:00",maxQtd=24){
  const regex=/a cada (\d{1,2}) horas?/i;
  const match=instrucao.match(regex);
  const intervalo = match ? parseInt(match[1]) : null;
  if(!intervalo) return [];
  const [hh,mm]=horaInicial.split(':').map(Number);
  let horarios=[]; let current=new Date(); current.setHours(hh,mm,0,0);
  for(let i=0;i<maxQtd;i++){ horarios.push(current.toTimeString().slice(0,5)); current.setHours(current.getHours()+intervalo); if(current.getDate()!==new Date().getDate()) break;}
  return horarios;
}

/* =======================
   AGENDAR REM√âDIO
======================= */
function agendarRemedio(remedio){
  let horarios = remedio.horarios.length>0 ? remedio.horarios : gerarHorariosAutomaticos(remedio.instrucao);
  horarios.forEach(hhmm=>{
    const [hh,mm]=hhmm.split(':').map(Number);
    let proximo = nowBrasilia(); proximo.setHours(hh,mm,0,0);
    if(proximo<=nowBrasilia()) proximo.setDate(proximo.getDate()+1);
    const delay = proximo - nowBrasilia();
    setTimeout(()=>{
      const msg=`${remedio.paciente||'Paciente'} tomar ${remedio.nome} agora.`;
      speak(msg); playAlertSound(); alert(msg);
      if(navigator.serviceWorker.controller) navigator.serviceWorker.controller.postMessage({type:'REMINDER_MULTI', lista:[remedio]});
      // Reagendar automaticamente
      agendarRemedio(remedio);
    }, delay);
  });
}

/* =======================
   INICIAR AGENDAMENTO
======================= */
remedios.forEach(r=>agendarRemedio(r));

/* =======================
   SERVICE WORKER
======================= */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registrado')).catch(e=>console.log(e)); }
if(Notification.permission!=='granted'){ Notification.requestPermission().then(p=>console.log('Permiss√£o:',p)); }
</script>
</body>
</html>
