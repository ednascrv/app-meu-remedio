<!doctype html> 
<html lang="pt-BR"> 
<head> 
<meta charset="utf-8" /> 
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" /> 
<title>Meu Rem√©dio</title> 

<!-- PWA Meta Tags -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00796b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Meu Rem√©dio">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  /* ================= CORRE√á√ïES PARA BOT√ïES ================= */
.btn-primary, .btn-small, .btn-ghost {
  position: relative;
  z-index: 1;
  pointer-events: auto !important;
  touch-action: manipulation;
}

/* Garantir que bot√µes estejam clic√°veis */
button:not(:disabled) {
  cursor: pointer !important;
}

/* Remover estilos padr√£o que podem interferir */
button {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background: none;
  border: none;
  font-family: inherit;
}

/* Corre√ß√£o espec√≠fica para bot√µes do tutorial */
.tutorial-nav-buttons button {
  min-width: 120px;
  padding: 12px 16px !important;
  margin: 5px;
  flex: 1;
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
}

/* Bot√£o Come√ßar a Usar - Corre√ß√£o Definitiva */
#btnStartApp {
  display: none;
  background: linear-gradient(135deg, #66bb6a, #81c784) !important;
  color: white !important;
  border: none !important;
  font-weight: 600;
  opacity: 1 !important;
  visibility: visible !important;
}

#btnStartApp[style*="block"] {
  display: block !important;
}

.tutorial-step[data-step="4"] #btnStartApp {
  display: block !important;
}

/* Bot√µes na tabela */
.actions button {
  margin: 2px;
  padding: 6px 10px !important;
  font-size: 12px !important;
  white-space: nowrap;
}

/* Bot√µes de controle de texto */
.text-controls button {
  padding: 8px 12px !important;
  font-size: 13px !important;
  border: 1px solid #e1e8ed !important;
}

/* Hover states para melhor feedback */
.btn-primary:hover, .btn-small:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
}

.btn-ghost:hover {
  background: #f8f9fa !important;
  border-color: #4a9eff !important;
  color: #4a9eff !important;
}
/* ================= VARI√ÅVEIS E ESTILOS GERAIS ================= */
:root{ 
  --blue:#0077b6; --green:#2e7d32; --accent:#013233; --bg:#fbfdfc; 
  --card:#fff; --muted:#6c7a7a; --shadow:0 6px 18px rgba(2,48,60,0.08); 
  --gap:12px; --radius:12px; 
}
*{box-sizing:border-box} 
html,body{height:100%} 
body{
  margin:0;
  font-family:Inter, "Segoe UI", Arial, sans-serif;
  background:var(--bg);
  color:var(--accent);
  -webkit-font-smoothing:antialiased;
  font-size: 16px;
} 

header{
  background:linear-gradient(90deg,var(--blue),var(--green));
  color:white;
  padding:14px 12px;
  text-align:center;
  font-size:18px;
  font-weight:800;
  border-bottom-left-radius:14px;
  border-bottom-right-radius:14px;
  position:sticky;
  top:0;
  z-index:20;
} 

.app{
  max-width:920px;
  margin:10px auto;
  padding:12px;
  padding-bottom: 70px;
} 

.controls{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-bottom:12px;
} 

@media (max-width:720px){ 
  .controls{ grid-template-columns:1fr } 
} 

.btn-primary{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:12px;
  border-radius:12px;
  border:none;
  background:linear-gradient(90deg,var(--blue),var(--green));
  color:white;
  font-weight:700;
  font-size:15px;
  box-shadow:var(--shadow);
  width:100%;
  cursor: pointer;
} 

.btn-small{
  padding:8px 12px;
  border-radius:10px;
  border:none;
  background:linear-gradient(90deg,var(--blue),var(--green));
  color:white;
  font-weight:700;
  cursor:pointer;
  font-size: 14px;
}

.btn-ghost{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #e6f3f0;
  background:transparent;
  color:var(--accent);
  cursor:pointer;
  font-size: 14px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:12px;
  box-shadow:var(--shadow);
  margin-bottom:12px;
} 

.flex{
  display:flex;
  gap:8px;
  align-items:center;
} 

.flex-space{
  display:flex;
  justify-content:space-between;
  align-items:center;
} 

h2{
  margin:0;
  color:var(--blue);
  font-size:16px;
} 

.small{
  font-size:13px;
  color:var(--muted);
  margin-top:6px;
} 

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
} 

.table th,.table td{
  padding:8px;
  border-bottom:1px solid #eef6f1;
  text-align:left;
} 

.table th{
  font-weight:700;
  color:#0a3b4a;
} 

.footer{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  height:56px;
  background:linear-gradient(90deg,var(--blue),var(--green));
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-weight:700;
  border-top-left-radius:12px;
  border-top-right-radius:12px;
  z-index:10;
}

/* ================= MODALS ================= */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.45);
  z-index:9999;
  padding:12px;
}

.modal.open{
  display:flex;
}

.modal-content{
  width:100%;
  max-width:680px;
  background:#fff;
  border-radius:12px;
  padding:16px;
  max-height:92vh;
  overflow:auto;
}

.form-row{
  margin-bottom:10px;
}

label{
  display:block;
  font-weight:700;
  margin-bottom:6px;
}

input[type="text"], input[type="time"], input[type="date"], textarea, select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #e8f1ef;
  font-size:15px;
}

.history-item{
  background:#f6fffb;
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
}

.actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.kv{
  font-size:13px;
  color:#4a5a5a;
}

.pill-img{
  width:56px;
  height:40px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #e6f3f0;
}

.small-note{
  font-size:12px;
  color:#667;
}

.hidden{
  display:none !important;
}

.input-file-wrapper{
  display:flex;
  gap:8px;
  align-items:center;
}

.status-online, .status-offline {
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
  font-weight:700;
}

.status-online{
  background:#e8f5e8;
  color:#2e7d32;
}

.status-offline{
  background:#ffebee;
  color:#c62828;
}

.badge{
  background:var(--blue);
  color:white;
  padding:2px 6px;
  border-radius:4px;
  font-size:11px;
  font-weight:700;
}

/* ================= TUTORIAL STYLES ================= */
.tutorial-steps {
  margin: 20px 0;
  min-height: 200px;
}

.tutorial-step {
  padding: 15px;
  background: #f8fdff;
  border-radius: 10px;
  border-left: 4px solid var(--blue);
}

.tutorial-step.hidden {
  display: none;
}

.tutorial-step.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

.tutorial-voice {
  background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: bold;
}

.tutorial-tip {
  background: #fff3cd;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  border-left: 4px solid #ffc107;
}

.tutorial-demo {
  text-align: center;
  margin: 15px 0;
}

.tutorial-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin: 15px 0;
}

.tutorial-button-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 10px;
  background: white;
  border-radius: 8px;
  border: 2px solid #e6f3f0;
}

.tutorial-button-item button {
  width: 60px;
  height: 60px;
  font-size: 20px;
}

/* Bot√£o de Ajuda Flutuante */
.help-floating {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: linear-gradient(90deg, #ff6b6b, #ff8e53);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 20px;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
  z-index: 1000;
  cursor: pointer;
  animation: pulse 2s infinite;
  display: none;
}

.help-floating:hover {
  transform: scale(1.05);
}

/* Anima√ß√µes */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}



/* Acessibilidade - Controles de Texto */
.text-controls {
  display: flex;
  gap: 8px;
  margin: 10px 0;
}

.text-controls button {
  padding: 6px 10px;
  font-size: 12px;
  border: 1px solid #ccc;
  background: white;
  border-radius: 4px;
  cursor: pointer;
}

/* Melhorias para os bot√µes do tutorial */
.tutorial-nav-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 20px;
  flex-wrap: wrap;
}

.tutorial-nav-buttons button {
  min-width: 120px;
  flex: 1;
}

/* CORRE√á√ÉO DEFINITIVA PARA BOT√ïES DO TUTORIAL */
#btnStartApp {
  display: none !important;
}

#btnStartApp[style*="display: block"] {
  display: block !important;
}

#btnNextTutorial, #btnSkipTutorial {
  display: block;
}

.tutorial-nav-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 20px;
  flex-wrap: wrap;
}

.tutorial-nav-buttons button {
  min-width: 120px;
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

#btnStartApp {
  background: linear-gradient(90deg, #2e7d32, #4caf50) !important;
  color: white !important;
  border: 2px solid #1b5e20 !important;
}

#btnStartApp:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
}

/* Garantir que os bot√µes fiquem vis√≠veis */
#btnStartApp {
  display: none !important;
  background: linear-gradient(90deg, #2e7d32, #4caf50) !important;
  font-weight: bold;
}

#btnStartApp:not(.hidden) {
  display: block !important;
}

#btnAcceptTerms {
  background: linear-gradient(90deg, #0077b6, #2196f3) !important;
}

/* Feedback visual para o √∫ltimo passo */
.tutorial-step[data-step="4"] {
  border-left-color: #4caf50;
  background: #f1f8e9;
}

/* Transi√ß√µes suaves para modais */
.modal {
  transition: opacity 0.3s ease;
}

.modal.open {
  animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
  from { 
    opacity: 0; 
    backdrop-filter: blur(0px);
  }
  to { 
    opacity: 1; 
    backdrop-filter: blur(4px);
  }
}

/* Melhorar visibilidade dos bot√µes de termos */
#modalTerms .modal-content {
  background: linear-gradient(135deg, #f8fdff, #ffffff);
  border: 2px solid #0077b6;
}

#modalTerms h3 {
  color: #0077b6;
  text-align: center;
}
/* ================= ESTILOS PARA RECEITAS ================= */
.receita-item {
  background: #f8fdff;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  border-left: 4px solid #4a9eff;
}

.receita-vencida {
  background: #ffebee;
  border-left: 4px solid #f44336;
  animation: pulse-alert 2s infinite;
}

.receita-proximo-vencimento {
  background: #fff3e0;
  border-left: 4px solid #ff9800;
}

.receita-valida {
  background: #e8f5e8;
  border-left: 4px solid #4caf50;
}

.status-receita {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  text-align: center;
  display: inline-block;
}

.status-vencida {
  background: #ffebee;
  color: #c62828;
}

.status-proximo {
  background: #fff3e0;
  color: #ef6c00;
}

.status-valida {
  background: #e8f5e8;
  color: #2e7d32;
}

.alert-warning {
  background: linear-gradient(135deg, #fff3e0, #ffecb3);
  border: 1px solid #ffd54f;
  border-left: 4px solid #ff9800;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
}

.alert-danger {
  background: linear-gradient(135deg, #ffebee, #ffcdd2);
  border: 1px solid #ef9a9a;
  border-left: 4px solid #f44336;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
}

.alert-info {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  border: 1px solid #90caf9;
  border-left: 4px solid #2196f3;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
}

@keyframes pulse-alert {
  0% { opacity: 1; }
  50% { opacity: 0.8; }
  100% { opacity: 1; }
}

.receita-foto-modal {
  max-width: 300px;
  max-height: 400px;
  border-radius: 8px;
  border: 2px solid #e6f3f0;
  cursor: zoom-in;
}

.receita-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.receita-modal-overlay.open {
  display: flex;
}

.receita-modal-img {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
</style>

</head> 

<body> 
<header>üíä Meu Rem√©dio</header> 

<main class="app" role="main" aria-labelledby="mainTitle"> 
  <div class="controls" role="group" aria-label="A√ß√µes principais"> 
    <button id="btnAddMed" class="btn-primary" aria-haspopup="dialog">‚úèÔ∏è Adicionar</button> 
    <button id="btnVoiceFlow" class="btn-primary">üéôÔ∏è Preencher por voz</button> 
    <button id="btnAlarm" class="btn-primary">‚è∞ Alarme/Lembrete</button> 
  </div> 

  <div class="card" aria-live="polite"> 
    <div class="flex-space"> 
      <h2>Configura√ß√µes</h2> 
      <div class="flex"> 
        <label><input type="checkbox" id="toggleNarrador" checked> Narrador</label> 
        <label style="margin-left:10px"><input type="checkbox" id="toggleVerboso"> Modo Verboso</label> 
      </div> 
    </div> 
    <div class="small">Ative narrador e modo verboso para que o app leia listas e hist√≥rico automaticamente.</div> 
    
    <!-- Controles de Acessibilidade -->
    <div class="text-controls">
      <button onclick="increaseTextSize()" title="Aumentar texto">A+</button>
      <button onclick="decreaseTextSize()" title="Diminuir texto">A-</button>
   
      <button onclick="readCurrentScreen()" title="Ler tela atual">üîä Ler Tela</button>
    </div>
    
    <div class="flex" style="margin-top:8px"> 
      <span id="connectionStatus" class="status-online">‚óè Online</span> 
      <span id="notificationStatus" class="status-offline" style="margin-left:8px">üîï Notifica√ß√µes</span> 
    </div> 
  </div> 

  <section class="card" aria-labelledby="medTitle" id="medSection"> 
    <div class="flex-space"> 
      <h2 id="medTitle">Medicamentos <span id="medCount" class="badge">0</span></h2> 
      <div class="actions"> 
        <button id="btnExport" class="btn-small">‚¨á Exportar</button> 
        <button id="btnImport" class="btn-small">‚¨Ü Importar</button> 
      </div> 
    </div>
    <table class="table" id="tblMeds" aria-describedby="Lista de medicamentos">
      <thead><tr><th>Foto</th><th>Paciente</th><th>Medicamento</th><th>Instru√ß√£o</th><th>Hora</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="emptyMeds" class="small">Nenhum medicamento cadastrado.</div>
  </section> 

  <section class="card" id="histSection"> 
    <div class="flex-space"> 
      <h2>Hist√≥rico (doses tomadas) <span id="histCount" class="badge">0</span></h2> 
      <div class="actions"><button id="btnClearHist" class="btn-ghost">Limpar hist√≥rico</button></div> 
    </div> 
    <div id="histList" style="margin-top:10px"></div> 
  </section> 

  <section class="card" id="consultSection"> 
    <div class="flex-space"> 
      <h2>Consultas <span id="consCount" class="badge">0</span></h2> 
      <div class="actions"><button id="btnAddConsult" class="btn-small">‚ûï Nova consulta</button></div> 
    </div>
    <table class="table" id="tblConsults">
      <thead><tr><th>Data</th><th>Profissional / Local</th><th>Observa√ß√£o</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="emptyConsults" class="small">Nenhuma consulta cadastrada.</div>
  </section> 
</main> 
<!-- Modal: Receitas M√©dicas -->
<div id="modalReceita" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalReceitaTitle">
  <div class="modal-content">
    <h3 id="modalReceitaTitle">üíä Nova Receita M√©dica</h3>
    
    <div class="form-row">
      <label for="receitaMedico">M√©dico/Profissional *</label>
      <input id="receitaMedico" type="text" placeholder="Dr. Jo√£o Silva - Cardiologista">
    </div>
    
    <div class="form-row">
      <label for="receitaPaciente">Paciente *</label>
      <input id="receitaPaciente" type="text" placeholder="Nome do paciente">
    </div>
    
    <div class="form-row">
      <label for="receitaMedicamentos">Medicamentos Prescritos</label>
      <textarea id="receitaMedicamentos" rows="3" placeholder="Lista de medicamentos da receita..."></textarea>
    </div>
    
    <div class="form-row">
      <label for="receitaDataEmissao">Data de Emiss√£o *</label>
      <input id="receitaDataEmissao" type="date">
    </div>
    
    <div class="form-row">
      <label for="receitaDataValidade">Data de Validade *</label>
      <input id="receitaDataValidade" type="date">
    </div>
    
    <div class="form-row">
      <label for="receitaObservacoes">Observa√ß√µes</label>
      <textarea id="receitaObservacoes" rows="2" placeholder="Observa√ß√µes importantes..."></textarea>
    </div>
    
    <div class="form-row">
      <label>Foto da Receita (opcional)</label>
      <div class="input-file-wrapper">
        <input id="receitaFotoInput" type="file" accept="image/*" capture="environment">
        <img id="receitaFotoPreview" class="pill-img hidden" alt="pr√©via da receita">
        <button id="btnRemoverFotoReceita" class="btn-ghost hidden" type="button">Remover foto</button>
      </div>
      <div class="small-note">üì∑ Fotografe a receita para ter uma c√≥pia digital</div>
    </div>
    
    <div class="alert-info" style="margin: 15px 0; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
      <strong>üí° Lembretes autom√°ticos:</strong> O app avisar√° 7 dias antes do vencimento.
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="btnCancelReceita" class="btn-ghost">Cancelar</button>
      <button id="btnSaveReceita" class="btn-small">üíæ Salvar Receita</button>
    </div>
  </div>
</div>

<!-- Se√ß√£o de Receitas no HTML principal - Adicione ap√≥s a se√ß√£o de Consultas -->
<section class="card" id="receitaSection">
  <div class="flex-space">
    <h2>üìã Receitas M√©dicas <span id="receitaCount" class="badge">0</span></h2>
    <div class="actions">
      <button id="btnAddReceita" class="btn-small">‚ûï Nova Receita</button>
    </div>
  </div>
  
  <div id="receitaAlerts" style="margin: 10px 0;"></div>
  
  <table class="table" id="tblReceitas" aria-describedby="Lista de receitas m√©dicas">
    <thead>
      <tr>
        <th>Foto</th>
        <th>Paciente</th>
        <th>M√©dico</th>
        <th>Emiss√£o</th>
        <th>Validade</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="emptyReceitas" class="small">Nenhuma receita cadastrada.</div>
</section>

<div class="footer">Meu Rem√©dio ‚Äî Privado & Local</div> 

<!-- ================= MODALS ================= -->

<!-- Modal: Medicamento Add/Edit --> 
<div id="modalMed" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMedTitle"> 
  <div class="modal-content"> 
    <h3 id="modalMedTitle">Adicionar medicamento</h3>
    <div class="form-row">
      <label for="medPaciente">Paciente</label>
      <input id="medPaciente" type="text" placeholder="Nome do paciente">
    </div>
    <div class="form-row">
      <label for="medNome">Medicamento *</label>
      <input id="medNome" type="text" placeholder="Ex: Paracetamol">
    </div>
    <div class="form-row">
      <label for="medInstr">Instru√ß√£o</label>
      <input id="medInstr" type="text" placeholder="Ex: a cada 8h">
    </div>
    <div class="form-row">
      <label for="medHora">Hora inicial *</label>
      <input id="medHora" type="time">
    </div>
    <div class="form-row">
      <label>Foto do medicamento</label>
      <div class="input-file-wrapper">
        <input id="medFotoInput" type="file" accept="image/*" capture="environment">
        <img id="medFotoPreview" class="pill-img hidden" alt="pr√©via">
        <button id="btnRemoverFoto" class="btn-ghost hidden" type="button">Remover foto</button>
      </div>
      <div class="small-note">Use a c√¢mera para capturar o frasco ou a caixa (opcional).</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="btnCancelMed" class="btn-ghost">Cancelar</button>
      <button id="btnSaveMed" class="btn-small">Salvar</button>
    </div>
  </div> 
</div> 

<!-- Modal: Consultas Add/Edit --> 
<div id="modalConsult" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalConsultTitle"> 
  <div class="modal-content"> 
    <h3 id="modalConsultTitle">Nova consulta</h3> 
    <div class="form-row"><label for="consData">Data *</label><input id="consData" type="date"></div> 
    <div class="form-row"><label for="consProf">Profissional / Local *</label><input id="consProf" type="text" placeholder="Ex: Dr. Fulano - Cardiologia"></div> 
    <div class="form-row"><label for="consObs">Observa√ß√£o</label><textarea id="consObs" rows="3" placeholder="Observa√ß√µes"></textarea></div> 
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"> 
      <button id="btnCancelCons" class="btn-ghost">Cancelar</button> 
      <button id="btnSaveCons" class="btn-small">Salvar</button> 
    </div> 
  </div> 
</div> 

<!-- Modal: Configura√ß√µes de Notifica√ß√£o -->
<div id="modalNotifSettings" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalNotifTitle">
  <div class="modal-content">
    <h3 id="modalNotifTitle">‚öôÔ∏è Configura√ß√µes de Notifica√ß√£o</h3>
    <div class="form-row">
      <label><input type="checkbox" id="notifMedEnabled" checked> Ativar lembretes de medicamentos</label>
    </div>
    <div class="form-row">
      <label><input type="checkbox" id="notifConsEnabled" checked> Ativar lembretes de consultas</label>
    </div>
    <div class="form-row">
      <label><input type="checkbox" id="notifSoundEnabled" checked> Som nas notifica√ß√µes</label>
    </div>
    <div class="form-row">
      <label for="notifAdvanceTime">Anteced√™ncia (minutos)</label>
      <select id="notifAdvanceTime">
        <option value="0">No hor√°rio exato</option>
        <option value="5">5 minutos antes</option>
        <option value="10">10 minutos antes</option>
        <option value="15" selected>15 minutos antes</option>
        <option value="30">30 minutos antes</option>
      </select>
    </div>
    <div class="small-note" style="margin-top:12px">
      <strong>Pr√≥ximos alarmes:</strong><br>
      <div id="nextAlarmsList"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="btnCancelNotif" class="btn-ghost">Fechar</button>
      <button id="btnTestNotif" class="btn-small">Testar Notifica√ß√£o</button>
    </div>
  </div>
</div>

<!-- Modal: Termos de Uso --> 
<div id="modalTerms" class="modal open" role="dialog" aria-modal="true" aria-labelledby="termsTitle"> 
  <div class="modal-content"> 
    <h3 id="termsTitle">üìú Termos de Uso</h3> 
    <div style="line-height:1.5;margin-top:8px"> 
      Ao utilizar este app, voc√™ concorda que as informa√ß√µes inseridas (nomes, hor√°rios, fotos) ser√£o armazenadas apenas no seu dispositivo (localStorage). Nenhum dado √© enviado sem seu consentimento. Este app √© um aux√≠lio e n√£o substitui orienta√ß√£o m√©dica. 
    </div> 
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"> 
      <button id="btnReadTerms" class="btn-ghost">üîä Ouvir termos</button> 
      <button id="btnAcceptTerms" class="btn-small">Aceitar</button> 
    </div> 
  </div> 
</div>

<!-- Modal: Tutorial Inicial -->
<div id="modalTutorial" class="modal" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
  <div class="modal-content" style="max-width: 500px;">
    <h3 id="tutorialTitle" style="text-align: center;">üéâ Bem-vindo ao Meu Rem√©dio!</h3>
    
    <div style="text-align: center; margin: 20px 0;">
      <div style="font-size: 48px; margin-bottom: 10px;">üíä</div>
      <p><strong>Seu assistente pessoal para medicamentos</strong></p>
    </div>

    <div class="tutorial-steps">
      <!-- Passo 1 -->
      <div class="tutorial-step active" data-step="1">
        <h4>üîä <span class="tutorial-voice">NARRADOR DE VOZ</span></h4>
        <p>O app FALA com voc√™! Toque nos bot√µes e escute as instru√ß√µes.</p>
        <div class="tutorial-tip">
          <strong>Dica:</strong> Deixe o narrador sempre LIGADO
        </div>
      </div>

      <!-- Passo 2 -->
      <div class="tutorial-step hidden" data-step="2">
        <h4>üéôÔ∏è <span class="tutorial-voice">COMANDOS POR VOZ</span></h4>
        <p>Use o bot√£o <strong>"Preencher por voz"</strong> para cadastrar rem√©dios falando.</p>
        <div class="tutorial-demo">
          <button class="btn-small" onclick="demoVoiceCommand()">üéôÔ∏è Experimente falar</button>
        </div>
      </div>

      <!-- Passo 3 -->
      <div class="tutorial-step hidden" data-step="3">
        <h4>‚è∞ <span class="tutorial-voice">LEMBRETES AUTOM√ÅTICOS</span></h4>
        <p>O app avisa na hora certa de tomar seus rem√©dios!</p>
        <ul style="text-align: left; margin: 15px 0;">
          <li>‚úÖ Toque em "Tomei" quando tomar</li>
          <li>üîî Receba lembretes no celular</li>
          <li>üìù Hist√≥rico para conferir</li>
        </ul>
      </div>

      <!-- Passo 4 -->
      <div class="tutorial-step hidden" data-step="4">
        <h4>üëÜ <span class="tutorial-voice">BOT√ïES COM S√çMBOLOS</span></h4>
        <div class="tutorial-buttons">
          <div class="tutorial-button-item">
            <button class="btn-small">‚úèÔ∏è</button>
            <span>Adicionar</span>
          </div>
          <div class="tutorial-button-item">
            <button class="btn-small">üéôÔ∏è</button>
            <span>Voz</span>
          </div>
          <div class="tutorial-button-item">
            <button class="btn-small">‚è∞</button>
            <span>Alarme</span>
          </div>
          <div class="tutorial-button-item">
            <button class="btn-small">‚úÖ</button>
            <span>Tomei</span>
          </div>
        </div>
      </div>
    </div>

    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
      <button id="btnPrevTutorial" class="btn-ghost" disabled>‚¨ÖÔ∏è Anterior</button>
      <button id="btnNextTutorial" class="btn-small">Pr√≥ximo ‚û°Ô∏è</button>
      <button id="btnSkipTutorial" class="btn-ghost">Pular Tutorial</button>
      <button id="btnStartApp" class="btn-small hidden">üéâ Come√ßar a Usar!</button>
    </div>

    <div style="text-align: center; margin-top: 15px;">
      <label>
        <input type="checkbox" id="dontShowAgain"> 
        N√£o mostrar tutorial novamente
      </label>
    </div>
  </div>
</div>

<!-- Bot√£o flutuante de Ajuda -->
<button id="btnHelp" class="help-floating" aria-label="Ajuda e tutorial" title="Precisa de ajuda?">
  ‚ùì Ajuda
</button>
<script>
  // ================= CSS CORRETIVO DIN√ÇMICO =================
// Adicione este c√≥digo no seu JavaScript para garantir que o bot√£o fique vis√≠vel
const tutorialCSSFix = `
/* CORRE√á√ÉO EXTRA PARA BOT√ÉO COME√áAR A USAR */
#btnStartApp[style*="display: block"] {
  display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
}

.tutorial-step[data-step="4"] #btnStartApp {
  display: block !important;
}
`;

// Adicionar CSS corretivo dinamicamente
const fixStyle = document.createElement('style');
fixStyle.textContent = tutorialCSSFix;
document.head.appendChild(fixStyle);

// ================= TESTE R√ÅPIDO =================
// Adicione este c√≥digo para testar imediatamente
function testarBotaoComecarUsar() {
  console.log('=== TESTANDO BOT√ÉO COME√áAR A USAR ===');
  
  const btnStart = document.getElementById('btnStartApp');
  console.log('Bot√£o encontrado:', !!btnStart);
  console.log('Display atual:', btnStart?.style.display);
  console.log('Classe atual:', btnStart?.className);
  
  // For√ßar exibi√ß√£o para teste
  if (btnStart) {
    btnStart.style.display = 'block';
    btnStart.classList.remove('hidden');
    console.log('Bot√£o for√ßado a aparecer');
  }
}

// Testar ap√≥s 2 segundos (remova depois que funcionar)
setTimeout(testarBotaoComecarUsar, 2000);
// ================= CONFIGURA√á√ïES INICIAIS =================
// Registrar Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/service-worker.js')
      .then(function(registration) {
        console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
      })
      .catch(function(error) {
        console.log('‚ùå Falha no registro do Service Worker:', error);
      });
  });
}

// ================= VARI√ÅVEIS GLOBAIS =================
const LS_MED = 'meu_remedio_med_photos_v3';
const LS_HIST = 'meu_remedio_hist_v3';
const LS_CONS = 'meu_remedio_consults_v3';
const LS_TERMS = 'meu_remedio_termos_v3';
const LS_TUTORIAL = 'meu_remedio_tutorial_v3';
const LS_NOTIF_SETTINGS = 'meu_remedio_notif_settings_v3';

let meds = JSON.parse(localStorage.getItem(LS_MED) || '[]');
let hist = JSON.parse(localStorage.getItem(LS_HIST) || '[]');
let consults = JSON.parse(localStorage.getItem(LS_CONS) || '[]');
const notifSettings = JSON.parse(localStorage.getItem(LS_NOTIF_SETTINGS) || '{"medEnabled":true,"consEnabled":true,"soundEnabled":true,"advanceTime":15}');

const scheduledTimers = new Map();
let isOnline = navigator.onLine;
let currentStep = 1;
const totalSteps = 4;

// ================= DEBUG DE BOT√ïES =================
function debugBotoes() {
  console.log('=== DEBUG DE BOT√ïES ===');
  
  // Verificar bot√µes principais
  const botoesPrincipais = [
    'btnAddMed', 'btnVoiceFlow', 'btnAlarm', 
    'btnAddReceita', 'btnAddConsult'
  ];
  
  botoesPrincipais.forEach(id => {
    const btn = document.getElementById(id);
    console.log(`${id}:`, {
      existe: !!btn,
      display: btn?.style?.display,
      visibility: btn?.style?.visibility,
      opacity: btn?.style?.opacity,
      pointerEvents: btn?.style?.pointerEvents,
      disabled: btn?.disabled
    });
  });

  // Verificar bot√µes do tutorial
  const botoesTutorial = [
    'btnNextTutorial', 'btnPrevTutorial', 
    'btnSkipTutorial', 'btnStartApp'
  ];
  
  botoesTutorial.forEach(id => {
    const btn = document.getElementById(id);
    console.log(`${id}:`, {
      existe: !!btn,
      display: getComputedStyle(btn).display,
      visibility: getComputedStyle(btn).visibility,
      opacity: getComputedStyle(btn).opacity
    });
  });
}

// Testar clique em todos os bot√µes
function testarCliqueBotoes() {
  console.log('=== TESTANDO CLIQUE EM BOT√ïES ===');
  
  document.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
      const btn = e.target.tagName === 'BUTTON' ? e.target : e.target.closest('button');
      console.log('Bot√£o clicado:', {
        id: btn.id,
        text: btn.textContent,
        classe: btn.className
      });
    }
  }, true);
}

// ================= CORRE√á√ÉO DE EVENT LISTENERS =================
function corrigirEventListeners() {
  console.log('=== CORRIGINDO EVENT LISTENERS ===');
  
  // Bot√µes principais
  const botoesConfig = [
    { id: 'btnAddMed', event: 'click', action: () => openMedModal() },
    { id: 'btnVoiceFlow', event: 'click', action: () => iniciarFluxoVoz() },
    { id: 'btnAlarm', event: 'click', action: () => abrirConfigAlarme() },
    { id: 'btnAddReceita', event: 'click', action: () => openReceitaModal() },
    { id: 'btnAddConsult', event: 'click', action: () => openConsultModal() },
    { id: 'btnExport', event: 'click', action: () => exportarDados() },
    { id: 'btnImport', event: 'click', action: () => importarDados() },
    { id: 'btnClearHist', event: 'click', action: () => limparHistorico() }
  ];

  botoesConfig.forEach(config => {
    const btn = document.getElementById(config.id);
    if (btn) {
      // Remover event listeners antigos
      btn.replaceWith(btn.cloneNode(true));
      const newBtn = document.getElementById(config.id);
      
      // Adicionar novo event listener
      newBtn.addEventListener(config.event, config.action);
      console.log(`‚úÖ ${config.id} - Event listener configurado`);
    } else {
      console.log(`‚ùå ${config.id} - Bot√£o n√£o encontrado`);
    }
  });
}
// ================= FUN√á√ïES DE ABERTURA DE FORMUL√ÅRIOS =================
function openMedModal(editId = null) {
  console.log('üíä Abrindo modal de medicamento...');
  
  // Resetar formul√°rio
  document.getElementById('medPaciente').value = '';
  document.getElementById('medNome').value = '';
  document.getElementById('medInstr').value = '';
  document.getElementById('medHora').value = '';
  document.getElementById('medFotoInput').value = '';
  document.getElementById('medFotoPreview').src = '';
  document.getElementById('medFotoPreview').classList.add('hidden');
  document.getElementById('btnRemoverFoto').classList.add('hidden');
  
  // Se for edi√ß√£o, preencher dados
  if (editId) {
    const med = meds.find(m => m.id === editId);
    if (med) {
      document.getElementById('medPaciente').value = med.paciente || '';
      document.getElementById('medNome').value = med.nome || '';
      document.getElementById('medInstr').value = med.instrucao || '';
      document.getElementById('medHora').value = med.hora || '';
      
      if (med.foto) {
        document.getElementById('medFotoPreview').src = med.foto;
        document.getElementById('medFotoPreview').classList.remove('hidden');
        document.getElementById('btnRemoverFoto').classList.remove('hidden');
      }
    }
  }
  
  // Abrir modal
  const modal = document.getElementById('modalMed');
  modal.classList.add('open');
  
  if (narrarEnabled()) {
    speak('Formul√°rio de medicamento aberto. Preencha os dados necess√°rios.');
  }
}

function openReceitaModal(editId = null) {
  console.log('üìã Abrindo modal de receita...');
  
  // Resetar formul√°rio
  document.getElementById('receitaMedico').value = '';
  document.getElementById('receitaPaciente').value = '';
  document.getElementById('receitaMedicamentos').value = '';
  document.getElementById('receitaDataEmissao').value = '';
  document.getElementById('receitaDataValidade').value = '';
  document.getElementById('receitaObservacoes').value = '';
  document.getElementById('receitaFotoInput').value = '';
  document.getElementById('receitaFotoPreview').src = '';
  document.getElementById('receitaFotoPreview').classList.add('hidden');
  document.getElementById('btnRemoverFotoReceita').classList.add('hidden');
  
  // Se for edi√ß√£o, preencher dados
  if (editId) {
    const receita = receitas.find(r => r.id === editId);
    if (receita) {
      document.getElementById('receitaMedico').value = receita.medico || '';
      document.getElementById('receitaPaciente').value = receita.paciente || '';
      document.getElementById('receitaMedicamentos').value = receita.medicamentos || '';
      document.getElementById('receitaDataEmissao').value = receita.dataEmissao || '';
      document.getElementById('receitaDataValidade').value = receita.dataValidade || '';
      document.getElementById('receitaObservacoes').value = receita.observacoes || '';
      
      if (receita.foto) {
        document.getElementById('receitaFotoPreview').src = receita.foto;
        document.getElementById('receitaFotoPreview').classList.remove('hidden');
        document.getElementById('btnRemoverFotoReceita').classList.remove('hidden');
      }
    }
  }
  
  // Abrir modal
  const modal = document.getElementById('modalReceita');
  modal.classList.add('open');
  
  if (narrarEnabled()) {
    speak('Formul√°rio de receita m√©dica aberto. Preencha os dados da receita.');
  }
}

function openConsultModal(editId = null) {
  console.log('üìÖ Abrindo modal de consulta...');
  
  // Resetar formul√°rio
  document.getElementById('consData').value = '';
  document.getElementById('consProf').value = '';
  document.getElementById('consObs').value = '';
  
  // Se for edi√ß√£o, preencher dados
  if (editId) {
    const consult = consults.find(c => c.id === editId);
    if (consult) {
      document.getElementById('consData').value = consult.data || '';
      document.getElementById('consProf').value = consult.prof || '';
      document.getElementById('consObs').value = consult.obs || '';
    }
  }
  
  // Abrir modal
  const modal = document.getElementById('modalConsult');
  modal.classList.add('open');
  
  if (narrarEnabled()) {
    speak('Formul√°rio de consulta aberto. Preencha os dados da consulta.');
  }
}

function openNotifSettings() {
  console.log('‚öôÔ∏è Abrindo configura√ß√µes de notifica√ß√£o...');
  document.getElementById('modalNotifSettings').classList.add('open');
  
  if (narrarEnabled()) {
    speak('Configura√ß√µes de notifica√ß√£o abertas.');
  }
}

// ================= CONFIGURA√á√ÉO CORRETA DOS EVENT LISTENERS =================
function configurarEventListeners() {
  console.log('üéØ Configurando event listeners...');
  
  // Bot√µes principais - Usando onclick para maior confiabilidade
  const btnAddMed = document.getElementById('btnAddMed');
  const btnAddReceita = document.getElementById('btnAddReceita');
  const btnAddConsult = document.getElementById('btnAddConsult');
  const btnAlarm = document.getElementById('btnAlarm');
  const btnVoiceFlow = document.getElementById('btnVoiceFlow');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const btnClearHist = document.getElementById('btnClearHist');
  const notificationStatus = document.getElementById('notificationStatus');
  
  // Configurar usando onclick (mais confi√°vel que addEventListener)
  if (btnAddMed) {
    btnAddMed.onclick = () => openMedModal();
    console.log('‚úÖ btnAddMed configurado');
  }
  
  if (btnAddReceita) {
    btnAddReceita.onclick = () => openReceitaModal();
    console.log('‚úÖ btnAddReceita configurado');
  }
  
  if (btnAddConsult) {
    btnAddConsult.onclick = () => openConsultModal();
    console.log('‚úÖ btnAddConsult configurado');
  }
  
  if (btnAlarm) {
    btnAlarm.onclick = () => openNotifSettings();
    console.log('‚úÖ btnAlarm configurado');
  }
  
  if (btnVoiceFlow) {
    btnVoiceFlow.onclick = iniciarFluxoVoz;
    console.log('‚úÖ btnVoiceFlow configurado');
  }
  
  if (btnExport) {
    btnExport.onclick = exportarDados;
    console.log('‚úÖ btnExport configurado');
  }
  
  if (btnImport) {
    btnImport.onclick = importarDados;
    console.log('‚úÖ btnImport configurado');
  }
  
  if (btnClearHist) {
    btnClearHist.onclick = limparHistorico;
    console.log('‚úÖ btnClearHist configurado');
  }
  
  if (notificationStatus) {
    notificationStatus.onclick = () => {
      console.log('üîî Abrindo configura√ß√µes de notifica√ß√£o...');
      openNotifSettings();
    };
    console.log('‚úÖ notificationStatus configurado');
  }
  
  // Bot√µes de fechar modais
  const btnCancelMed = document.getElementById('btnCancelMed');
  const btnCancelReceita = document.getElementById('btnCancelReceita');
  const btnCancelCons = document.getElementById('btnCancelCons');
  const btnCancelNotif = document.getElementById('btnCancelNotif');
  
  if (btnCancelMed) {
    btnCancelMed.onclick = () => {
      document.getElementById('modalMed').classList.remove('open');
      console.log('‚ùå Modal medicamento fechado');
    };
  }
  
  if (btnCancelReceita) {
    btnCancelReceita.onclick = () => {
      document.getElementById('modalReceita').classList.remove('open');
      console.log('‚ùå Modal receita fechado');
    };
  }
  
  if (btnCancelCons) {
    btnCancelCons.onclick = () => {
      document.getElementById('modalConsult').classList.remove('open');
      console.log('‚ùå Modal consulta fechado');
    };
  }
  
  if (btnCancelNotif) {
    btnCancelNotif.onclick = () => {
      document.getElementById('modalNotifSettings').classList.remove('open');
      console.log('‚ùå Modal notifica√ß√µes fechado');
    };
  }
  
  // Bot√µes de salvar
  const btnSaveMed = document.getElementById('btnSaveMed');
  const btnSaveReceita = document.getElementById('btnSaveReceita');
  const btnSaveCons = document.getElementById('btnSaveCons');
  
  if (btnSaveMed) {
    btnSaveMed.onclick = salvarMedicamento;
    console.log('‚úÖ btnSaveMed configurado');
  }
  
  if (btnSaveReceita) {
    btnSaveReceita.onclick = salvarReceita;
    console.log('‚úÖ btnSaveReceita configurado');
  }
  
  if (btnSaveCons) {
    btnSaveCons.onclick = salvarConsulta;
    console.log('‚úÖ btnSaveCons configurado');
  }
  
  // Fechar modais clicando fora
  configurarFechamentoModais();
}

function configurarFechamentoModais() {
  console.log('üéØ Configurando fechamento de modais...');
  
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.classList.remove('open');
        console.log(`‚ùå Modal ${modal.id} fechado (clique fora)`);
      }
    };
  });
}

// ================= FUN√á√ïES DE SALVAR =================
function salvarMedicamento() {
  console.log('üíæ Salvando medicamento...');
  
  const nome = document.getElementById('medNome').value.trim();
  if (!nome) {
    alert('Preencha o nome do medicamento.');
    return;
  }
  
  const paciente = document.getElementById('medPaciente').value.trim();
  const instr = document.getElementById('medInstr').value.trim();
  const hora = document.getElementById('medHora').value;
  
  // Verificar se √© edi√ß√£o
  const editId = document.getElementById('modalMed').getAttribute('data-edit-id');
  
  if (editId) {
    // Edi√ß√£o
    const idx = meds.findIndex(m => m.id === editId);
    if (idx > -1) {
      meds[idx].paciente = paciente;
      meds[idx].nome = nome;
      meds[idx].instrucao = instr;
      meds[idx].hora = hora;
    }
    document.getElementById('modalMed').removeAttribute('data-edit-id');
  } else {
    // Novo medicamento
    meds.push({
      id: uid(),
      paciente,
      nome,
      instrucao: instr,
      hora,
      foto: document.getElementById('medFotoPreview').src || '',
      criadoEm: new Date().toISOString()
    });
  }
  
  saveAll();
  refreshUI();
  document.getElementById('modalMed').classList.remove('open');
  
  if (narrarEnabled()) {
    speak('Medicamento salvo com sucesso.');
  }
  
  console.log('‚úÖ Medicamento salvo');
}

function salvarReceita() {
  console.log('üíæ Salvando receita...');
  
  const medico = document.getElementById('receitaMedico').value.trim();
  const paciente = document.getElementById('receitaPaciente').value.trim();
  const dataEmissao = document.getElementById('receitaDataEmissao').value;
  const dataValidade = document.getElementById('receitaDataValidade').value;
  
  if (!medico || !paciente || !dataEmissao || !dataValidade) {
    alert('Preencha os campos obrigat√≥rios: M√©dico, Paciente, Data de Emiss√£o e Data de Validade.');
    return;
  }
  
  const receitaData = {
    medico,
    paciente,
    medicamentos: document.getElementById('receitaMedicamentos').value.trim(),
    dataEmissao,
    dataValidade,
    observacoes: document.getElementById('receitaObservacoes').value.trim(),
    foto: document.getElementById('receitaFotoPreview').src || '',
    criadoEm: new Date().toISOString()
  };
  
  // Verificar se √© edi√ß√£o
  const editId = document.getElementById('modalReceita').getAttribute('data-edit-id');
  
  if (editId) {
    // Edi√ß√£o
    const idx = receitas.findIndex(r => r.id === editId);
    if (idx > -1) {
      receitas[idx] = { ...receitas[idx], ...receitaData };
    }
    document.getElementById('modalReceita').removeAttribute('data-edit-id');
  } else {
    // Nova receita
    receitas.push({
      id: uid(),
      ...receitaData
    });
  }
  
  localStorage.setItem(LS_RECEITAS, JSON.stringify(receitas));
  renderReceitas();
  scheduleReceitaAlerts();
  document.getElementById('modalReceita').classList.remove('open');
  
  if (narrarEnabled()) {
    speak('Receita salva com sucesso.');
  }
  
  console.log('‚úÖ Receita salva');
}

function salvarConsulta() {
  console.log('üíæ Salvando consulta...');
  
  const data = document.getElementById('consData').value;
  const prof = document.getElementById('consProf').value.trim();
  
  if (!data || !prof) {
    alert('Preencha a data e o profissional/local.');
    return;
  }
  
  const obs = document.getElementById('consObs').value.trim();
  
  // Verificar se √© edi√ß√£o
  const editId = document.getElementById('modalConsult').getAttribute('data-edit-id');
  
  if (editId) {
    // Edi√ß√£o
    const idx = consults.findIndex(c => c.id === editId);
    if (idx > -1) {
      consults[idx].data = data;
      consults[idx].prof = prof;
      consults[idx].obs = obs;
    }
    document.getElementById('modalConsult').removeAttribute('data-edit-id');
  } else {
    // Nova consulta
    consults.push({
      id: uid(),
      data,
      prof,
      obs,
      criadoEm: new Date().toISOString()
    });
  }
  
  saveAll();
  refreshUI();
  document.getElementById('modalConsult').classList.remove('open');
  
  if (narrarEnabled()) {
    speak('Consulta salva com sucesso.');
  }
  
  console.log('‚úÖ Consulta salva');
}

// ================= INICIALIZA√á√ÉO CORRIGIDA =================
document.addEventListener("DOMContentLoaded", () => {
  console.log('üöÄ DOM Carregado - Iniciando configura√ß√£o...');
  
  // Configurar event listeners primeiro
  setTimeout(() => {
    configurarEventListeners();
    debugBotoes();
  }, 100);
  
  // Inicializar sistemas
  initTutorial();
  initReceitas();
  setupAccessibilityControls();
  
  console.log('‚úÖ Aplica√ß√£o completamente inicializada');
});

// ================= DEBUG MELHORADO =================
function debugBotoes() {
  console.log('=== DEBUG COMPLETO DE BOT√ïES ===');
  
  const botoesTeste = [
    'btnAddMed', 'btnAddReceita', 'btnAddConsult', 
    'btnAlarm', 'btnVoiceFlow', 'btnExport', 'btnImport'
  ];
  
  botoesTeste.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      console.log(`üîò ${id}:`, {
        existe: true,
        onclick: typeof btn.onclick,
        display: getComputedStyle(btn).display,
        visibility: getComputedStyle(btn).visibility,
        pointerEvents: getComputedStyle(btn).pointerEvents
      });
      
      // Testar clique program√°tico
      btn.addEventListener('click', () => {
        console.log(`üéØ ${id} - CLIQUE DETECTADO VIA EVENT LISTENER`);
      });
    } else {
      console.log(`‚ùå ${id}: BOT√ÉO N√ÉO ENCONTRADO`);
    }
  });
}

// ================= BOT√ÉO DE TESTE R√ÅPIDO =================
// Adicione este bot√£o para teste r√°pido
const testBtn = document.createElement('button');
testBtn.textContent = 'üß™ Testar Formul√°rios';
testBtn.style.cssText = `
  position: fixed;
  top: 100px;
  left: 10px;
  z-index: 10000;
  padding: 8px 12px;
  background: #9c27b0;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 12px;
`;
testBtn.onclick = () => {
  console.log('üß™ TESTANDO TODOS OS FORMUL√ÅRIOS...');
  openMedModal();
  setTimeout(() => {
    document.getElementById('modalMed').classList.remove('open');
    openReceitaModal();
  }, 1000);
  setTimeout(() => {
    document.getElementById('modalReceita').classList.remove('open');
    openConsultModal();
  }, 2000);
  setTimeout(() => {
    document.getElementById('modalConsult').classList.remove('open');
    openNotifSettings();
  }, 3000);
};
document.body.appendChild(testBtn);

// ================= FUN√á√ïES SIMPLES PARA TESTE =================
function openMedModal() {
  console.log('Abrindo modal de medicamento...');
  document.getElementById('modalMed').classList.add('open');
}

function iniciarFluxoVoz() {
  console.log('Iniciando fluxo por voz...');
  if (narrarEnabled()) speak('Iniciando assistente por voz.');
}

function abrirConfigAlarme() {
  console.log('Abrindo configura√ß√µes de alarme...');
  document.getElementById('modalNotifSettings').classList.add('open');
}

function openReceitaModal() {
  console.log('Abrindo modal de receita...');
  document.getElementById('modalReceita').classList.add('open');
}

function openConsultModal() {
  console.log('Abrindo modal de consulta...');
  document.getElementById('modalConsult').classList.add('open');
}

function exportarDados() {
  console.log('Exportando dados...');
  // Implementa√ß√£o simples de export
  alert('Funcionalidade de exporta√ß√£o');
}

function importarDados() {
  console.log('Importando dados...');
  // Implementa√ß√£o simples de import
  alert('Funcionalidade de importa√ß√£o');
}

function limparHistorico() {
  console.log('Limpando hist√≥rico...');
  if (confirm('Tem certeza que deseja limpar o hist√≥rico?')) {
    hist = [];
    saveAll();
    refreshUI();
  }
}
// ================= FUN√á√ïES UTILIT√ÅRIAS =================
function uid(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

function esc(s){
  if(!s) return '';
  return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[c]);
}

function saveAll(){
  localStorage.setItem(LS_MED, JSON.stringify(meds));
  localStorage.setItem(LS_HIST, JSON.stringify(hist));
  localStorage.setItem(LS_CONS, JSON.stringify(consults));
  localStorage.setItem(LS_NOTIF_SETTINGS, JSON.stringify(notifSettings));
}

// ================= TUTORIAL E ACESSIBILIDADE =================


function increaseTextSize() {
  const currentSize = parseInt(getComputedStyle(document.body).fontSize) || 16;
  document.body.style.fontSize = (currentSize + 2) + 'px';
  localStorage.setItem('textSize', document.body.style.fontSize);
  if (narrarEnabled()) {
    speak('Texto aumentado');
  }
}

function decreaseTextSize() {
  const currentSize = parseInt(getComputedStyle(document.body).fontSize) || 16;
  document.body.style.fontSize = Math.max(14, currentSize - 2) + 'px';
  localStorage.setItem('textSize', document.body.style.fontSize);
  if (narrarEnabled()) {
    speak('Texto diminu√≠do');
  }
}

function readCurrentScreen() {
  if (!narrarEnabled()) return;
  const mainTitle = document.querySelector('header')?.textContent || '';
  const medCount = meds.length;
  const histCount = hist.length;
  const consCount = consults.length;
  speak(`${mainTitle}. Voc√™ tem ${medCount} medicamentos cadastrados, ${histCount} registros no hist√≥rico e ${consCount} consultas agendadas. Use os bot√µes no topo para navegar.`);
}

// ================= DEBUG DO TUTORIAL =================
function debugTutorial() {
  console.log('=== DEBUG TUTORIAL ===');
  console.log('Current Step:', currentStep);
  console.log('Total Steps:', totalSteps);
  
  const btnStart = document.getElementById('btnStartApp');
  const btnNext = document.getElementById('btnNextTutorial');
  const btnSkip = document.getElementById('btnSkipTutorial');
  
  console.log('Btn Start:', btnStart);
  console.log('Btn Start Display:', btnStart?.style.display);
  console.log('Btn Start Class:', btnStart?.className);
  console.log('Btn Next Display:', btnNext?.style.display);
  console.log('Btn Skip Display:', btnSkip?.style.display);
  console.log('====================');
}

// ================= TUTORIAL E TERMOS CORRIGIDOS =================
function initTutorial() {
  const tutorialCompleted = localStorage.getItem(LS_TUTORIAL) === 'true';
  const termsAccepted = localStorage.getItem(LS_TERMS) === '1';
  
  console.log('Iniciando app:', { tutorialCompleted, termsAccepted });
  
  if (!termsAccepted) {
    // Mostrar apenas termos primeiro
    document.getElementById('modalTerms').classList.add('open');
    if (narrarEnabled()) {
      speak('Por favor, leia e aceite os termos de uso para continuar.');
    }
  } else if (!tutorialCompleted) {
    // Termos aceitos, mas tutorial n√£o completado
    setTimeout(() => {
      showTutorial();
    }, 500);
  } else {
    // Tudo completo - mostrar apenas ajuda
    document.getElementById('btnHelp').style.display = 'block';
    // Inicializar a interface principal
    refreshUI();
  }
}

function showTutorial() {
  console.log('Abrindo tutorial...');
  
  // Fechar termos se estiver aberto
  document.getElementById('modalTerms').classList.remove('open');
  
  // Abrir tutorial
  document.getElementById('modalTutorial').classList.add('open');
  
  if (narrarEnabled()) {
    setTimeout(() => {
      speak('Bem-vindo ao Meu Rem√©dio! Vamos aprender a usar o aplicativo. Pressione pr√≥ximo para continuar.');
    }, 300);
  }
  
  updateTutorialStep(1);
}

// CORRE√á√ÉO: APENAS UMA FUN√á√ÉO updateTutorialStep
function updateTutorialStep(step) {
  console.log(`Mudando para passo: ${step}`);
  currentStep = step;
  
  // Esconder todos os passos
  document.querySelectorAll('.tutorial-step').forEach(el => {
    el.classList.add('hidden');
    el.classList.remove('active');
  });
  
  // Mostrar passo atual
  const currentStepEl = document.querySelector(`[data-step="${step}"]`);
  if (currentStepEl) {
    currentStepEl.classList.remove('hidden');
    currentStepEl.classList.add('active');
    console.log(`Passo ${step} ativado`);
  }
  
  // CORRE√á√ÉO COMPLETA: L√≥gica de exibi√ß√£o dos bot√µes
  const btnPrev = document.getElementById('btnPrevTutorial');
  const btnNext = document.getElementById('btnNextTutorial');
  const btnSkip = document.getElementById('btnSkipTutorial');
  const btnStart = document.getElementById('btnStartApp');
  
  if (btnPrev) btnPrev.disabled = step === 1;
  
  // VERIFICA√á√ÉO: √â o √∫ltimo passo?
  const isLastStep = step === totalSteps;
  console.log(`√â √∫ltimo passo? ${isLastStep}`);
  
  if (isLastStep) {
    // √öLTIMO PASSO: Mostrar apenas "Come√ßar a Usar"
    console.log('Mostrando bot√£o Come√ßar a Usar');
    if (btnNext) btnNext.style.display = 'none';
    if (btnSkip) btnSkip.style.display = 'none';
    if (btnStart) {
      btnStart.style.display = 'block';
      btnStart.classList.remove('hidden');
    }
  } else {
    // N√ÉO √© √∫ltimo passo: Mostrar "Pr√≥ximo" e "Pular"
    console.log('Mostrando bot√µes Pr√≥ximo e Pular');
    if (btnNext) btnNext.style.display = 'block';
    if (btnSkip) btnSkip.style.display = 'block';
    if (btnStart) btnStart.style.display = 'none';
  }
  
  // Debug para verificar estado atual
  debugTutorial();
  
  // Narra√ß√£o do passo
  if (narrarEnabled()) {
    readTutorialStep(step);
  }
}

function readTutorialStep(step) {
  const messages = {
    1: 'Passo 1 de 4: Narrador de voz. O aplicativo fala com voc√™! Toque nos bot√µes e escute as instru√ß√µes. Dica: deixe o narrador sempre ligado.',
    2: 'Passo 2 de 4: Comandos por voz. Use o bot√£o Preencher por voz para cadastrar rem√©dios falando. Toque em Experimente falar para testar.',
    3: 'Passo 3 de 4: Lembretes autom√°ticos. O aplicativo avisa na hora certa de tomar seus rem√©dios! Toque em Tomei quando tomar, receba lembretes no celular e consulte o hist√≥rico.',
    4: 'Passo 4 de 4: Bot√µes com s√≠mbolos. Use os s√≠mbolos para navegar. Pressione Come√ßar a Usar para iniciar o aplicativo.'
  };
  
  setTimeout(() => {
    speak(messages[step] || `Passo ${step} de ${totalSteps}`);
  }, 500);
}

function demoVoiceCommand() {
  if (narrarEnabled()) {
    speak('Experimente dizer: Paracetamol, para cadastrar um medicamento. Ou diga: Oito horas, para definir o hor√°rio.');
  }
}

function completeTutorial() {
  console.log('Completando tutorial...');
  
  const dontShowAgain = document.getElementById('dontShowAgain');
  if (dontShowAgain && dontShowAgain.checked) {
    localStorage.setItem(LS_TUTORIAL, 'true');
    console.log('Tutorial marcado para n√£o mostrar novamente');
  }
  
  // Fechar modal do tutorial
  document.getElementById('modalTutorial').classList.remove('open');
  
  // Mostrar bot√£o de ajuda
  document.getElementById('btnHelp').style.display = 'block';
  
  // Inicializar a interface principal
  refreshUI();
  
  if (narrarEnabled()) {
    speak('Tutorial conclu√≠do! Agora voc√™ pode usar o Meu Rem√©dio. Toque no bot√£o de ajuda no canto inferior direito se precisar de assist√™ncia.');
  }
  
  console.log('Tutorial finalizado, app pronto para uso');
}

// ================= INICIALIZA√á√ÉO CORRIGIDA =================
document.addEventListener("DOMContentLoaded", () => {
  console.log('=== INICIANDO APP ===');
  
  // Restaurar configura√ß√µes de acessibilidade
  const savedHighContrast = localStorage.getItem('highContrast') === 'true';
  const savedTextSize = localStorage.getItem('textSize');
  
  if (savedHighContrast) {
    document.body.classList.add('high-contrast');
  }
  
  if (savedTextSize) {
    document.body.style.fontSize = savedTextSize;
  }

  // Configurar bot√£o "Come√ßar a Usar" do tutorial
  const btnStart = document.getElementById("btnStartApp");
  
  if (btnStart) {
    btnStart.addEventListener("click", completeTutorial);
    console.log('Bot√£o Come√ßar a Usar configurado');
  }

  // Configurar bot√£o de aceitar termos
  const btnAcceptTerms = document.getElementById("btnAcceptTerms");
  
  if (btnAcceptTerms) {
    btnAcceptTerms.addEventListener("click", () => {
      console.log('Termos aceitos, indo para tutorial...');
      
      // Salvar aceita√ß√£o dos termos
      localStorage.setItem(LS_TERMS, "1");
      
      // Fechar modal de termos
      document.getElementById("modalTerms").classList.remove("open");
      
      // Feedback de voz
      if (narrarEnabled()) {
        speak('Termos aceitos com sucesso. Iniciando tutorial em instantes.');
      }
      
      // Aguardar um pouco e abrir tutorial
      setTimeout(() => {
        showTutorial();
      }, 800);
    });
  }

  // Configurar bot√£o de ler termos
  const btnReadTerms = document.getElementById("btnReadTerms");
  
  if (btnReadTerms) {
    btnReadTerms.addEventListener("click", () => {
      if (narrarEnabled()) {
        speak(`Termos de Uso do Meu Rem√©dio: 
          Ao utilizar este aplicativo, voc√™ concorda que todas as informa√ß√µes inseridas, 
          incluindo nomes, hor√°rios de medicamentos e fotos, ser√£o armazenadas apenas 
          no seu dispositivo. Nenhum dado pessoal √© enviado para servidores externos 
          sem seu consentimento expl√≠cito. 
          
          Este aplicativo √© um aux√≠lio para organiza√ß√£o de medicamentos e consultas 
          e n√£o substitui orienta√ß√£o m√©dica profissional. 
          
          Sempre consulte um m√©dico para quest√µes de sa√∫de.`);
      } else {
        alert("üìú Termos de Uso\n\nAo usar este app, voc√™ concorda que:\n‚Ä¢ Seus dados ficam apenas no seu dispositivo\n‚Ä¢ Nada √© enviado sem sua permiss√£o\n‚Ä¢ √â um aux√≠lio, n√£o substitui o m√©dico");
      }
    });
  }

  // Configurar navega√ß√£o do tutorial
  const btnNext = document.getElementById('btnNextTutorial');
  const btnPrev = document.getElementById('btnPrevTutorial');
  const btnSkip = document.getElementById('btnSkipTutorial');
  
  if (btnNext) {
    btnNext.addEventListener('click', () => {
      console.log('Bot√£o Pr√≥ximo clicado');
      if (currentStep < totalSteps) {
        updateTutorialStep(currentStep + 1);
      }
    });
  }
  
  if (btnPrev) {
    btnPrev.addEventListener('click', () => {
      console.log('Bot√£o Anterior clicado');
      if (currentStep > 1) {
        updateTutorialStep(currentStep - 1);
      }
    });
  }
  
  if (btnSkip) {
    btnSkip.addEventListener('click', () => {
      console.log('Bot√£o Pular clicado');
      completeTutorial();
    });
  }

  // Configurar bot√£o de ajuda
  const btnHelp = document.getElementById("btnHelp");
  if (btnHelp) {
    btnHelp.addEventListener("click", showQuickHelp);
  }
  
  // Inicializar tutorial e app
  initTutorial();
  
  // Configurar outros event listeners de acessibilidade
  setupAccessibilityControls();
  
  console.log('=== APP INICIALIZADO ===');
});

// ================= FUN√á√ÉO AUXILIAR PARA CONTROLES DE ACESSIBILIDADE =================
function setupAccessibilityControls() {
  // Atalhos de teclado para acessibilidade
  document.addEventListener('keydown', (e) => {
    // Ctrl + H = Ajuda
    if (e.ctrlKey && e.key === 'h') {
      e.preventDefault();
      showQuickHelp();
    }
    
    // Ctrl + M = Ler tela atual
    if (e.ctrlKey && e.key === 'm') {
      e.preventDefault();
      readCurrentScreen();
    }
    
    // Ctrl + + = Aumentar texto
    if (e.ctrlKey && e.key === '+') {
      e.preventDefault();
      increaseTextSize();
    }
    
    // Ctrl + - = Diminuir texto
    if (e.ctrlKey && e.key === '-') {
      e.preventDefault();
      decreaseTextSize();
    }
    
    // Ctrl + C = Alto contraste
    if (e.ctrlKey && e.key === 'c') {
      e.preventDefault();
      toggleHighContrast();
    }
  });

  // An√∫ncio de foco para leitores de tela
  document.addEventListener('focus', (e) => {
    if (narrarEnabled() && e.target.tagName === 'BUTTON') {
      const buttonText = e.target.textContent || e.target.getAttribute('aria-label') || '';
      if (buttonText && !buttonText.includes('‚ùì')) {
        setTimeout(() => speak(buttonText), 100);
      }
    }
  }, true);
}

// ================= FUN√á√ÉO MELHORADA DE AJUDA R√ÅPIDA =================
function showQuickHelp() {
  if (narrarEnabled()) {
    speak(`Ajuda r√°pida do Meu Rem√©dio:
      Use o bot√£o de microfone para cadastrar rem√©dios falando. 
      Toque em Tomei ao lado de cada rem√©dio quando tomar. 
      Use Alarme para lembrete sonoro.
      Controles de acessibilidade: 
      - A+ e A- para tamanho do texto
      - Alto Contraste para melhor visibilidade
      - Ler Tela para ouvir o resumo atual
      O narrador guia voc√™ em cada passo.`);
  } else {
    alert(`üìã AJUDA R√ÅPIDA - MEU REM√âDIO

üéôÔ∏è VOZ: Toque em "Preencher por voz" e fale os dados
‚úÖ TOMEI: Toque ao lado do rem√©dio quando tomar  
‚è∞ ALARME: Para lembrete sonoro
‚úèÔ∏è ADICIONAR: Para cadastrar manualmente

‚ôø ACESSIBILIDADE:
A+ = Aumentar texto
A- = Diminuir texto 
Alto Contraste = Melhor visibilidade
Ler Tela = Ouvir resumo

üí° DICA: Ative o NARRADOR para guia por voz!`);
  }
}

// ================= NARRA√á√ÉO E RECONHECIMENTO DE VOZ =================
function narrarEnabled(){
  return document.getElementById('toggleNarrador').checked;
}

function verboEnabled(){
  return document.getElementById('toggleVerboso').checked;
}

function speak(text){
  if(!narrarEnabled()) return;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'pt-BR';
    u.rate = 1;
    window.speechSynthesis.speak(u);
  }catch(e){
    console.warn('Erro s√≠ntese de voz:', e);
  }
}

let recognition = null;
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'pt-BR';
  recognition.continuous = false;
  recognition.interimResults = false;
}

async function safeVoice(prompt){
  if(!recognition){
    alert('Reconhecimento de voz n√£o suportado neste navegador.');
    return null;
  }
  
  if(narrarEnabled()) speak(prompt);
  
  await new Promise(r=>{
    let waited=0;
    const iv=setInterval(()=>{
      if(!window.speechSynthesis.speaking || waited>2500){
        clearInterval(iv);
        r();
      }
      waited+=200;
    },200);
  });
  
  return new Promise((resolve)=>{
    recognition.start();
    recognition.onresult = e => {
      const t = e.results[0][0].transcript.trim();
      if(narrarEnabled()) speak('Voc√™ disse: ' + t);
      recognition.onresult = null;
      recognition.onerror = null;
      resolve(t);
    };
    recognition.onerror = ev => {
      if(narrarEnabled()) speak('N√£o entendi.');
      recognition.onresult = null;
      recognition.onerror = null;
      resolve(null);
    };
  });
}

// ================= FUN√á√ïES DE DATA/HORA =================
function formatarDataHoraPTBR(date, includeTime = true) {
  const options = {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    ...(includeTime && {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    })
  };
  return new Intl.DateTimeFormat('pt-BR', options).format(date);
}

function formatarDataPTBR(dateString) {
  const date = new Date(dateString + 'T00:00:00');
  return formatarDataHoraPTBR(date, false);
}

function calcularProximaHora(horaStr, dias = 0) {
  const [hh, mm] = horaStr.split(':').map(n => parseInt(n, 10));
  const next = new Date();
  next.setHours(hh, mm, 0, 0);
  next.setDate(next.getDate() + dias);
  if (next <= new Date()) {
    next.setDate(next.getDate() + 1);
  }
  return next;
}

function parseHoraFromFala(texto) {
  const regex = /(\d{1,2})[:h\s]?\s?(\d{1,2})?/;
  const match = texto.match(regex);
  if (match) {
    let hora = parseInt(match[1], 10);
    let minuto = match[2] ? parseInt(match[2], 10) : 0;
    if (hora < 0 || hora > 23) hora = new Date().getHours();
    if (minuto < 0 || minuto > 59) minuto = 0;
    return `${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`;
  }
  return null;
}

// ================= SISTEMA DE NOTIFICA√á√ïES =================
async function ensureNotificationPermission(){
  if(!('Notification' in window)) {
    updateNotificationStatus('unsupported');
    return false;
  }
  
  if(Notification.permission === 'granted') {
    updateNotificationStatus('granted');
    return true;
  }
  
  try{
    const p = await Notification.requestPermission();
    const granted = p === 'granted';
    updateNotificationStatus(granted ? 'granted' : 'denied');
    return granted;
  }catch(e){
    updateNotificationStatus('denied');
    return false;
  }
}

function updateNotificationStatus(status){
  const elem = document.getElementById('notificationStatus');
  if(!elem) return;
  switch(status){
    case 'granted':
      elem.innerHTML = 'üîî Notifica√ß√µes Ativas';
      elem.className = 'status-online';
      break;
    case 'denied':
      elem.innerHTML = 'üîï Notifica√ß√µes Bloqueadas';
      elem.className = 'status-offline';
      break;
    case 'unsupported':
      elem.innerHTML = '‚ùå Notif. N√£o Suportadas';
      elem.className = 'status-offline';
      break;
    default:
      elem.innerHTML = 'üîï Notifica√ß√µes';
      elem.className = 'status-offline';
  }
}

// ... (adicione aqui as fun√ß√µes refreshUI() e outras fun√ß√µes de renderiza√ß√£o que faltam)


// ================= TESTE MANUAL (remover depois) =================
// Adicione este c√≥digo tempor√°rio para testar
function testTutorial() {
  console.log('=== TESTE MANUAL DO TUTORIAL ===');
  showTutorial();
  // Ir direto para o √∫ltimo passo para testar
  setTimeout(() => {
    updateTutorialStep(4);
  }, 1000);
}

// Bot√£o de teste tempor√°rio - remover na vers√£o final
const testButton = document.createElement('button');
testButton.textContent = 'üîß Testar Tutorial';
testButton.style.cssText = `
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10000;
  padding: 8px 12px;
  background: #ff9800;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 12px;
`;
testButton.onclick = testTutorial;
document.body.appendChild(testButton);
// ================= VARI√ÅVEIS PARA RECEITAS =================
const LS_RECEITAS = 'meu_remedio_receitas_v1';
let receitas = JSON.parse(localStorage.getItem(LS_RECEITAS) || '[]');

// ================= FUN√á√ïES PARA RECEITAS =================
function initReceitas() {
  renderReceitas();
  checkReceitasVencidas();
  scheduleReceitaAlerts();
}

function renderReceitas() {
  const tbody = document.querySelector('#tblReceitas tbody');
  tbody.innerHTML = '';
  
  document.getElementById('receitaCount').textContent = receitas.length;
  
  if (receitas.length === 0) {
    document.getElementById('emptyReceitas').style.display = 'block';
    document.getElementById('receitaAlerts').innerHTML = '';
    return;
  }
  
  document.getElementById('emptyReceitas').style.display = 'none';
  
  // Ordenar por data de validade (mais pr√≥ximas primeiro)
  receitas.sort((a, b) => new Date(a.dataValidade) - new Date(b.dataValidade));
  
  receitas.forEach(receita => {
    const tr = document.createElement('tr');
    const status = getReceitaStatus(receita);
    
    tr.innerHTML = `
      <td>
        ${receita.foto ? 
          `<img src="${receita.foto}" class="pill-img" alt="foto receita" onclick="ampliarFoto('${receita.foto}')" style="cursor: pointer;">` 
          : '‚Äî'
        }
      </td>
      <td>${esc(receita.paciente)}</td>
      <td>${esc(receita.medico)}</td>
      <td>${formatarDataPTBR(receita.dataEmissao)}</td>
      <td>${formatarDataPTBR(receita.dataValidade)}</td>
      <td>
        <span class="status-receita ${status.classe}">${status.texto}</span>
        ${status.dias ? `<br><small>${status.dias}</small>` : ''}
      </td>
      <td>
        <div class="actions">
          ${receita.foto ? `<button class="btn-small" data-id="${receita.id}" data-act="verFoto">üëÅÔ∏è Ver</button>` : ''}
          <button class="btn-ghost" data-id="${receita.id}" data-act="editarReceita">‚úèÔ∏è Editar</button>
          <button class="btn-ghost" data-id="${receita.id}" data-act="excluirReceita">üóëÔ∏è Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  updateReceitaAlerts();
}

function getReceitaStatus(receita) {
  const hoje = new Date();
  const validade = new Date(receita.dataValidade);
  const diffTime = validade - hoje;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return {
      texto: 'VENCIDA',
      classe: 'status-vencida',
      dias: `H√° ${Math.abs(diffDays)} dias`
    };
  } else if (diffDays <= 7) {
    return {
      texto: 'VENCE EM BREVE',
      classe: 'status-proximo',
      dias: `${diffDays} dias`
    };
  } else {
    return {
      texto: 'V√ÅLIDA',
      classe: 'status-valida',
      dias: `${diffDays} dias restantes`
    };
  }
}

function updateReceitaAlerts() {
  const alertsContainer = document.getElementById('receitaAlerts');
  const hoje = new Date();
  let alertas = [];
  
  receitas.forEach(receita => {
    const validade = new Date(receita.dataValidade);
    const diffTime = validade - hoje;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
      alertas.push({
        tipo: 'danger',
        mensagem: `‚ö†Ô∏è <strong>RECEITA VENCIDA:</strong> ${receita.paciente} - ${receita.medico} (Venceu h√° ${Math.abs(diffDays)} dias)`,
        receita: receita
      });
    } else if (diffDays <= 3) {
      alertas.push({
        tipo: 'warning', 
        mensagem: `üîî <strong>RECEITA VENCE EM BREVE:</strong> ${receita.paciente} - ${receita.medico} (Vence em ${diffDays} dias)`,
        receita: receita
      });
    } else if (diffDays <= 7) {
      alertas.push({
        tipo: 'info',
        mensagem: `üìÖ <strong>RECEITA PR√ìXIMA DO VENCIMENTO:</strong> ${receita.paciente} - ${receita.medico} (Vence em ${diffDays} dias)`,
        receita: receita
      });
    }
  });
  
  if (alertas.length === 0) {
    alertsContainer.innerHTML = '';
    return;
  }
  
  // Ordenar alertas: vencidas primeiro, depois por proximidade
  alertas.sort((a, b) => {
    const diasA = Math.ceil((new Date(a.receita.dataValidade) - hoje) / (1000 * 60 * 60 * 24));
    const diasB = Math.ceil((new Date(b.receita.dataValidade) - hoje) / (1000 * 60 * 60 * 24));
    return diasA - diasB;
  });
  
  let alertsHTML = '';
  alertas.forEach(alerta => {
    alertsHTML += `<div class="alert-${alerta.tipo}">${alerta.mensagem}</div>`;
  });
  
  alertsContainer.innerHTML = alertsHTML;
}

function checkReceitasVencidas() {
  const hoje = new Date().toISOString().split('T')[0];
  const receitasVencidas = receitas.filter(r => r.dataValidade < hoje);
  
  if (receitasVencidas.length > 0 && narrarEnabled()) {
    speak(`Aten√ß√£o: voc√™ tem ${receitasVencidas.length} receita(s) vencida(s). Verifique a lista de receitas.`);
  }
}

function scheduleReceitaAlerts() {
  // Limpar alertas antigos
  for (const [id, timer] of scheduledTimers.entries()) {
    if (id.startsWith('receita_')) {
      clearTimeout(timer);
      scheduledTimers.delete(id);
    }
  }
  
  receitas.forEach(receita => {
    const validade = new Date(receita.dataValidade);
    const alertDate = new Date(validade);
    alertDate.setDate(validade.getDate() - 7); // 7 dias antes
    
    if (alertDate > new Date()) {
      scheduleNotification(
        `receita_${receita.id}`,
        alertDate,
        'üìã Receita Vencendo em Breve',
        `${receita.paciente} - ${receita.medico}\nValidade: ${formatarDataPTBR(receita.dataValidade)}`,
        { type: 'receita', id: receita.id }
      );
    }
    
    // Alerta no dia do vencimento
    const diaVencimento = new Date(validade);
    diaVencimento.setHours(9, 0, 0, 0);
    
    if (diaVencimento > new Date()) {
      scheduleNotification(
        `receita_venc_${receita.id}`,
        diaVencimento,
        '‚ö†Ô∏è Receita Vencendo Hoje',
        `${receita.paciente} - ${receita.medico}\nValidade hoje!`,
        { type: 'receita_venc', id: receita.id }
      );
    }
  });
}

// ================= MODAL E GEST√ÉO DE RECEITAS =================
function openReceitaModal(editId = null) {
  const modal = document.getElementById('modalReceita');
  const form = modal.querySelector('form') || modal;
  
  if (editId) {
    const receita = receitas.find(r => r.id === editId);
    if (receita) {
      document.getElementById('receitaMedico').value = receita.medico;
      document.getElementById('receitaPaciente').value = receita.paciente;
      document.getElementById('receitaMedicamentos').value = receita.medicamentos || '';
      document.getElementById('receitaDataEmissao').value = receita.dataEmissao;
      document.getElementById('receitaDataValidade').value = receita.dataValidade;
      document.getElementById('receitaObservacoes').value = receita.observacoes || '';
      
      if (receita.foto) {
        document.getElementById('receitaFotoPreview').src = receita.foto;
        document.getElementById('receitaFotoPreview').classList.remove('hidden');
        document.getElementById('btnRemoverFotoReceita').classList.remove('hidden');
      }
    }
  } else {
    // Limpar formul√°rio
    form.reset();
    document.getElementById('receitaFotoPreview').src = '';
    document.getElementById('receitaFotoPreview').classList.add('hidden');
    document.getElementById('btnRemoverFotoReceita').classList.add('hidden');
  }
  
  modal.classList.add('open');
  if (narrarEnabled()) speak('Abrindo formul√°rio de receita m√©dica.');
}

function saveReceita() {
  const medico = document.getElementById('receitaMedico').value.trim();
  const paciente = document.getElementById('receitaPaciente').value.trim();
  const dataEmissao = document.getElementById('receitaDataEmissao').value;
  const dataValidade = document.getElementById('receitaDataValidade').value;
  
  if (!medico || !paciente || !dataEmissao || !dataValidade) {
    alert('Preencha os campos obrigat√≥rios: M√©dico, Paciente, Data de Emiss√£o e Data de Validade.');
    return;
  }
  
  if (new Date(dataValidade) < new Date(dataEmissao)) {
    alert('A data de validade n√£o pode ser anterior √† data de emiss√£o.');
    return;
  }
  
  const receitaData = {
    medico,
    paciente,
    medicamentos: document.getElementById('receitaMedicamentos').value.trim(),
    dataEmissao,
    dataValidade,
    observacoes: document.getElementById('receitaObservacoes').value.trim(),
    foto: document.getElementById('receitaFotoPreview').src || '',
    criadoEm: new Date().toISOString()
  };
  
  // Processar foto se houver
  const fotoInput = document.getElementById('receitaFotoInput');
  if (fotoInput.files && fotoInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      receitaData.foto = e.target.result;
      commitSaveReceita(receitaData);
    };
    reader.readAsDataURL(fotoInput.files[0]);
  } else {
    commitSaveReceita(receitaData);
  }
}

function commitSaveReceita(receitaData) {
  const editId = document.getElementById('modalReceita').getAttribute('data-edit-id');
  
  if (editId) {
    const index = receitas.findIndex(r => r.id === editId);
    if (index > -1) {
      receitas[index] = { ...receitas[index], ...receitaData };
    }
    document.getElementById('modalReceita').removeAttribute('data-edit-id');
  } else {
    receitas.push({
      id: uid(),
      ...receitaData
    });
  }
  
  localStorage.setItem(LS_RECEITAS, JSON.stringify(receitas));
  renderReceitas();
  scheduleReceitaAlerts();
  document.getElementById('modalReceita').classList.remove('open');
  
  if (narrarEnabled()) {
    speak('Receita salva com sucesso. Lembretes configurados.');
  }
}

function ampliarFoto(src) {
  const overlay = document.createElement('div');
  overlay.className = 'receita-modal-overlay open';
  overlay.innerHTML = `
    <img src="${src}" class="receita-modal-img" alt="Receita ampliada">
    <button onclick="this.parentElement.remove()" style="
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
    ">‚úï</button>
  `;
  document.body.appendChild(overlay);
  
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.remove();
  });
}

// ================= INICIALIZA√á√ÉO - Atualize o DOMContentLoaded =================
// Adicione isso no seu DOMContentLoaded existente:
document.addEventListener('DOMContentLoaded', () => {
  // ... c√≥digo existente ...
  
  // ================= RECEITAS - EVENT LISTENERS =================
  document.getElementById('btnAddReceita').addEventListener('click', () => openReceitaModal());
  document.getElementById('btnCancelReceita').addEventListener('click', () => {
    document.getElementById('modalReceita').classList.remove('open');
  });
  document.getElementById('btnSaveReceita').addEventListener('click', saveReceita);
  
  // Preview da foto da receita
  document.getElementById('receitaFotoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        document.getElementById('receitaFotoPreview').src = ev.target.result;
        document.getElementById('receitaFotoPreview').classList.remove('hidden');
        document.getElementById('btnRemoverFotoReceita').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });
  
  document.getElementById('btnRemoverFotoReceita').addEventListener('click', function() {
    document.getElementById('receitaFotoInput').value = '';
    document.getElementById('receitaFotoPreview').src = '';
    document.getElementById('receitaFotoPreview').classList.add('hidden');
    this.classList.add('hidden');
  });
  
  // Delegation para a√ß√µes das receitas
  document.getElementById('tblReceitas').addEventListener('click', function(e) {
    const btn = e.target.closest('button');
    if (!btn) return;
    
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const receita = receitas.find(r => r.id === id);
    if (!receita) return;
    
    if (act === 'verFoto') {
      ampliarFoto(receita.foto);
    } else if (act === 'editarReceita') {
      document.getElementById('modalReceita').setAttribute('data-edit-id', id);
      openReceitaModal(id);
    } else if (act === 'excluirReceita') {
      if (confirm('Excluir esta receita?')) {
        receitas = receitas.filter(r => r.id !== id);
        localStorage.setItem(LS_RECEITAS, JSON.stringify(receitas));
        renderReceitas();
        scheduleReceitaAlerts();
        if (narrarEnabled()) speak('Receita exclu√≠da.');
      }
    }
  });
  
  // Inicializar receitas
  initReceitas();
});
</script>

</body>
</html>
