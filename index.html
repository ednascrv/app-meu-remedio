<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meu Rem√©dio Avan√ßado - Acess√≠vel</title>
<link rel="manifest" href="manifest.json" />
<style>
:root{
  --blue1:#4fc3f7;
  --blue2:#0288d1;
  --accent:#01579b;
  --bg:#ffffff;
  --card-shadow:0 6px 18px rgba(1,25,60,0.08);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Arial",sans-serif;
  background:var(--bg); color:var(--accent);
  -webkit-font-smoothing:antialiased;
}
header{
  background:linear-gradient(90deg,var(--blue1), var(--blue2));
  color:white; padding:24px 16px; text-align:center;
  font-size:24px; font-weight:700;
  border-bottom-left-radius:18px;border-bottom-right-radius:18px;
}
.app{padding:16px;padding-bottom:100px;max-width:720px;margin:0 auto;}
.add-buttons{display:flex;flex-direction:column;gap:14px;margin-bottom:16px;}
.btn-primary{
  width:100%; display:flex; align-items:center; justify-content:center;
  gap:12px; padding:22px; font-size:22px; font-weight:700;
  border-radius:18px; border:none; color:white;
  background:linear-gradient(90deg,var(--blue1),var(--blue2));
  box-shadow: var(--card-shadow); cursor:pointer;
}
.btn-primary:focus{outline:3px solid #01579b;}
.btn-small{
  padding:12px 16px; border-radius:14px; border:none;
  background:linear-gradient(90deg,var(--blue1),var(--blue2));
  color:white; font-weight:700; cursor:pointer;
}
.row{display:flex; gap:12px; align-items:center;}
.card{
  background:#f8fafc; border-radius:16px; padding:16px;
  box-shadow: var(--card-shadow); margin-top:16px;
}
.block{display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:16px; border-radius:16px;
  background:linear-gradient(180deg,#fff,#f2fbff);
  box-shadow:0 3px 10px rgba(2,136,209,0.06);
}
.block .left{display:flex; gap:12px; align-items:center;}
.pill-img{width:84px;height:84px;border-radius:12px;object-fit:cover;border:3px solid rgba(2,136,209,0.12); background:#fff}
h2.title{margin:0;font-size:20px;}
p.time{margin:0;font-size:28px;font-weight:800;color:var(--accent);}
.actions{display:flex; gap:8px;}
.btn-took{padding:14px 20px;border-radius:28px;border:none;font-weight:800;color:white;}
.green{background:linear-gradient(90deg,#66bb6a,#2e7d32);}
.red{background:linear-gradient(90deg,#ef5350,#c62828);}
.ghost{background:transparent;border:2px solid rgba(1,87,155,0.12); color:var(--accent);}
table{width:100%;border-collapse:collapse;margin-top:16px;font-size:18px;}
th,td{padding:10px;border-bottom:1px solid #e6f0f7;text-align:left;}
th{color:#012b48;font-weight:700;}
footer{
  position:fixed; left:0; right:0; bottom:0; height:72px;
  background: linear-gradient(90deg,var(--blue1), var(--blue2));
  display:flex; align-items:center; justify-content:center; color:white;
  font-weight:700; border-top-left-radius:14px;border-top-right-radius:14px;
  font-size:18px;
}
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:9999;}
.modal.open{display:flex;}
.modal-content{width:94%; max-width:540px; background:white; border-radius:14px; padding:20px;}
.form-row{margin-bottom:12px}
label{display:block; font-size:16px; margin-bottom:6px}
input[type="text"], input[type="time"], textarea, select, input[type="file"]{
  width:100%; padding:12px; border-radius:10px; border:1px solid #d8eefb; font-size:16px;
}
.small{font-size:14px;color:#666;margin-top:6px}
.history-list{max-height:300px; overflow:auto; padding:6px}
.history-item{padding:12px;border-radius:10px;background:#f6fdff;margin-bottom:10px;font-size:16px}
.flex-space{display:flex; justify-content:space-between; align-items:center}
@media(min-width:680px){ .app{padding:28px} }
#ariaStatus{position:absolute; left:-9999px; top:auto;}
#fullAlert{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:36px;font-weight:700;color:#01579b;display:none;z-index:99999;text-align:center;}
</style>
</head>
<body>
<header>üíä Meu Rem√©dio Avan√ßado</header>
<div class="app">

  <!-- BOT√ïES DE ADI√á√ÉO -->
  <div class="add-buttons">
    <button id="btnManual" class="btn-primary" aria-label="Adicionar medicamento manualmente">‚ûï Adicionar manualmente</button>
    <button id="btnAdd" class="btn-primary" aria-label="Adicionar medicamento via foto da receita">üì∏ Adicionar via foto (OCR)</button>
    <button id="btnVoz" class="btn-primary" aria-label="Adicionar medicamento por comando de voz">üéôÔ∏è Comando de voz</button>
    <input id="inpFotoOCR" type="file" accept="image/*" capture="environment" style="display:none;">
  </div>

  <div id="blocosContainer" aria-live="polite"></div>

  <!-- Lista de medicamentos -->
  <div class="card">
    <div class="flex-space">
      <h2 style="margin:0">Lista de medicamentos</h2>
      <div>
        <button id="btnExport" class="btn-small">Exportar JSON</button>
        <button id="btnImport" class="btn-small">Importar JSON</button>
      </div>
    </div>
    <table id="tblRemedios" aria-label="Lista de medicamentos">
      <thead>
        <tr><th scope="col">Foto</th><th scope="col">Paciente</th><th scope="col">Nome</th><th scope="col">Hor√°rios</th><th scope="col">A√ß√µes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Hist√≥rico -->
  <div class="card" style="margin-top:16px">
    <div class="flex-space">
      <h2 style="margin:0">Hist√≥rico</h2>
      <button id="btnLimparHistorico" class="btn-small ghost">Limpar</button>
    </div>
    <div id="historyList" class="history-list" aria-live="polite"></div>
  </div>
</div>

<footer>üíô Meu Rem√©dio</footer>
<div id="ariaStatus" aria-live="polite"></div>
<div id="fullAlert"></div>

<!-- MODAL -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <h3 id="modalTitle">Adicionar rem√©dio</h3>
    <div class="form-row">
      <label>Nome do paciente</label>
      <input id="inpPaciente" type="text">
    </div>
    <div class="form-row">
      <label>Nome do rem√©dio</label>
      <input id="inpNome" type="text">
    </div>
    <div class="form-row">
      <label>Instru√ß√µes</label>
      <textarea id="inpReceita" rows="2"></textarea>
    </div>
    <div class="form-row">
      <label>Hor√°rios (HH:MM, separados por v√≠rgula)</label>
      <input id="inpHorario" type="text" placeholder="08:00,13:00,21:00">
    </div>
    <div class="form-row">
      <label>Foto do rem√©dio</label>
      <input id="inpFoto" type="file" accept="image/*" capture="environment">
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
      <button id="btnCancel" class="btn-small ghost">Cancelar</button>
      <button id="btnSave" class="btn-small" style="background:linear-gradient(90deg,var(--blue1),var(--blue2)); color:white">Salvar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>
<script>
// ================= ARMAZENAMENTO ==================
const LS_KEY='meu_remedio_avancado', LS_HIST='meu_remedio_hist_avancado';
let remedios=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
let historico=JSON.parse(localStorage.getItem(LS_HIST)||'[]');
let scheduledIntervals=[];

// ================= ELEMENTOS ==================
const blocosContainer=document.getElementById('blocosContainer');
const tblBody=document.querySelector('#tblRemedios tbody');
const historyList=document.getElementById('historyList');
const ariaStatus=document.getElementById('ariaStatus');
const modal=document.getElementById('modal');
const inpPaciente=document.getElementById('inpPaciente');
const inpNome=document.getElementById('inpNome');
const inpReceita=document.getElementById('inpReceita');
const inpHorario=document.getElementById('inpHorario');
const inpFoto=document.getElementById('inpFoto');
const inpFotoOCR=document.getElementById('inpFotoOCR');
const fullAlert=document.getElementById('fullAlert');
let editingId=null;

// ================= UTILIDADES ==================
function salvarTudo(){ localStorage.setItem(LS_KEY,JSON.stringify(remedios)); localStorage.setItem(LS_HIST,JSON.stringify(historico)); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function announce(text){ ariaStatus.textContent=text; }
function speak(text){ if(!text) return; if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(text); u.lang='pt-BR'; speechSynthesis.speak(u); } }
function showNotification(title,opts){ if("Notification" in window){ if(Notification.permission==="granted"){ new Notification(title,opts); } else Notification.requestPermission(); } }
function nowBrasilia(){ const now=new Date(); const utc=now.getTime()+now.getTimezoneOffset()*60000; return new Date(utc+(-3*3600000)); }
function defaultImgFor(r){ const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect rx='20' width='100%' height='100%' fill='#e1f5fe'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='24' fill='#0288d1'>${(r.nome||'Rem').slice(0,6)}</text></svg>`; return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg); }
function sugestaoInstrucao(nome){ return `Tomar ${nome} com √°gua, ap√≥s as refei√ß√µes.`; }

// ================= MODAL ==================
document.getElementById('btnCancel').addEventListener('click',()=>modal.classList.remove('open'));
document.getElementById('btnSave').addEventListener('click',saveModal);

function openModal(id=null){
  editingId=id; modal.classList.add('open'); document.getElementById('modalTitle').textContent=id?'Editar rem√©dio':'Adicionar rem√©dio';
  setTimeout(()=> inpPaciente.focus(),100);
  if(id){
    const r=remedios.find(x=>x.id===id);
    inpPaciente.value=r.paciente||''; inpNome.value=r.nome; inpReceita.value=r.instrucao||''; inpHorario.value=r.horarios.join(','); inpFoto.value='';
  } else{ inpPaciente.value=''; inpNome.value=''; inpReceita.value=''; inpHorario.value='08:00,21:00'; inpFoto.value=''; }
}

function saveModal(){
  const paciente=inpPaciente.value.trim()||'Paciente';
  const nome=inpNome.value.trim()||('Rem√©dio '+(remedios.length+1));
  const instr=inpReceita.value.trim()||sugestaoInstrucao(nome);
  const horarios=inpHorario.value.match(/\d{2}:\d{2}/g);
  if(!horarios || horarios.length===0){ alert('Insira ao menos um hor√°rio HH:MM'); return; }
  const file=inpFoto.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=()=>{ persistRemedio({paciente,nome,instr,horarios,foto:reader.result}); modal.classList.remove('open'); announce(`${nome} adicionado/atualizado`); speak(`${nome} adicionado.`); };
    reader.readAsDataURL(file);
  } else{ persistRemedio({paciente,nome,instr,horarios,foto:null}); modal.classList.remove('open'); announce(`${nome} adicionado/atualizado`); speak(`${nome} adicionado.`); }
}

function persistRemedio(data){
  if(editingId){
    const i=remedios.findIndex(r=>r.id===editingId);
    if(i>=0){ remedios[i]=Object.assign(remedios[i],data); }
  } else{ remedios.push(Object.assign({id:uid(),criadoEm:Date.now()},data)); }
  salvarTudo(); render();
}

// ================= RENDER ==================
function render(){
  scheduledIntervals.forEach(t=>clearInterval(t)); scheduledIntervals=[];
  blocosContainer.innerHTML=''; tblBody.innerHTML='';
  remedios.forEach(r=>{
    const block=document.createElement('div'); block.className='block'; block.setAttribute('role','region'); block.setAttribute('aria-labelledby','remedio-'+r.id); block.style.marginTop='12px';
    const left=document.createElement('div'); left.className='left';
    const img=document.createElement('img'); img.className='pill-img'; img.src=r.foto||defaultImgFor(r); img.alt=r.nome;
    const info=document.createElement('div');
    const ttitle=document.createElement('h2'); ttitle.className='title'; ttitle.id='remedio-'+r.id; ttitle.textContent=r.nome;
    const tpaciente=document.createElement('div'); tpaciente.className='small'; tpaciente.textContent=r.paciente||'';
    const tinstr=document.createElement('div'); tinstr.className='small'; tinstr.textContent=r.instrucao||'';
    const th=document.createElement('p'); th.className='time'; th.textContent=r.horarios.join(', ');
    info.append(ttitle,tpaciente,tinstr,th); left.appendChild(img); left.appendChild(info);
    const actions=document.createElement('div'); actions.className='actions';
    const btnHear=document.createElement('button'); btnHear.className='btn-small'; btnHear.textContent='üîä'; btnHear.onclick=()=>speak(`${r.paciente||'Paciente'} tomar ${r.nome} agora.`);
    const btnEdit=document.createElement('button'); btnEdit.className='btn-small ghost'; btnEdit.textContent='Editar'; btnEdit.onclick=()=>openModal(r.id);
    const btnTook=document.createElement('button'); btnTook.className='btn-took green'; btnTook.textContent='Eu tomei'; btnTook.onclick=()=>marcarTomado(r.id);
    const btnDel=document.createElement('button'); btnDel.className='btn-small'; btnDel.textContent='Excluir'; btnDel.onclick=()=>{ if(confirm('Excluir este rem√©dio?')) excluirRemedio(r.id); };
    actions.append(btnHear,btnEdit,btnTook,btnDel); block.appendChild(left); block.appendChild(actions);
    const wrapper=document.createElement('div'); wrapper.className='card'; wrapper.appendChild(block);
    blocosContainer.appendChild(wrapper);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="width:64px"><img src="${r.foto||defaultImgFor(r)}" style="width:64px;height:64px;border-radius:8px;object-fit:cover" alt="${r.nome}"></td>
                  <td>${r.paciente||''}</td><td>${r.nome}</td><td>${r.horarios.join(', ')}</td>
                  <td><button class="btn-small" onclick="openModal('${r.id}')">Editar</button>
                      <button class="btn-small" onclick="marcarTomado('${r.id}')">Eu tomei</button></td>`;
    tblBody.appendChild(tr);
    scheduleRemedio(r);
  });
  renderHistory();
}

function renderHistory(){
  historyList.innerHTML='';
  if(historico.length===0) historyList.innerHTML='<div class="small">Sem hist√≥rico ainda.</div>';
  historico.forEach(h=>{
    const div=document.createElement('div'); div.className='history-item';
    div.innerHTML=`<div style="font-weight:700">${h.nome} (${h.paciente||''})</div><div class="small">${new Date(h.horario).toLocaleString()}</div>`;
    historyList.appendChild(div);
  });
}

// ================= A√á√ïES ==================
function excluirRemedio(id){ const r=remedios.find(x=>x.id===id); remedios=remedios.filter(r=>r.id!==id); salvarTudo(); render(); announce(r.nome+' exclu√≠do'); speak(`${r.nome} exclu√≠do.`); }
function marcarTomado(id){ const r=remedios.find(x=>x.id===id); if(!r) return; const entry={id:uid(),remedioId:r.id,nome:r.nome,paciente:r.paciente,horario:new Date().toISOString(),instrucao:r.instrucao||''}; historico.unshift(entry); salvarTudo(); render(); announce(`Rem√©dio ${r.nome} marcado como tomado.`); speak(`Rem√©dio ${r.nome} marcado como tomado.`); }

document.getElementById('btnLimparHistorico').addEventListener('click',()=>{ if(confirm('Limpar todo hist√≥rico?')){ historico=[]; salvarTudo(); render(); announce('Hist√≥rico limpo'); speak('Hist√≥rico limpo'); } });

// ================= OCR ==================
document.getElementById('btnManual').addEventListener('click', () => { openModal(); speak("Abrindo formul√°rio para adicionar medicamento manualmente."); });
document.getElementById('btnAdd').addEventListener('click', () => { inpFotoOCR.click(); speak("Abra a c√¢mera ou selecione a foto da receita."); });
inpFotoOCR.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    Tesseract.recognize(reader.result, 'por').then(({ data: { text } }) => {
      const linhas = text.split('\n').filter(l => l.trim());
      const paciente = linhas[0] || 'Paciente';
      const nome = linhas[1] || 'Rem√©dio';
      const instrucao = linhas.slice(2).join('\n');
      const horarios = (text.match(/\d{2}:\d{2}/g) || []).join(',');
      openModal();
      inpPaciente.value = paciente;
      inpNome.value = nome;
      inpReceita.value = instrucao;
      inpHorario.value = horarios || '08:00,21:00';
      speak(`Medicamento ${nome} reconhecido. Verifique e edite se necess√°rio.`);
    });
  };
  reader.readAsDataURL(file);
});

// ================= COMANDO DE VOZ ==================
document.getElementById('btnVoz').addEventListener('click', () => {
  if(!('webkitSpeechRecognition' in window)) return alert('Seu navegador n√£o suporta reconhecimento de voz.');
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'pt-BR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.onstart = () => speak("Fale o nome do paciente, nome do medicamento e hor√°rios separados por espa√ßo.");
  recognition.onresult = e => {
    const texto = e.results[0][0].transcript.trim();
    const parts = texto.split(/\s+/);
    if(parts.length >= 3){
      openModal();
      inpPaciente.value = parts[0];
      inpNome.value = parts[1];
      inpHorario.value = parts.slice(2).join(',');
      speak(`Abrindo formul√°rio para ${parts[1]}. Verifique e salve o medicamento.`);
    } else {
      alert('Diga: NomePaciente NomeMedicamento HH:MM [HH:MM ...]');
    }
  };
  recognition.start();
});

// ================= ALERTA TELA CHEIA ==================
function showFullAlert(msg){
  fullAlert.textContent=msg; fullAlert.style.display='flex';
  speak(msg);
  setTimeout(()=>fullAlert.style.display='none',60000);
}

// ================= AGENDAMENTO ==================
function scheduleRemedio(r){
  r.horarios.forEach(hhmm=>{
    const [hh,mm]=hhmm.split(':').map(n=>parseInt(n,10));
    const t=setInterval(()=>{
      const now=nowBrasilia();
      if(now.getHours()===hh && now.getMinutes()===mm){
        const msg=`${r.paciente||'Paciente'} tomar ${r.nome} √†s ${hhmm} horas.`;
        announce(msg); showNotification('Hora do rem√©dio',{body:msg}); showFullAlert(msg);
      }
    },30000);
    scheduledIntervals.push(t);
  });
}

render();
</script>
</body>
</html>
