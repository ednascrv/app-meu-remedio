<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Meu Rem√©dio</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00796b">
<link rel="icon" href="icon-192.png" sizes="192x192">
<style>
:root{
  --blue1:#005580; --green1:#388e3c; --accent:#00695c; --bg:#ffffff; --card-shadow:0 6px 18px rgba(0,0,0,0.12);
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased;}
header{background:linear-gradient(90deg,var(--blue1), var(--green1));color:white;padding:22px 16px;text-align:center;font-size:22px;font-weight:700;border-bottom-left-radius:18px;border-bottom-right-radius:18px;}
.app{padding:16px;padding-bottom:90px;max-width:720px;margin:0 auto;}
.btn-primary{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:18px;font-size:20px;font-weight:700;border-radius:16px;border:none;color:white;background:linear-gradient(90deg,var(--blue1),var(--green1));box-shadow: var(--card-shadow);cursor:pointer;margin-bottom:8px;}
.btn-small{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--blue1),var(--green1));color:white;font-weight:700;cursor:pointer;}
.row{display:flex; gap:12px; align-items:center;}
.card{background:#f8fafc; border-radius:16px; padding:14px; box-shadow: var(--card-shadow); margin-top:14px;}
.block{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px; border-radius:14px; background:linear-gradient(180deg,#fff,#f2fbff); box-shadow:0 3px 10px rgba(2,136,209,0.06);}
.block .left{display:flex; gap:12px; align-items:center;}
.pill-img{width:84px;height:84px;border-radius:12px;object-fit:cover;border:3px solid rgba(2,136,209,0.12); background:#fff}
h2.title{margin:0;font-size:20px;}
p.time{margin:0;font-size:28px;font-weight:800;color:var(--accent);}
.actions{display:flex; gap:8px;}
.btn-took{padding:12px 18px;border-radius:28px;border:none;font-weight:800;color:white;}
.green{background:linear-gradient(90deg,#81c784,#388e3c);}
.red{background:linear-gradient(90deg,#ef5350,#c62828);}
.ghost{background:transparent;border:2px solid rgba(0,105,92,0.3); color:var(--accent)}
table{width:100%;border-collapse:collapse;margin-top:14px;font-size:16px}
th,td{padding:8px;border-bottom:1px solid #e6f0f7;text-align:left}
th{color:#012b48;font-weight:700}
footer{position:fixed; left:0; right:0; bottom:0; height:68px; background: linear-gradient(90deg,var(--blue1), var(--green1)); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; border-top-left-radius:14px;border-top-right-radius:14px;}
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:9999;}
.modal.open{display:flex;}
.modal-content{width:94%; max-width:540px; background:white; border-radius:12px; padding:16px;}
.form-row{margin-bottom:10px}
label{display:block; font-size:14px; margin-bottom:6px}
input[type="text"], input[type="time"], textarea, select, input[type="file"], input[type="number"]{width:100%; padding:10px; border-radius:8px; border:1px solid #d8eefb;}
.small{font-size:13px;color:#666;margin-top:6px}
.history-list{max-height:260px; overflow:auto; padding:6px}
.history-item{padding:10px;border-radius:8px;background:#f6fdff;margin-bottom:8px;font-size:14px}
.flex-space{display:flex; justify-content:space-between; align-items:center}
@media(min-width:680px){ .app{padding:28px} }
#ariaStatus{position:absolute; left:-9999px; top:auto;}
#fullAlert{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:36px;font-weight:700;color:#01579b;display:none;z-index:99999;text-align:center;}
</style>
</head>
<body>
<header>üíä Meu Rem√©dio</header>
<div class="app">
  <button id="btnManual" class="btn-primary">‚úèÔ∏è Adicionar medicamento manualmente</button>
  <button id="btnAdd" class="btn-primary">üì∏ Adicionar receita (OCR)</button>
  <button id="btnVoz" class="btn-primary">üéôÔ∏è Comando de voz</button>
  <button id="btnAlarm" class="btn-primary">‚è∞ Abrir alarme do dispositivo</button>
  <input id="inpFotoOCR" type="file" accept="image/*" capture="environment" style="display:none;">

  <div id="modalForm" class="modal">
    <div class="modal-content">
      <h2>Adicionar Medicamento</h2>
      <div class="form-row"><label>Nome do Paciente</label><input type="text" id="inputPaciente"></div>
      <div class="form-row"><label>Nome do Medicamento</label><input type="text" id="inputNome"></div>
      <div class="form-row"><label>Instru√ß√£o</label><input type="text" id="inputInstrucao" placeholder="Ex: a cada 8 horas"></div>
      <div class="form-row"><label>Hora Inicial</label><input type="time" id="inputHora"></div>
      <div class="form-row"><label>Foto do Medicamento</label><input type="file" id="inputFoto" accept="image/*"></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px;">
        <button id="btnCancelar" class="btn-small ghost">Cancelar</button>
        <button id="btnSalvar" class="btn-small">Salvar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="flex-space">
      <h2>Lista de medicamentos</h2>
      <div>
        <button id="btnExport" class="btn-small">Exportar JSON</button>
        <button id="btnImport" class="btn-small">Importar JSON</button>
      </div>
    </div>
    <table id="tblRemedios" aria-label="Lista de medicamentos">
      <thead><tr><th>Foto</th><th>Paciente</th><th>Nome</th><th>Hor√°rios</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="flex-space">
      <h2>Hist√≥rico</h2>
      <button id="btnLimparHistorico" class="btn-small ghost">Limpar</button>
    </div>
    <div id="historyList" class="history-list"></div>
  </div>
</div>

<footer>üíô Meu Rem√©dio</footer>
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>
<script type="module">
import { LocalNotifications } from '@capacitor/local-notifications';
const LS_KEY='meu_remedio', LS_HIST='meu_remedio_hist_avancado';
let remedios=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
let historico=JSON.parse(localStorage.getItem(LS_HIST)||'[]');

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function salvarTudo(){ localStorage.setItem(LS_KEY,JSON.stringify(remedios)); localStorage.setItem(LS_HIST,JSON.stringify(historico)); renderTabela(); renderHistorico(); }
function speak(text){ if(!text) return; if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(text); u.lang='pt-BR'; speechSynthesis.speak(u); } }
function playAlertSound(){ document.getElementById('alertSound').currentTime=0; document.getElementById('alertSound').play().catch(()=>{}); }
function nowBrasilia(){ const now=new Date(); const utc=now.getTime()+now.getTimezoneOffset()*60000; return new Date(utc+(-3*3600000)); }

function gerarHorariosAutomaticos(instrucao,horaInicial="08:00",maxQtd=24){
  const regex=/a cada (\d{1,2}) horas?/i;
  const match=instrucao.match(regex);
  const intervalo = match ? parseInt(match[1]) : null;
  if(!intervalo) return [];
  const [hh,mm]=horaInicial.split(':').map(Number);
  let horarios=[]; let current=new Date(); current.setHours(hh,mm,0,0);
  for(let i=0;i<maxQtd;i++){ horarios.push(current.toTimeString().slice(0,5)); current.setHours(current.getHours()+intervalo); if(current.getDate()!==new Date().getDate()) break;}
  return horarios;
}

async function agendarRemedio(remedio){
  let horarios = remedio.horarios.length>0 ? remedio.horarios : gerarHorariosAutomaticos(remedio.instrucao, remedio.horaInicial||"08:00");
  horarios.forEach(hhmm=>{
    const [hh,mm]=hhmm.split(':').map(Number);
    let proximo = nowBrasilia(); proximo.setHours(hh,mm,0,0);
    if(proximo<=nowBrasilia()) proximo.setDate(proximo.getDate()+1);
    const delay = proximo - nowBrasilia();
    setTimeout(async ()=>{
      const msg=`${remedio.paciente||'Paciente'} tomar ${remedio.nome} agora.`;
      speak(msg); playAlertSound();
      await LocalNotifications.schedule({notifications:[{title: msg, body:'Hor√°rio do medicamento', id: new Date().getTime(), schedule:{at: new Date()}, sound:'alert.mp3', smallIcon:'icon', channelId:'meds'}]});
      historico.unshift({id:uid(), paciente:remedio.paciente, nome:remedio.nome, horario:hhmm, data:new Date().toLocaleString()});
      salvarTudo(); agendarRemedio(remedio);
    }, delay);
  });
}

function renderTabela(){
  const tbody=document.querySelector('#tblRemedios tbody'); tbody.innerHTML='';
  remedios.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.foto?`<img src="${r.foto}" class="pill-img">`:''}</td>
      <td>${r.paciente||''}</td>
      <td>${r.nome||''}</td>
      <td>${(r.horarios||[]).join(', ')}</td>
      <td><button class="btn-small green" onclick="tomou('${r.id}')">Tomou</button>
      <button class="btn-small red" onclick="remover('${r.id}')">Remover</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderHistorico(){
  const div=document.getElementById('historyList'); div.innerHTML='';
  historico.forEach(h=>{
    const el=document.createElement('div'); el.className='history-item';
    el.textContent=`${h.data}: ${h.paciente} tomou ${h.nome} (${h.horario})`;
    div.appendChild(el);
  });
}

function tomou(id){
  const r=remedios.find(x=>x.id===id);
  if(!r) return;
  historico.unshift({id:uid(), paciente:r.paciente, nome:r.nome, horario:nowBrasilia().toTimeString().slice(0,5), data:new Date().toLocaleString()});
  salvarTudo();
  alert(`${r.paciente} tomou ${r.nome}`);
}

function remover(id){
  remedios=remedios.filter(x=>x.id!==id); salvarTudo();
}

document.getElementById('btnManual').addEventListener('click',()=>document.getElementById('modalForm').classList.add('open'));
document.getElementById('btnCancelar').addEventListener('click',()=>document.getElementById('modalForm').classList.remove('open'));
document.getElementById('btnSalvar').addEventListener('click',()=>{
  const paciente=document.getElementById('inputPaciente').value.trim();
  const nome=document.getElementById('inputNome').value.trim();
  const instrucao=document.getElementById('inputInstrucao').value.trim();
  const horaInicial=document.getElementById('inputHora').value;
  const fotoInput=document.getElementById('inputFoto');
  if(!nome) return alert('Preencha o nome do medicamento.');
  const reader=new FileReader();
  reader.onload=function(e){
    const novo={id:uid(), paciente,nome,instrucao,horaInicial,foto:e.target.result, horarios:[]};
    remedios.push(novo);
    salvarTudo(); agendarRemedio(novo);
    document.getElementById('modalForm').classList.remove('open');
  };
  if(fotoInput.files[0]) reader.readAsDataURL(fotoInput.files[0]);
  else reader.onload({target:{result:''}});
});

document.getElementById('btnLimparHistorico').addEventListener('click',()=>{ historico=[]; salvarTudo(); });
document.getElementById('btnExport').addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(remedios,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='remedios.json'; a.click(); URL.revokeObjectURL(url); });
document.getElementById('btnImport').addEventListener('click',()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=e=>{
  const file=e.target.files[0]; const reader=new FileReader(); reader.onload=ev=>{ try{ const data=JSON.parse(ev.target.result); if(Array.isArray(data)){remedios=data; salvarTudo(); data.forEach(r=>agendarRemedio(r)); } }catch(err){alert('Arquivo inv√°lido');} }; reader.readAsText(file); }; inp.click(); });

document.getElementById('btnAlarm').addEventListener('click',()=>{ window.location.href='intent://#Intent;action=android.intent.action.SET_ALARM;end'; });

document.getElementById('btnVoz').addEventListener('click',()=>{
  if(!('webkitSpeechRecognition' in window)) return alert('Seu navegador n√£o suporta comando de voz.');
  const recognition=new webkitSpeechRecognition();
  recognition.lang='pt-BR'; recognition.interimResults=false;
  recognition.onresult=(e)=>{ const texto=e.results[0][0].transcript; alert('Voc√™ disse: '+texto); };
  recognition.start();
});

document.getElementById('btnAdd').addEventListener('click',()=>document.getElementById('inpFotoOCR').click());
document.getElementById('inpFotoOCR').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const { data:{ text } } = await Tesseract.recognize(file,'por'); alert('Texto extra√≠do:\n'+text);
});

remedios.forEach(r=>agendarRemedio(r));
renderTabela(); renderHistorico();

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js')
    .then(()=>console.log('SW registrado'))
    .catch(e=>console.log(e));
}

</script>
</body>
</html>


