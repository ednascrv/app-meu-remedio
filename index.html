<!doctype html> 
<html lang="pt-BR"> 
<head> 
<meta charset="utf-8" /> 
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" /> 
<title>Meu Rem√©dio</title> 

<!-- PWA Meta Tags -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00796b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Meu Rem√©dio">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
/* ================= VARI√ÅVEIS E ESTILOS GERAIS ================= */
:root{ 
  --blue:#0077b6; --green:#2e7d32; --accent:#013233; --bg:#fbfdfc; 
  --card:#fff; --muted:#6c7a7a; --shadow:0 6px 18px rgba(2,48,60,0.08); 
  --gap:12px; --radius:12px; 
}
*{box-sizing:border-box} 
html,body{height:100%} 
body{
  margin:0;
  font-family:Inter, "Segoe UI", Arial, sans-serif;
  background:var(--bg);
  color:var(--accent);
  -webkit-font-smoothing:antialiased;
  font-size: 16px;
} 

header{
  background:linear-gradient(90deg,var(--blue),var(--green));
  color:white;
  padding:14px 12px;
  text-align:center;
  font-size:18px;
  font-weight:800;
  border-bottom-left-radius:14px;
  border-bottom-right-radius:14px;
  position:sticky;
  top:0;
  z-index:20;
} 

.app{
  max-width:920px;
  margin:10px auto;
  padding:12px;
  padding-bottom: 70px;
} 

.controls{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-bottom:12px;
} 

@media (max-width:720px){ 
  .controls{ grid-template-columns:1fr } 
} 

.btn-primary{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:12px;
  border-radius:12px;
  border:none;
  background:linear-gradient(90deg,var(--blue),var(--green));
  color:white;
  font-weight:700;
  font-size:15px;
  box-shadow:var(--shadow);
  width:100%;
  cursor: pointer;
  position: relative;
  z-index: 1;
  pointer-events: auto !important;
  touch-action: manipulation;
} 

.btn-small{
  padding:8px 12px;
  border-radius:10px;
  border:none;
  background:linear-gradient(90deg,var(--blue),var(--green));
  color:white;
  font-weight:700;
  cursor:pointer;
  font-size: 14px;
  position: relative;
  z-index: 1;
  pointer-events: auto !important;
}

.btn-ghost{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #e6f3f0;
  background:transparent;
  color:var(--accent);
  cursor:pointer;
  font-size: 14px;
  position: relative;
  z-index: 1;
  pointer-events: auto !important;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:12px;
  box-shadow:var(--shadow);
  margin-bottom:12px;
} 

.flex{
  display:flex;
  gap:8px;
  align-items:center;
} 

.flex-space{
  display:flex;
  justify-content:space-between;
  align-items:center;
} 

h2{
  margin:0;
  color:var(--blue);
  font-size:16px;
} 

.small{
  font-size:13px;
  color:var(--muted);
  margin-top:6px;
} 

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
} 

.table th,.table td{
  padding:8px;
  border-bottom:1px solid #eef6f1;
  text-align:left;
} 

.table th{
  font-weight:700;
  color:#0a3b4a;
} 

.footer{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  height:56px;
  background:linear-gradient(90deg,var(--blue),var(--green));
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-weight:700;
  border-top-left-radius:12px;
  border-top-right-radius:12px;
  z-index:10;
}

/* ================= MODALS ================= */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.45);
  z-index:9999;
  padding:12px;
}

.modal.open{
  display:flex;
}

.modal-content{
  width:100%;
  max-width:680px;
  background:#fff;
  border-radius:12px;
  padding:16px;
  max-height:92vh;
  overflow:auto;
}

.form-row{
  margin-bottom:10px;
}

label{
  display:block;
  font-weight:700;
  margin-bottom:6px;
}

input[type="text"], input[type="time"], input[type="date"], textarea, select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #e8f1ef;
  font-size:15px;
}

.history-item{
  background:#f6fffb;
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
}

.actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.kv{
  font-size:13px;
  color:#4a5a5a;
}

.pill-img{
  width:56px;
  height:40px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #e6f3f0;
}

.small-note{
  font-size:12px;
  color:#667;
}

.hidden{
  display:none !important;
}

.input-file-wrapper{
  display:flex;
  gap:8px;
  align-items:center;
}

.status-online, .status-offline {
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
  font-weight:700;
}

.status-online{
  background:#e8f5e8;
  color:#2e7d32;
}

.status-offline{
  background:#ffebee;
  color:#c62828;
}

.badge{
  background:var(--blue);
  color:white;
  padding:2px 6px;
  border-radius:4px;
  font-size:11px;
  font-weight:700;
}

/* ================= TUTORIAL STYLES ================= */
.tutorial-steps {
  margin: 20px 0;
  min-height: 200px;
}

.tutorial-step {
  padding: 15px;
  background: #f8fdff;
  border-radius: 10px;
  border-left: 4px solid var(--blue);
}

.tutorial-step.hidden {
  display: none;
}

.tutorial-step.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

.tutorial-voice {
  background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: bold;
}

.tutorial-tip {
  background: #fff3cd;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  border-left: 4px solid #ffc107;
}

.tutorial-demo {
  text-align: center;
  margin: 15px 0;
}

.tutorial-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin: 15px 0;
}

.tutorial-button-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 10px;
  background: white;
  border-radius: 8px;
  border: 2px solid #e6f3f0;
}

.tutorial-button-item button {
  width: 60px;
  height: 60px;
  font-size: 20px;
}

/* Bot√£o de Ajuda Flutuante */
.help-floating {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: linear-gradient(90deg, #ff6b6b, #ff8e53);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 20px;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
  z-index: 1000;
  cursor: pointer;
  animation: pulse 2s infinite;
  display: none;
}

.help-floating:hover {
  transform: scale(1.05);
}

/* Anima√ß√µes */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* Acessibilidade - Controles de Texto */
.text-controls {
  display: flex;
  gap: 8px;
  margin: 10px 0;
}

.text-controls button {
  padding: 6px 10px;
  font-size: 12px;
  border: 1px solid #ccc;
  background: white;
  border-radius: 4px;
  cursor: pointer;
}

/* Melhorias para os bot√µes do tutorial */
.tutorial-nav-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 20px;
  flex-wrap: wrap;
}

.tutorial-nav-buttons button {
  min-width: 120px;
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

#btnStartApp {
  background: linear-gradient(90deg, #2e7d32, #4caf50) !important;
  color: white !important;
  border: 2px solid #1b5e20 !important;
  display: none !important;
}

#btnStartApp.show {
  display: block !important;
}

#btnAcceptTerms {
  background: linear-gradient(90deg, #0077b6, #2196f3) !important;
}

/* Feedback visual para o √∫ltimo passo */
.tutorial-step[data-step="4"] {
  border-left-color: #4caf50;
  background: #f1f8e9;
}

/* Transi√ß√µes suaves para modais */
.modal {
  transition: opacity 0.3s ease;
}

.modal.open {
  animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
  from { 
    opacity: 0; 
    backdrop-filter: blur(0px);
  }
  to { 
    opacity: 1; 
    backdrop-filter: blur(4px);
  }
}

/* Melhorar visibilidade dos bot√µes de termos */
#modalTerms .modal-content {
  background: linear-gradient(135deg, #f8fdff, #ffffff);
  border: 2px solid #0077b6;
}

#modalTerms h3 {
  color: #0077b6;
  text-align: center;
}

/* ================= ESTILOS PARA RECEITAS ================= */
.receita-item {
  background: #f8fdff;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  border-left: 4px solid #4a9eff;
}

.receita-vencida {
  background: #ffebee;
  border-left: 4px solid #f44336;
  animation: pulse-alert 2s infinite;
}

.receita-proximo-vencimento {
  background: #fff3e0;
  border-left: 4px solid #ff9800;
}

.receita-valida {
  background: #e8f5e8;
  border-left: 4px solid #4caf50;
}

.status-receita {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  text-align: center;
  display: inline-block;
}

.status-vencida {
  background: #ffebee;
  color: #c62828;
}

.status-proximo {
  background: #fff3e0;
  color: #ef6c00;
}

.status-valida {
  background: #e8f5e8;
  color: #2e7d32;
}

.alert-warning {
  background: linear-gradient(135deg, #fff3e0, #ffecb3);
  border: 1px solid #ffd54f;
  border-left: 4px solid #ff9800;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
}

.alert-danger {
  background: linear-gradient(135deg, #ffebee, #ffcdd2);
  border: 1px solid #ef9a9a;
  border-left: 4px solid #f44336;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
}

.alert-info {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  border: 1px solid #90caf9;
  border-left: 4px solid #2196f3;
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
}

@keyframes pulse-alert {
  0% { opacity: 1; }
  50% { opacity: 0.8; }
  100% { opacity: 1; }
}

.receita-foto-modal {
  max-width: 300px;
  max-height: 400px;
  border-radius: 8px;
  border: 2px solid #e6f3f0;
  cursor: zoom-in;
}

.receita-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.receita-modal-overlay.open {
  display: flex;
}

.receita-modal-img {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* ================= CORRE√á√ÉO ESPEC√çFICA PARA MODAL RECEITA ================= */
#modalReceita {
  position: fixed !important;
  z-index: 9999 !important;
}

#modalReceita.open {
  display: flex !important;
  opacity: 1 !important;
  visibility: visible !important;
}

#btnAddReceita {
  position: relative !important;
  z-index: 1 !important;
  pointer-events: auto !important;
  cursor: pointer !important;
}

/* Garantir que o modal fique acima de tudo */
.modal {
  z-index: 9999 !important;
}

.modal.open {
  display: flex !important;
  animation: modalFadeIn 0.3s ease !important;
}

@keyframes modalFadeIn {
  from { 
    opacity: 0; 
    transform: scale(0.9);
  }
  to { 
    opacity: 1; 
    transform: scale(1);
  }
}
/* Estilos para os novos componentes */
.alarm-item {
  display: flex;
  align-items: center;
  padding: 12px;
  margin: 8px 0;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #00796b;
}

.alarm-time {
  font-weight: bold;
  min-width: 80px;
  margin-right: 12px;
}

.alarm-info {
  flex: 1;
}

.alarm-info strong {
  display: block;
  color: #333;
}

.alarm-info span {
  font-size: 0.9em;
  color: #666;
}

.alarm-info small {
  display: block;
  font-size: 0.8em;
  color: #888;
  margin-top: 4px;
}

.btn-cancel {
  background: none;
  border: none;
  font-size: 1.2em;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
}

.btn-cancel:hover {
  background: #ffebee;
}

.no-alarms {
  text-align: center;
  color: #666;
  font-style: italic;
  padding: 20px;
}

.status-online { color: #4caf50; }
.status-offline { color: #f44336; }
.status-syncing { color: #ff9800; }

/* Toast notifications */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  z-index: 10000;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s;
}

.toast.show {
  opacity: 1;
}
</style>
</head> 

<body> 
<header>üíä Meu Rem√©dio</header> 

<main class="app" role="main" aria-labelledby="mainTitle"> 
  <div class="controls" role="group" aria-label="A√ß√µes principais"> 
    <button id="btnAddMed" class="btn-primary" aria-haspopup="dialog">‚úèÔ∏è Adicionar</button> 
    <button id="btnVoiceFlow" class="btn-primary">üéôÔ∏è Preencher por voz</button> 
    <button id="btnAlarm" class="btn-primary">‚è∞ Alarme/Lembrete</button> 
  </div> 

  <div class="card" aria-live="polite"> 
    <div class="flex-space"> 
      <h2>Configura√ß√µes</h2> 
      <div class="flex"> 
        <label><input type="checkbox" id="toggleNarrador" checked> Narrador</label> 
        <label style="margin-left:10px"><input type="checkbox" id="toggleVerboso"> Modo Verboso</label> 
      </div> 
    </div> 
    <div class="small">Ative narrador e modo verboso para que o app leia listas e hist√≥rico automaticamente.</div> 
    
    <!-- Controles de Acessibilidade -->
    <div class="text-controls">
      <button onclick="increaseTextSize()" title="Aumentar texto">A+</button>
      <button onclick="decreaseTextSize()" title="Diminuir texto">A-</button>
      <button onclick="readCurrentScreen()" title="Ler tela atual">üîä Ler Tela</button>
    </div>
    
    <div class="flex" style="margin-top:8px"> 
      <span id="connectionStatus" class="status-online">‚óè Online</span> 
      <span id="notificationStatus" class="status-offline" style="margin-left:8px">üîï Notifica√ß√µes</span> 
    </div> 
  </div> 

  <section class="card" aria-labelledby="medTitle" id="medSection"> 
    <div class="flex-space"> 
      <h2 id="medTitle">Medicamentos <span id="medCount" class="badge">0</span></h2> 
      <div class="actions"> 
        <button id="btnExport" class="btn-small">‚¨á Exportar</button> 
        <button id="btnImport" class="btn-small">‚¨Ü Importar</button> 
      </div> 
    </div>
    <table class="table" id="tblMeds" aria-describedby="Lista de medicamentos">
      <thead><tr><th>Foto</th><th>Paciente</th><th>Medicamento</th><th>Instru√ß√£o</th><th>Hora</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="emptyMeds" class="small">Nenhum medicamento cadastrado.</div>
  </section> 

  <!-- Se√ß√£o de Receitas -->
  <section class="card" id="receitaSection">
    <div class="flex-space">
      <h2>üìã Receitas M√©dicas <span id="receitaCount" class="badge">0</span></h2>
      <div class="actions">
        <button id="btnAddReceita" class="btn-small">‚ûï Nova Receita</button>
      </div>
    </div>
    
    <div id="receitaAlerts" style="margin: 10px 0;"></div>
    
    <table class="table" id="tblReceitas" aria-describedby="Lista de receitas m√©dicas">
      <thead>
        <tr>
          <th>Foto</th>
          <th>Paciente</th>
          <th>M√©dico</th>
          <th>Emiss√£o</th>
          <th>Validade</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="emptyReceitas" class="small">Nenhuma receita cadastrada.</div>
  </section>

  <section class="card" id="histSection"> 
    <div class="flex-space"> 
      <h2>Hist√≥rico (doses tomadas) <span id="histCount" class="badge">0</span></h2> 
      <div class="actions"><button id="btnClearHist" class="btn-ghost">Limpar hist√≥rico</button></div> 
    </div> 
    <div id="histList" style="margin-top:10px"></div> 
  </section> 

  <section class="card" id="consultSection"> 
    <div class="flex-space"> 
      <h2>Consultas <span id="consCount" class="badge">0</span></h2> 
      <div class="actions"><button id="btnAddConsult" class="btn-small">‚ûï Nova consulta</button></div> 
    </div>
    <table class="table" id="tblConsults">
      <thead><tr><th>Data</th><th>Profissional / Local</th><th>Observa√ß√£o</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="emptyConsults" class="small">Nenhuma consulta cadastrada.</div>
  </section> 
</main> 

<!-- Modal: Receitas M√©dicas -->
<div id="modalReceita" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalReceitaTitle">
  <div class="modal-content">
    <h3 id="modalReceitaTitle">üíä Nova Receita M√©dica</h3>
    
    <div class="form-row">
      <label for="receitaMedico">M√©dico/Profissional *</label>
      <input id="receitaMedico" type="text" placeholder="Dr. Jo√£o Silva - Cardiologista">
    </div>
    
    <div class="form-row">
      <label for="receitaPaciente">Paciente *</label>
      <input id="receitaPaciente" type="text" placeholder="Nome do paciente">
    </div>
    
    <div class="form-row">
      <label for="receitaMedicamentos">Medicamentos Prescritos</label>
      <textarea id="receitaMedicamentos" rows="3" placeholder="Lista de medicamentos da receita..."></textarea>
    </div>
    
    <div class="form-row">
      <label for="receitaDataEmissao">Data de Emiss√£o *</label>
      <input id="receitaDataEmissao" type="date">
    </div>
    
    <div class="form-row">
      <label for="receitaDataValidade">Data de Validade *</label>
      <input id="receitaDataValidade" type="date">
    </div>
    
    <div class="form-row">
      <label for="receitaObservacoes">Observa√ß√µes</label>
      <textarea id="receitaObservacoes" rows="2" placeholder="Observa√ß√µes importantes..."></textarea>
    </div>
    
    <div class="form-row">
      <label>Foto da Receita (opcional)</label>
      <div class="input-file-wrapper">
        <input id="receitaFotoInput" type="file" accept="image/*" capture="environment">
        <img id="receitaFotoPreview" class="pill-img hidden" alt="pr√©via da receita">
        <button id="btnRemoverFotoReceita" class="btn-ghost hidden" type="button">Remover foto</button>
      </div>
      <div class="small-note">üì∑ Fotografe a receita para ter uma c√≥pia digital</div>
    </div>
    
    <div class="alert-info" style="margin: 15px 0; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
      <strong>üí° Lembretes autom√°ticos:</strong> O app avisar√° 7 dias antes do vencimento.
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="btnCancelReceita" class="btn-ghost">Cancelar</button>
      <button id="btnSaveReceita" class="btn-small">üíæ Salvar Receita</button>
    </div>
  </div>
</div>

<div class="footer">Meu Rem√©dio ‚Äî Privado & Local</div> 

<!-- ================= MODALS ================= -->

<!-- Modal: Medicamento Add/Edit --> 
<div id="modalMed" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMedTitle"> 
  <div class="modal-content"> 
    <h3 id="modalMedTitle">Adicionar medicamento</h3>
    <div class="form-row">
      <label for="medPaciente">Paciente</label>
      <input id="medPaciente" type="text" placeholder="Nome do paciente">
    </div>
    <div class="form-row">
      <label for="medNome">Medicamento *</label>
      <input id="medNome" type="text" placeholder="Ex: Paracetamol">
    </div>
    <div class="form-row">
      <label for="medInstr">Instru√ß√£o</label>
      <input id="medInstr" type="text" placeholder="Ex: a cada 8h">
    </div>
    <div class="form-row">
      <label for="medHora">Hora inicial *</label>
      <input id="medHora" type="time">
    </div>
    <div class="form-row">
      <label>Foto do medicamento</label>
      <div class="input-file-wrapper">
        <input id="medFotoInput" type="file" accept="image/*" capture="environment">
        <img id="medFotoPreview" class="pill-img hidden" alt="pr√©via">
        <button id="btnRemoverFoto" class="btn-ghost hidden" type="button">Remover foto</button>
      </div>
      <div class="small-note">Use a c√¢mera para capturar o frasco ou a caixa (opcional).</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="btnCancelMed" class="btn-ghost">Cancelar</button>
      <button id="btnSaveMed" class="btn-small">Salvar</button>
    </div>
  </div> 
</div> 

<!-- Modal: Consultas Add/Edit --> 
<div id="modalConsult" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalConsultTitle"> 
  <div class="modal-content"> 
    <h3 id="modalConsultTitle">Nova consulta</h3> 
    <div class="form-row"><label for="consData">Data *</label><input id="consData" type="date"></div> 
    <div class="form-row"><label for="consProf">Profissional / Local *</label><input id="consProf" type="text" placeholder="Ex: Dr. Fulano - Cardiologia"></div> 
    <div class="form-row"><label for="consObs">Observa√ß√£o</label><textarea id="consObs" rows="3" placeholder="Observa√ß√µes"></textarea></div> 
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"> 
      <button id="btnCancelCons" class="btn-ghost">Cancelar</button> 
      <button id="btnSaveCons" class="btn-small">Salvar</button> 
    </div> 
  </div> 
</div> 

<!-- Modal: Configura√ß√µes de Notifica√ß√£o -->
<div id="modalNotifSettings" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalNotifTitle">
  <div class="modal-content">
    <h3 id="modalNotifTitle">‚öôÔ∏è Configura√ß√µes de Notifica√ß√£o</h3>
    <div class="form-row">
      <label><input type="checkbox" id="notifMedEnabled" checked> Ativar lembretes de medicamentos</label>
    </div>
    <div class="form-row">
      <label><input type="checkbox" id="notifConsEnabled" checked> Ativar lembretes de consultas</label>
    </div>
    <div class="form-row">
      <label><input type="checkbox" id="notifSoundEnabled" checked> Som nas notifica√ß√µes</label>
    </div>
    <div class="form-row">
      <label for="notifAdvanceTime">Anteced√™ncia (minutos)</label>
      <select id="notifAdvanceTime">
        <option value="0">No hor√°rio exato</option>
        <option value="5">5 minutos antes</option>
        <option value="10">10 minutos antes</option>
        <option value="15" selected>15 minutos antes</option>
        <option value="30">30 minutos antes</option>
      </select>
    </div>
    <div class="small-note" style="margin-top:12px">
      <strong>Pr√≥ximos alarmes:</strong><br>
      <div id="nextAlarmsList"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="btnCancelNotif" class="btn-ghost">Fechar</button>
      <button id="btnTestNotif" class="btn-small">Testar Notifica√ß√£o</button>
    </div>
  </div>
</div>

<!-- Modal: Termos de Uso --> 
<div id="modalTerms" class="modal open" role="dialog" aria-modal="true" aria-labelledby="termsTitle"> 
  <div class="modal-content"> 
    <h3 id="termsTitle">üìú Termos de Uso</h3> 
    <div style="line-height:1.5;margin-top:8px"> 
      Ao utilizar este app, voc√™ concorda que as informa√ß√µes inseridas (nomes, hor√°rios, fotos) ser√£o armazenadas apenas no seu dispositivo (localStorage). Nenhum dado √© enviado sem seu consentimento. Este app √© um aux√≠lio e n√£o substitui orienta√ß√£o m√©dica. 
    </div> 
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"> 
      <button id="btnReadTerms" class="btn-ghost">üîä Ouvir termos</button> 
      <button id="btnAcceptTerms" class="btn-small">Aceitar</button> 
    </div> 
  </div> 
</div>

<!-- Modal: Tutorial Inicial -->
<div id="modalTutorial" class="modal" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
  <div class="modal-content" style="max-width: 500px;">
    <h3 id="tutorialTitle" style="text-align: center;">üéâ Bem-vindo ao Meu Rem√©dio!</h3>
    
    <div style="text-align: center; margin: 20px 0;">
      <div style="font-size: 48px; margin-bottom: 10px;">üíä</div>
      <p><strong>Seu assistente pessoal para medicamentos</strong></p>
    </div>

    <div class="tutorial-steps">
      <!-- Passo 1 -->
      <div class="tutorial-step active" data-step="1">
        <h4>üîä <span class="tutorial-voice">NARRADOR DE VOZ</span></h4>
        <p>O app FALA com voc√™! Toque nos bot√µes e escute as instru√ß√µes.</p>
        <div class="tutorial-tip">
          <strong>Dica:</strong> Deixe o narrador sempre LIGADO
        </div>
      </div>

      <!-- Passo 2 -->
      <div class="tutorial-step hidden" data-step="2">
        <h4>üéôÔ∏è <span class="tutorial-voice">COMANDOS POR VOZ</span></h4>
        <p>Use o bot√£o <strong>"Preencher por voz"</strong> para cadastrar rem√©dios falando.</p>
        <div class="tutorial-demo">
          <button class="btn-small" onclick="demoVoiceCommand()">üéôÔ∏è Experimente falar</button>
        </div>
      </div>

      <!-- Passo 3 -->
      <div class="tutorial-step hidden" data-step="3">
        <h4>‚è∞ <span class="tutorial-voice">LEMBRETES AUTOM√ÅTICOS</span></h4>
        <p>O app avisa na hora certa de tomar seus rem√©dios!</p>
        <ul style="text-align: left; margin: 15px 0;">
          <li>‚úÖ Toque em "Tomei" quando tomar</li>
          <li>üîî Receba lembretes no celular</li>
          <li>üìù Hist√≥rico para conferir</li>
        </ul>
      </div>

      <!-- Passo 4 -->
      <div class="tutorial-step hidden" data-step="4">
        <h4>üëÜ <span class="tutorial-voice">BOT√ïES COM S√çMBOLOS</span></h4>
        <div class="tutorial-buttons">
          <div class="tutorial-button-item">
            <button class="btn-small">‚úèÔ∏è</button>
            <span>Adicionar</span>
          </div>
          <div class="tutorial-button-item">
            <button class="btn-small">üéôÔ∏è</button>
            <span>Voz</span>
          </div>
          <div class="tutorial-button-item">
            <button class="btn-small">‚è∞</button>
            <span>Alarme</span>
          </div>
          <div class="tutorial-button-item">
            <button class="btn-small">‚úÖ</button>
            <span>Tomei</span>
          </div>
        </div>
      </div>
    </div>

    <div class="tutorial-nav-buttons">
      <button id="btnPrevTutorial" class="btn-ghost" disabled>‚¨ÖÔ∏è Anterior</button>
      <button id="btnNextTutorial" class="btn-small">Pr√≥ximo ‚û°Ô∏è</button>
      <button id="btnSkipTutorial" class="btn-ghost">Pular Tutorial</button>
      <button id="btnStartApp" class="btn-small">üéâ Come√ßar a Usar!</button>
    </div>

    <div style="text-align: center; margin-top: 15px;">
      <label>
        <input type="checkbox" id="dontShowAgain"> 
        N√£o mostrar tutorial novamente
      </label>
    </div>
  </div>
</div>

<!-- Bot√£o flutuante de Ajuda -->
<button id="btnHelp" class="help-floating" aria-label="Ajuda e tutorial" title="Precisa de ajuda?">
  ‚ùì Ajuda
</button>

<script>
// ================= VARI√ÅVEIS GLOBAIS =================
const LS_MED = 'meu_remedio_med_photos_v3';
const LS_HIST = 'meu_remedio_hist_v3';
const LS_CONS = 'meu_remedio_consults_v3';
const LS_TERMS = 'meu_remedio_termos_v3';
const LS_TUTORIAL = 'meu_remedio_tutorial_v3';
const LS_NOTIF_SETTINGS = 'meu_remedio_notif_settings_v3';
const LS_RECEITAS = 'meu_remedio_receitas_v1';

let meds = JSON.parse(localStorage.getItem(LS_MED) || '[]');
let hist = JSON.parse(localStorage.getItem(LS_HIST) || '[]');
let consults = JSON.parse(localStorage.getItem(LS_CONS) || '[]');
let receitas = JSON.parse(localStorage.getItem(LS_RECEITAS) || '[]');
let notifSettings = JSON.parse(localStorage.getItem(LS_NOTIF_SETTINGS) || '{"medEnabled":true,"consEnabled":true,"soundEnabled":true,"advanceTime":15}');

let currentStep = 1;
const totalSteps = 4;

// ================= FUN√á√ïES UTILIT√ÅRIAS =================
function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

function esc(s) {
  if(!s) return '';
  return String(s).replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[c]);
}

function saveAll() {
  localStorage.setItem(LS_MED, JSON.stringify(meds));
  localStorage.setItem(LS_HIST, JSON.stringify(hist));
  localStorage.setItem(LS_CONS, JSON.stringify(consults));
  localStorage.setItem(LS_RECEITAS, JSON.stringify(receitas));
  localStorage.setItem(LS_NOTIF_SETTINGS, JSON.stringify(notifSettings));
}

function formatarDataPTBR(dateString) {
  const date = new Date(dateString + 'T00:00:00');
  return date.toLocaleDateString('pt-BR');
}

// ================= FUN√á√ïES DE NARRA√á√ÉO =================
function narrarEnabled() {
  return document.getElementById('toggleNarrador').checked;
}

function speak(text) {
  if(!narrarEnabled()) return;
  try {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'pt-BR';
    u.rate = 1;
    window.speechSynthesis.speak(u);
  } catch(e) {
    console.warn('Erro s√≠ntese de voz:', e);
  }
}

// ================= FUN√á√ïES DE ACESSIBILIDADE =================
function increaseTextSize() {
  const currentSize = parseInt(getComputedStyle(document.body).fontSize) || 16;
  document.body.style.fontSize = (currentSize + 2) + 'px';
  localStorage.setItem('textSize', document.body.style.fontSize);
  if (narrarEnabled()) speak('Texto aumentado');
}

function decreaseTextSize() {
  const currentSize = parseInt(getComputedStyle(document.body).fontSize) || 16;
  document.body.style.fontSize = Math.max(14, currentSize - 2) + 'px';
  localStorage.setItem('textSize', document.body.style.fontSize);
  if (narrarEnabled()) speak('Texto diminu√≠do');
}

function readCurrentScreen() {
  if (!narrarEnabled()) return;
  const mainTitle = document.querySelector('header')?.textContent || '';
  const medCount = meds.length;
  const histCount = hist.length;
  const consCount = consults.length;
  const recCount = receitas.length;
  speak(`${mainTitle}. Voc√™ tem ${medCount} medicamentos, ${recCount} receitas, ${histCount} registros no hist√≥rico e ${consCount} consultas.`);
}

// ================= FUN√á√ïES DE INTERFACE =================
function refreshUI() {
  renderMeds();
  renderHist();
  renderConsults();
  renderReceitas();
}

function renderMeds() {
  const tbody = document.querySelector('#tblMeds tbody');
  const empty = document.getElementById('emptyMeds');
  const count = document.getElementById('medCount');
  
  count.textContent = meds.length;
  
  if (meds.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  
  empty.style.display = 'none';
  tbody.innerHTML = meds.map(med => `
    <tr>
      <td>${med.foto ? `<img src="${med.foto}" class="pill-img" alt="${esc(med.nome)}">` : '‚Äî'}</td>
      <td>${esc(med.paciente)}</td>
      <td>${esc(med.nome)}</td>
      <td>${esc(med.instrucao)}</td>
      <td>${med.hora}</td>
      <td>
        <div class="actions">
          <button class="btn-small" onclick="marcarComoTomado('${med.id}')">‚úÖ Tomei</button>
          <button class="btn-ghost" onclick="editarMedicamento('${med.id}')">‚úèÔ∏è Editar</button>
          <button class="btn-ghost" onclick="excluirMedicamento('${med.id}')">üóëÔ∏è Excluir</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function renderHist() {
  const histList = document.getElementById('histList');
  const count = document.getElementById('histCount');
  
  count.textContent = hist.length;
  
  if (hist.length === 0) {
    histList.innerHTML = '<div class="small">Nenhum registro no hist√≥rico.</div>';
    return;
  }
  
  histList.innerHTML = hist.slice(-10).reverse().map(item => `
    <div class="history-item">
      <div class="flex-space">
        <strong>${esc(item.medicamento)}</strong>
        <span class="small">${new Date(item.data).toLocaleString('pt-BR')}</span>
      </div>
      <div class="small">Paciente: ${esc(item.paciente)}</div>
    </div>
  `).join('');
}

function renderConsults() {
  const tbody = document.querySelector('#tblConsults tbody');
  const empty = document.getElementById('emptyConsults');
  const count = document.getElementById('consCount');
  
  count.textContent = consults.length;
  
  if (consults.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  
  empty.style.display = 'none';
  tbody.innerHTML = consults.map(cons => `
    <tr>
      <td>${formatarDataPTBR(cons.data)}</td>
      <td>${esc(cons.prof)}</td>
      <td>${esc(cons.obs)}</td>
      <td>
        <div class="actions">
          <button class="btn-ghost" onclick="editarConsulta('${cons.id}')">‚úèÔ∏è Editar</button>
          <button class="btn-ghost" onclick="excluirConsulta('${cons.id}')">üóëÔ∏è Excluir</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ================= FUN√á√ïES DE RECEITAS =================
function renderReceitas() {
  const tbody = document.querySelector('#tblReceitas tbody');
  const empty = document.getElementById('emptyReceitas');
  const count = document.getElementById('receitaCount');
  
  count.textContent = receitas.length;
  
  if (receitas.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    document.getElementById('receitaAlerts').innerHTML = '';
    return;
  }
  
  empty.style.display = 'none';
  
  // Ordenar por validade
  receitas.sort((a, b) => new Date(a.dataValidade) - new Date(b.dataValidade));
  
  tbody.innerHTML = receitas.map(rec => {
    const status = getReceitaStatus(rec);
    return `
      <tr>
        <td>${rec.foto ? `<img src="${rec.foto}" class="pill-img" alt="foto receita" onclick="ampliarFoto('${rec.foto}')" style="cursor:pointer;">` : '‚Äî'}</td>
        <td>${esc(rec.paciente)}</td>
        <td>${esc(rec.medico)}</td>
        <td>${formatarDataPTBR(rec.dataEmissao)}</td>
        <td>${formatarDataPTBR(rec.dataValidade)}</td>
        <td><span class="status-receita ${status.classe}">${status.texto}</span>${status.dias ? `<br><small>${status.dias}</small>` : ''}</td>
        <td>
          <div class="actions">
            ${rec.foto ? `<button class="btn-small" data-id="${rec.id}" data-act="verFoto">üëÅÔ∏è Ver</button>` : ''}
            <button class="btn-ghost" onclick="editarReceita('${rec.id}')">‚úèÔ∏è Editar</button>
            <button class="btn-ghost" onclick="excluirReceita('${rec.id}')">üóëÔ∏è Excluir</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  updateReceitaAlerts();
}

function getReceitaStatus(rec) {
  const hoje = new Date();
  const validade = new Date(rec.dataValidade);
  const diff = validade - hoje;
  const dias = Math.ceil(diff / (1000 * 60 * 60 * 24));
  
  if (dias < 0) {
    return {texto: "VENCIDA", classe: "status-vencida", dias: `H√° ${Math.abs(dias)} dias`};
  } else if (dias <= 7) {
    return {texto: "VENCE EM BREVE", classe: "status-proximo", dias: `${dias} dias`};
  } else {
    return {texto: "V√ÅLIDA", classe: "status-valida", dias: `${dias} dias restantes`};
  }
}

function updateReceitaAlerts() {
  const alerts = document.getElementById('receitaAlerts');
  const hoje = new Date();
  let alertas = [];
  
  receitas.forEach(rec => {
    const validade = new Date(rec.dataValidade);
    const diff = validade - hoje;
    const dias = Math.ceil(diff / (1000 * 60 * 60 * 24));
    
    if (dias < 0) {
      alertas.push({tipo: "danger", mensagem: `‚ö†Ô∏è <strong>RECEITA VENCIDA:</strong> ${rec.paciente} - ${rec.medico} (Venceu h√° ${Math.abs(dias)} dias)`});
    } else if (dias <= 3) {
      alertas.push({tipo: "warning", mensagem: `üîî <strong>RECEITA VENCE EM BREVE:</strong> ${rec.paciente} - ${rec.medico} (Vence em ${dias} dias)`});
    } else if (dias <= 7) {
      alertas.push({tipo: "info", mensagem: `üìÖ <strong>RECEITA PR√ìXIMA DO VENCIMENTO:</strong> ${rec.paciente} - ${rec.medico} (Vence em ${dias} dias)`});
    }
  });
  
  if (alertas.length === 0) {
    alerts.innerHTML = '';
  } else {
    alerts.innerHTML = alertas.map(a => `<div class="alert-${a.tipo}">${a.mensagem}</div>`).join('');
  }
}

function ampliarFoto(src) {
  const overlay = document.createElement('div');
  overlay.className = 'receita-modal-overlay open';
  overlay.innerHTML = `
    <img src="${src}" class="receita-modal-img" alt="Receita ampliada">
    <button onclick="this.parentElement.remove()" style="position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;">‚úï</button>
  `;
  document.body.appendChild(overlay);
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.remove();
  });
}

// ================= FUN√á√ïES DE MEDICAMENTOS =================
function openMedModal(editId = null) {
  const modal = document.getElementById('modalMed');
  const title = document.getElementById('modalMedTitle');
  
  if (editId) {
    title.textContent = 'Editar medicamento';
    const med = meds.find(m => m.id === editId);
    if (med) {
      document.getElementById('medPaciente').value = med.paciente || '';
      document.getElementById('medNome').value = med.nome || '';
      document.getElementById('medInstr').value = med.instrucao || '';
      document.getElementById('medHora').value = med.hora || '';
      if (med.foto) {
        document.getElementById('medFotoPreview').src = med.foto;
        document.getElementById('medFotoPreview').classList.remove('hidden');
        document.getElementById('btnRemoverFoto').classList.remove('hidden');
      }
    }
    modal.setAttribute('data-edit-id', editId);
  } else {
    title.textContent = 'Adicionar medicamento';
    document.getElementById('medPaciente').value = '';
    document.getElementById('medNome').value = '';
    document.getElementById('medInstr').value = '';
    document.getElementById('medHora').value = '';
    document.getElementById('medFotoInput').value = '';
    document.getElementById('medFotoPreview').src = '';
    document.getElementById('medFotoPreview').classList.add('hidden');
    document.getElementById('btnRemoverFoto').classList.add('hidden');
    modal.removeAttribute('data-edit-id');
  }
  
  modal.classList.add('open');
  if (narrarEnabled()) speak('Formul√°rio de medicamento aberto.');
}

function salvarMedicamento() {
  const nome = document.getElementById('medNome').value.trim();
  if (!nome) {
    alert('Preencha o nome do medicamento.');
    return;
  }
  
  const paciente = document.getElementById('medPaciente').value.trim();
  const instr = document.getElementById('medInstr').value.trim();
  const hora = document.getElementById('medHora').value;
  
  const editId = document.getElementById('modalMed').getAttribute('data-edit-id');
  const foto = document.getElementById('medFotoPreview').src || '';
  
  if (editId) {
    // Edi√ß√£o
    const idx = meds.findIndex(m => m.id === editId);
    if (idx > -1) {
      meds[idx] = {
        ...meds[idx],
        paciente,
        nome,
        instrucao: instr,
        hora,
        foto
      };
    }
  } else {
    // Novo
    meds.push({
      id: uid(),
      paciente,
      nome,
      instrucao: instr,
      hora,
      foto,
      criadoEm: new Date().toISOString()
    });
  }
  
  saveAll();
  refreshUI();
  document.getElementById('modalMed').classList.remove('open');
  
  if (narrarEnabled()) speak('Medicamento salvo com sucesso.');
}

function marcarComoTomado(medId) {
  const med = meds.find(m => m.id === medId);
  if (med) {
    hist.push({
      id: uid(),
      medicamento: med.nome,
      paciente: med.paciente,
      data: new Date().toISOString()
    });
    saveAll();
    refreshUI();
    if (narrarEnabled()) speak(`Medicamento ${med.nome} marcado como tomado.`);
  }
}

function editarMedicamento(medId) {
  openMedModal(medId);
}

function excluirMedicamento(medId) {
  if (confirm('Tem certeza que deseja excluir este medicamento?')) {
    meds = meds.filter(m => m.id !== medId);
    saveAll();
    refreshUI();
    if (narrarEnabled()) speak('Medicamento exclu√≠do.');
  }
}

// ================= FUN√á√ïES DE RECEITAS =================
function openReceitaModal(editId = null) {
  const modal = document.getElementById('modalReceita');
  
  if (editId) {
    const rec = receitas.find(r => r.id === editId);
    if (rec) {
      document.getElementById('receitaMedico').value = rec.medico || '';
      document.getElementById('receitaPaciente').value = rec.paciente || '';
      document.getElementById('receitaMedicamentos').value = rec.medicamentos || '';
      document.getElementById('receitaDataEmissao').value = rec.dataEmissao || '';
      document.getElementById('receitaDataValidade').value = rec.dataValidade || '';
      document.getElementById('receitaObservacoes').value = rec.observacoes || '';
      if (rec.foto) {
        document.getElementById('receitaFotoPreview').src = rec.foto;
        document.getElementById('receitaFotoPreview').classList.remove('hidden');
        document.getElementById('btnRemoverFotoReceita').classList.remove('hidden');
      }
    }
    modal.setAttribute('data-edit-id', editId);
  } else {
    document.getElementById('receitaMedico').value = '';
    document.getElementById('receitaPaciente').value = '';
    document.getElementById('receitaMedicamentos').value = '';
    document.getElementById('receitaDataEmissao').value = '';
    document.getElementById('receitaDataValidade').value = '';
    document.getElementById('receitaObservacoes').value = '';
    document.getElementById('receitaFotoInput').value = '';
    document.getElementById('receitaFotoPreview').src = '';
    document.getElementById('receitaFotoPreview').classList.add('hidden');
    document.getElementById('btnRemoverFotoReceita').classList.add('hidden');
    modal.removeAttribute('data-edit-id');
  }
  
  modal.classList.add('open');
  if (narrarEnabled()) speak('Formul√°rio de receita m√©dica aberto.');
}

function salvarReceita() {
  const medico = document.getElementById('receitaMedico').value.trim();
  const paciente = document.getElementById('receitaPaciente').value.trim();
  const dataEmissao = document.getElementById('receitaDataEmissao').value;
  const dataValidade = document.getElementById('receitaDataValidade').value;
  
  if (!medico || !paciente || !dataEmissao || !dataValidade) {
    alert('Preencha os campos obrigat√≥rios: M√©dico, Paciente, Data de Emiss√£o e Data de Validade.');
    return;
  }
  
  if (new Date(dataValidade) < new Date(dataEmissao)) {
    alert('A data de validade n√£o pode ser anterior √† data de emiss√£o.');
    return;
  }
  
  const receitaData = {
    medico,
    paciente,
    medicamentos: document.getElementById('receitaMedicamentos').value.trim(),
    dataEmissao,
    dataValidade,
    observacoes: document.getElementById('receitaObservacoes').value.trim(),
    foto: document.getElementById('receitaFotoPreview').src || ''
  };
  
  const editId = document.getElementById('modalReceita').getAttribute('data-edit-id');
  
  if (editId) {
    // Edi√ß√£o
    const idx = receitas.findIndex(r => r.id === editId);
    if (idx > -1) {
      receitas[idx] = { ...receitas[idx], ...receitaData };
    }
  } else {
    // Nova receita
    receitas.push({
      id: uid(),
      ...receitaData,
      criadoEm: new Date().toISOString()
    });
  }
  
  localStorage.setItem(LS_RECEITAS, JSON.stringify(receitas));
  renderReceitas();
  document.getElementById('modalReceita').classList.remove('open');
  
  if (narrarEnabled()) speak('Receita salva com sucesso.');
}

function editarReceita(recId) {
  openReceitaModal(recId);
}

function excluirReceita(recId) {
  if (confirm('Excluir esta receita?')) {
    receitas = receitas.filter(r => r.id !== recId);
    localStorage.setItem(LS_RECEITAS, JSON.stringify(receitas));
    renderReceitas();
    if (narrarEnabled()) speak('Receita exclu√≠da.');
  }
}

// ================= FUN√á√ïES DE CONSULTAS =================
function openConsultModal(editId = null) {
  const modal = document.getElementById('modalConsult');
  
  if (editId) {
    const cons = consults.find(c => c.id === editId);
    if (cons) {
      document.getElementById('consData').value = cons.data || '';
      document.getElementById('consProf').value = cons.prof || '';
      document.getElementById('consObs').value = cons.obs || '';
    }
    modal.setAttribute('data-edit-id', editId);
  } else {
    document.getElementById('consData').value = '';
    document.getElementById('consProf').value = '';
    document.getElementById('consObs').value = '';
    modal.removeAttribute('data-edit-id');
  }
  
  modal.classList.add('open');
  if (narrarEnabled()) speak('Formul√°rio de consulta aberto.');
}

function salvarConsulta() {
  const data = document.getElementById('consData').value;
  const prof = document.getElementById('consProf').value.trim();
  
  if (!data || !prof) {
    alert('Preencha a data e o profissional/local.');
    return;
  }
  
  const obs = document.getElementById('consObs').value.trim();
  const editId = document.getElementById('modalConsult').getAttribute('data-edit-id');
  
  if (editId) {
    // Edi√ß√£o
    const idx = consults.findIndex(c => c.id === editId);
    if (idx > -1) {
      consults[idx] = {
        ...consults[idx],
        data,
        prof,
        obs
      };
    }
  } else {
    // Nova consulta
    consults.push({
      id: uid(),
      data,
      prof,
      obs,
      criadoEm: new Date().toISOString()
    });
  }
  
  saveAll();
  refreshUI();
  document.getElementById('modalConsult').classList.remove('open');
  
  if (narrarEnabled()) speak('Consulta salva com sucesso.');
}

function editarConsulta(consId) {
  openConsultModal(consId);
}

function excluirConsulta(consId) {
  if (confirm('Excluir esta consulta?')) {
    consults = consults.filter(c => c.id !== consId);
    saveAll();
    refreshUI();
    if (narrarEnabled()) speak('Consulta exclu√≠da.');
  }
}

// ================= FUN√á√ïES DO TUTORIAL =================
function initTutorial() {
  const tutorialCompleted = localStorage.getItem(LS_TUTORIAL) === 'true';
  const termsAccepted = localStorage.getItem(LS_TERMS) === '1';
  
  if (!termsAccepted) {
    document.getElementById('modalTerms').classList.add('open');
    if (narrarEnabled()) speak('Por favor, leia e aceite os termos de uso para continuar.');
  } else if (!tutorialCompleted) {
    setTimeout(() => showTutorial(), 500);
  } else {
    document.getElementById('btnHelp').style.display = 'block';
    refreshUI();
  }
}

function showTutorial() {
  document.getElementById('modalTerms').classList.remove('open');
  document.getElementById('modalTutorial').classList.add('open');
  updateTutorialStep(1);
  
  if (narrarEnabled()) {
    setTimeout(() => speak('Bem-vindo ao Meu Rem√©dio! Vamos aprender a usar o aplicativo.'), 300);
  }
}

function updateTutorialStep(step) {
  currentStep = step;
  
  document.querySelectorAll('.tutorial-step').forEach(el => {
    el.classList.add('hidden');
    el.classList.remove('active');
  });
  
  const currentStepEl = document.querySelector(`[data-step="${step}"]`);
  if (currentStepEl) {
    currentStepEl.classList.remove('hidden');
    currentStepEl.classList.add('active');
  }
  
  const btnPrev = document.getElementById('btnPrevTutorial');
  const btnNext = document.getElementById('btnNextTutorial');
  const btnSkip = document.getElementById('btnSkipTutorial');
  const btnStart = document.getElementById('btnStartApp');
  
  btnPrev.disabled = step === 1;
  
  if (step === totalSteps) {
    btnNext.style.display = 'none';
    btnSkip.style.display = 'none';
    btnStart.style.display = 'block';
  } else {
    btnNext.style.display = 'block';
    btnSkip.style.display = 'block';
    btnStart.style.display = 'none';
  }
  
  if (narrarEnabled()) readTutorialStep(step);
}

function readTutorialStep(step) {
  const messages = {
    1: 'Passo 1: Narrador de voz. O aplicativo fala com voc√™! Deixe o narrador sempre ligado.',
    2: 'Passo 2: Comandos por voz. Use o bot√£o Preencher por voz para cadastrar rem√©dios falando.',
    3: 'Passo 3: Lembretes autom√°ticos. O app avisa na hora certa de tomar seus rem√©dios!',
    4: 'Passo 4: Bot√µes com s√≠mbolos. Use os s√≠mbolos para navegar no aplicativo.'
  };
  
  setTimeout(() => speak(messages[step] || `Passo ${step} de ${totalSteps}`), 500);
}

function completeTutorial() {
  const dontShowAgain = document.getElementById('dontShowAgain');
  if (dontShowAgain && dontShowAgain.checked) {
    localStorage.setItem(LS_TUTORIAL, 'true');
  }
  
  document.getElementById('modalTutorial').classList.remove('open');
  document.getElementById('btnHelp').style.display = 'block';
  refreshUI();
  
  if (narrarEnabled()) speak('Tutorial conclu√≠do! Agora voc√™ pode usar o Meu Rem√©dio.');
}

function demovoiceCommand() {
  if (narrarEnabled()) speak('Experimente dizer: Paracetamol, para cadastrar um medicamento.');
}

function showQuickHelp() {
  if (narrarEnabled()) {
    speak(`Ajuda r√°pida: Use o bot√£o de microfone para cadastrar por voz, toque em Tomei quando tomar o rem√©dio, e use Alarme para lembretes.`);
  } else {
    alert(`üìã AJUDA R√ÅPIDA\n\nüéôÔ∏è VOZ: Cadastre rem√©dios falando\n‚úÖ TOMEI: Marque quando tomar\n‚è∞ ALARME: Lembretes sonoros\n‚úèÔ∏è ADICIONAR: Cadastro manual`);
  }
}

// ================= CONFIGURA√á√ÉO DE EVENT LISTENERS =================
function configurarEventListeners() {
  // Bot√µes principais
  document.getElementById('btnAddMed').onclick = () => openMedModal();
  document.getElementById('btnAddReceita').onclick = () => openReceitaModal();
  document.getElementById('btnAddConsult').onclick = () => openConsultModal();
  document.getElementById('btnAlarm').onclick = () => document.getElementById('modalNotifSettings').classList.add('open');
  document.getElementById('btnVoiceFlow').onclick = () => iniciarFluxoVoz();
  document.getElementById('btnExport').onclick = exportarDados;
  document.getElementById('btnImport').onclick = importarDados;
  document.getElementById('btnClearHist').onclick = limparHistorico;
  document.getElementById('notificationStatus').onclick = () => document.getElementById('modalNotifSettings').classList.add('open');
  
  // Bot√µes de fechar modais
  document.getElementById('btnCancelMed').onclick = () => document.getElementById('modalMed').classList.remove('open');
  document.getElementById('btnCancelReceita').onclick = () => document.getElementById('modalReceita').classList.remove('open');
  document.getElementById('btnCancelCons').onclick = () => document.getElementById('modalConsult').classList.remove('open');
  document.getElementById('btnCancelNotif').onclick = () => document.getElementById('modalNotifSettings').classList.remove('open');
  
  // Bot√µes de salvar
  document.getElementById('btnSaveMed').onclick = salvarMedicamento;
  document.getElementById('btnSaveReceita').onclick = salvarReceita;
  document.getElementById('btnSaveCons').onclick = salvarConsulta;
  
  // Tutorial
  document.getElementById('btnAcceptTerms').onclick = aceitarTermos;
  document.getElementById('btnReadTerms').onclick = lerTermos;
  document.getElementById('btnNextTutorial').onclick = () => currentStep < totalSteps && updateTutorialStep(currentStep + 1);
  document.getElementById('btnPrevTutorial').onclick = () => currentStep > 1 && updateTutorialStep(currentStep - 1);
  document.getElementById('btnSkipTutorial').onclick = completeTutorial;
  document.getElementById('btnStartApp').onclick = completeTutorial;
  document.getElementById('btnHelp').onclick = showQuickHelp;
  
  // Upload de fotos
  document.getElementById('medFotoInput').addEventListener('change', handleFotoUpload);
  document.getElementById('receitaFotoInput').addEventListener('change', handleReceitaFotoUpload);
  document.getElementById('btnRemoverFoto').onclick = () => removerFoto('med');
  document.getElementById('btnRemoverFotoReceita').onclick = () => removerFoto('receita');
  
  // Fechar modais clicando fora
  document.querySelectorAll('.modal').forEach(modal => {
    modal.onclick = (e) => {
      if (e.target === modal) modal.classList.remove('open');
    };
  });
}

function aceitarTermos() {
  localStorage.setItem(LS_TERMS, "1");
  document.getElementById("modalTerms").classList.remove("open");
  if (narrarEnabled()) speak('Termos aceitos com sucesso.');
  setTimeout(() => showTutorial(), 800);
}

function lerTermos() {
  if (narrarEnabled()) {
    speak(`Termos de Uso: Suas informa√ß√µes ficam apenas no seu dispositivo. Nada √© enviado sem sua permiss√£o. Este app √© um aux√≠lio e n√£o substitui o m√©dico.`);
  } else {
    alert("üìú Termos de Uso\n\nSeus dados ficam apenas no seu dispositivo.\nNada √© enviado sem sua permiss√£o.\n√â um aux√≠lio, n√£o substitui o m√©dico.");
  }
}

function handleFotoUpload(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('medFotoPreview').src = e.target.result;
      document.getElementById('medFotoPreview').classList.remove('hidden');
      document.getElementById('btnRemoverFoto').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
}

function handleReceitaFotoUpload(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('receitaFotoPreview').src = e.target.result;
      document.getElementById('receitaFotoPreview').classList.remove('hidden');
      document.getElementById('btnRemoverFotoReceita').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
}

function removerFoto(tipo) {
  if (tipo === 'med') {
    document.getElementById('medFotoInput').value = '';
    document.getElementById('medFotoPreview').src = '';
    document.getElementById('medFotoPreview').classList.add('hidden');
    document.getElementById('btnRemoverFoto').classList.add('hidden');
  } else {
    document.getElementById('receitaFotoInput').value = '';
    document.getElementById('receitaFotoPreview').src = '';
    document.getElementById('receitaFotoPreview').classList.add('hidden');
    document.getElementById('btnRemoverFotoReceita').classList.add('hidden');
  }
}

// ================= FUN√á√ïES A IMPLEMENTAR =================
function iniciarFluxoVoz() {
  if (narrarEnabled()) speak('Funcionalidade de voz em desenvolvimento.');
  else alert('Funcionalidade de voz em desenvolvimento.');
}

function exportarDados() {
  const dados = { meds, hist, consults, receitas };
  const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'meu_remedio_dados.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importarDados() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const dados = JSON.parse(e.target.result);
        if (dados.meds) meds = dados.meds;
        if (dados.hist) hist = dados.hist;
        if (dados.consults) consults = dados.consults;
        if (dados.receitas) receitas = dados.receitas;
        saveAll();
        refreshUI();
        alert('Dados importados com sucesso!');
      } catch (err) {
        alert('Erro ao importar dados: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function limparHistorico() {
  if (confirm('Tem certeza que deseja limpar o hist√≥rico?')) {
    hist = [];
    saveAll();
    refreshUI();
    if (narrarEnabled()) speak('Hist√≥rico limpo.');
  }
}

// ================= INICIALIZA√á√ÉO =================
document.addEventListener("DOMContentLoaded", () => {
  // Restaurar configura√ß√µes
  const savedTextSize = localStorage.getItem('textSize');
  if (savedTextSize) document.body.style.fontSize = savedTextSize;
  
  // Configurar event listeners
  configurarEventListeners();
  
  // Inicializar sistemas
  initTutorial();
  
  console.log('‚úÖ Aplica√ß√£o inicializada com sucesso');
});
// ================= SISTEMA DE NOTIFICA√á√ïES CONFI√ÅVEL =================
class NotificationManager {
  constructor() {
    this.permission = null;
    this.init();
  }

  async init() {
    this.permission = Notification.permission;
    await this.setupEventListeners();
  }

  async setupEventListeners() {
    // Listener para mensagens do Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', this.handleServiceWorkerMessage.bind(this));
    }
  }

  handleServiceWorkerMessage(event) {
    const { type, medId, alarmId, newTime } = event.data;

    switch (type) {
      case 'MEDICATION_TAKEN':
        alarmManager.marcarComoTomado(medId);
        break;
      case 'RESCHEDULE_ALARM':
        this.handleReschedule(medId, newTime, alarmId);
        break;
      case 'SYNC_ALARMS':
        this.syncAlarms();
        break;
      case 'PLAY_SOUND':
        this.playNotificationSound();
        break;
    }
  }

  handleReschedule(medId, newTime, alarmId) {
    const med = meds.find(m => m.id === medId);
    if (med) {
      // Cancelar alarme anterior
      alarmManager.cancelAlarm(alarmId);
      // Agendar novo alarme
      alarmManager.scheduleAlarm(med, newTime);
      
      // Mostrar confirma√ß√£o
      this.showToast('‚è∞ Lembrete adiado por 10 minutos');
    }
  }

  async syncAlarms() {
    console.log('üîÑ Sincronizando alarmes...');
    alarmManager.cleanupExpiredAlarms();
    
    // Reagendar todos os medicamentos ativos
    meds.forEach(med => {
      if (med.hora && med.ativo !== false) {
        alarmManager.scheduleAlarm(med);
      }
    });
  }

  playNotificationSound() {
    if (notifSettings.soundEnabled) {
      // Criar som de notifica√ß√£o simples
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }
  }

  showToast(message, duration = 3000) {
    // Implementa√ß√£o de toast notification
    const toast = document.createElement('div');
    toast.style.cssText = \`
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
    \`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Anima√ß√£o de entrada
    setTimeout(() => toast.style.opacity = '1', 10);
    
    // Remover ap√≥s dura√ß√£o
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, duration);
  }

  async requestPermission() {
    if (!('Notification' in window)) {
      throw new Error('Notifica√ß√µes n√£o suportadas');
    }

    if (this.permission === 'granted') {
      return true;
    }

    // Solicitar permiss√£o com contexto
    const result = await Notification.requestPermission();
    this.permission = result;
    
    if (result === 'granted') {
      await this.setupPeriodicSync();
      this.showToast('üîî Notifica√ß√µes ativadas com sucesso!');
      return true;
    } else {
      throw new Error('Permiss√£o de notifica√ß√£o negada');
    }
  }

  async setupPeriodicSync() {
    if ('periodicSync' in window && 'serviceWorker' in navigator) {
      try {
        const registration = await navigator.serviceWorker.ready;
        await registration.periodicSync.register('medication-reminders', {
          minInterval: 24 * 60 * 60 * 1000 // 1 dia
        });
        console.log('‚úÖ Periodic Sync registrado');
      } catch (error) {
        console.log('‚ö†Ô∏è Periodic Sync n√£o suportado:', error);
      }
    }

    // Fallback: usar alarmes offline
    this.syncAlarms();
  }

  getNextAlarmsHTML(limit = 5) {
    const nextAlarms = alarmManager.getNextAlarms(limit);
    
    if (nextAlarms.length === 0) {
      return '<div class="no-alarms">Nenhum alarme agendado</div>';
    }

    return nextAlarms.map(alarm => \`
      <div class="alarm-item">
        <div class="alarm-time">
          üïí \${alarm.time.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
        </div>
        <div class="alarm-info">
          <strong>\${alarm.med.nome}</strong>
          <span>\${alarm.med.paciente}</span>
          \${alarm.med.instrucao ? \`<small>\${alarm.med.instrucao}</small>\` : ''}
        </div>
        <button onclick="alarmManager.cancelAlarm('\${alarm.alarmId}')" class="btn-cancel">
          ‚ùå
        </button>
      </div>
    \`).join('');
  }
}

// Inst√¢ncia global do gerenciador de notifica√ß√µes
const notificationManager = new NotificationManager();
    // ================= SISTEMA DE ALARMES OFFLINE MELHORADO =================
const alarmStorageKey = 'meu_remedio_alarms_v3';

class AlarmManager {
  constructor() {
    this.alarms = new Map();
    this.loadAlarms();
  }

  loadAlarms() {
    try {
      const stored = JSON.parse(localStorage.getItem(alarmStorageKey) || '{}');
      this.alarms = new Map(Object.entries(stored));
      console.log(`üìã ${this.alarms.size} alarmes carregados`);
    } catch (error) {
      console.error('Erro ao carregar alarmes:', error);
      this.alarms = new Map();
    }
  }

  saveAlarms() {
    try {
      const obj = Object.fromEntries(this.alarms);
      localStorage.setItem(alarmStorageKey, JSON.stringify(obj));
    } catch (error) {
      console.error('Erro ao salvar alarmes:', error);
    }
  }

  scheduleAlarm(med, customTime = null) {
    if (!med.hora || med.ativo === false) return null;

    const alarmTime = this.calculateAlarmTime(med, customTime);
    if (!alarmTime) return null;

    const alarmId = `med_${med.id}_${alarmTime.getTime()}`;
    
    const alarmData = {
      id: alarmId,
      time: alarmTime.toISOString(),
      title: 'üíä Hora do Rem√©dio',
      body: this.formatNotificationBody(med),
      medId: med.id,
      timestamp: Date.now()
    };

    // Agendar no Service Worker
    this.sendToServiceWorker(alarmData);
    
    // Armazenar localmente
    this.alarms.set(alarmId, alarmData);
    this.saveAlarms();

    console.log(`‚è∞ Alarme agendado: ${med.nome} √†s ${alarmTime.toLocaleTimeString('pt-BR')}`);
    return alarmId;
  }

  calculateAlarmTime(med, customTime = null) {
    if (customTime) {
      return new Date(customTime);
    }

    const [hours, minutes] = med.hora.split(':').map(Number);
    const now = new Date();
    const alarmTime = new Date();
    
    alarmTime.setHours(hours, minutes, 0, 0);
    
    // Se o hor√°rio j√° passou hoje, agenda para amanh√£
    if (alarmTime <= now) {
      alarmTime.setDate(alarmTime.getDate() + 1);
    }

    return alarmTime;
  }

  formatNotificationBody(med) {
    let body = `${med.nome} - ${med.paciente}`;
    if (med.instrucao) body += ` (${med.instrucao})`;
    if (med.dosagem) body += ` - ${med.dosagem}`;
    return body;
  }

  sendToServiceWorker(alarmData) {
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'SCHEDULE_ALARM',
        ...alarmData
      });
    } else {
      console.warn('Service Worker n√£o dispon√≠vel para agendar alarme');
      this.scheduleFallbackAlarm(alarmData);
    }
  }

  scheduleFallbackAlarm(alarmData) {
    const now = Date.now();
    const targetTime = new Date(alarmData.time).getTime();
    const timeout = targetTime - now;

    if (timeout > 0 && timeout < 24 * 60 * 60 * 1000) { // M√°ximo 24 horas
      setTimeout(() => {
        this.showFallbackNotification(alarmData);
      }, timeout);
    }
  }

  showFallbackNotification(alarmData) {
    if ('Notification' in window && Notification.permission === 'granted') {
      const notification = new Notification(alarmData.title, {
        body: alarmData.body,
        icon: '/icon-192.png',
        tag: alarmData.id,
        requireInteraction: true
      });

      notification.onclick = () => {
        this.handleNotificationClick(alarmData.medId, 'tomei');
        notification.close();
      };
    }
  }

  handleNotificationClick(medId, action) {
    if (action === 'tomei') {
      this.marcarComoTomado(medId);
    }
  }

  marcarComoTomado(medId) {
    const med = meds.find(m => m.id === medId);
    if (med) {
      // Registrar no hist√≥rico
      const historico = JSON.parse(localStorage.getItem('meuRemedio_historico') || '[]');
      historico.push({
        id: uid(),
        medId: med.id,
        medicamento: med.nome,
        paciente: med.paciente,
        data: new Date().toISOString(),
        tipo: 'medicamento',
        status: 'tomado'
      });
      localStorage.setItem('meuRemedio_historico', JSON.stringify(historico));
      
      // Reagendar para o pr√≥ximo dia
      this.rescheduleMedication(med);
      
      console.log(`‚úÖ ${med.nome} marcado como tomado`);
    }
  }

  rescheduleMedication(med) {
    // Cancelar alarme atual
    this.cancelAlarmsForMed(med.id);
    
    // Agendar para amanh√£
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const newAlarmId = this.scheduleAlarm(med);
    
    return newAlarmId;
  }

  cancelAlarmsForMed(medId) {
    for (const [alarmId, alarmData] of this.alarms) {
      if (alarmData.medId === medId) {
        this.cancelAlarm(alarmId);
      }
    }
  }

  cancelAlarm(alarmId) {
    this.alarms.delete(alarmId);
    this.saveAlarms();
    
    // Notificar Service Worker
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'CANCEL_ALARM',
        alarmId: alarmId
      });
    }
  }

  cleanupExpiredAlarms() {
    const now = Date.now();
    let cleaned = 0;

    for (const [alarmId, alarmData] of this.alarms) {
      const alarmTime = new Date(alarmData.time).getTime();
      if (alarmTime < now - 60 * 60 * 1000) { // Alarmes com mais de 1 hora
        this.alarms.delete(alarmId);
        cleaned++;
      }
    }

    if (cleaned > 0) {
      this.saveAlarms();
      console.log(`üßπ ${cleaned} alarmes expirados removidos`);
    }
  }

  getNextAlarms(limit = 5) {
    const now = new Date();
    const upcoming = [];

    for (const alarmData of this.alarms.values()) {
      const alarmTime = new Date(alarmData.time);
      if (alarmTime > now) {
        const med = meds.find(m => m.id === alarmData.medId);
        if (med) {
          upcoming.push({
            time: alarmTime,
            med: med,
            alarmId: alarmData.id
          });
        }
      }
    }

    return upcoming
      .sort((a, b) => a.time - b.time)
      .slice(0, limit);
  }
}

// Inst√¢ncia global do gerenciador de alarmes
const alarmManager = new AlarmManager();
</script>
</body>
</html>
