<!doctype html> 
<html lang="pt-BR"> 
<head> 
<meta charset="utf-8" /> 
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" /> 
<title>Meu Rem√©dio</title> 
<!-- PWA Meta Tags -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00796b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Meu Rem√©dio">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Preload critical resources -->
<link rel="preload" href="icon-192.png" as="image">
<link rel="preload" href="icon-512.png" as="image">

<!-- Register Service Worker -->
<script>
// Registrar Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/service-worker.js')
      .then(function(registration) {
        console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
        
        // Verificar atualiza√ß√µes
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('üîÑ Nova vers√£o do Service Worker encontrada');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Nova vers√£o dispon√≠vel!
              if(confirm('Nova vers√£o dispon√≠vel! Atualizar agora?')) {
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(function(error) {
        console.log('‚ùå Falha no registro do Service Worker:', error);
      });
  });

  // Ouvir mensagens do Service Worker
  navigator.serviceWorker.addEventListener('message', event => {
    const { type, data } = event.data;
    
    switch(type) {
      case 'CHECK_PENDING_ALARMS':
        checkPendingAlarms();
        break;
      case 'CHECK_MEDICATION_TIMES':
        checkMedicationTimes(data.currentTime);
        break;
      case 'NOTIFICATION_CLICKED':
        handleNotificationClick(data);
        break;
    }
  });
}

// Fun√ß√£o para verificar hor√°rios de medicamentos
function checkMedicationTimes(currentTime) {
  const meds = JSON.parse(localStorage.getItem('meu_remedio_med_photos_v2') || '[]');
  meds.forEach(med => {
    if (med.hora === currentTime) {
      // Disparar notifica√ß√£o local
      if('Notification' in window && Notification.permission === 'granted') {
        new Notification('üíä Hora do Rem√©dio', {
          body: `${med.paciente ? med.paciente + ' - ' : ''}${med.nome}`,
          icon: 'icon-192.png',
          requireInteraction: true
        });
      }
    }
  });
}
</script>

<style> 
/* Responsive, touch-first, optimized for small screens (>=320px) */
:root{ --blue:#0077b6; --green:#2e7d32; --accent:#013233; --bg:#fbfdfc; --card:#fff; --muted:#6c7a7a; --shadow:0 6px 18px rgba(2,48,60,0.08); --gap:12px; --radius:12px; }
*{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased} header{background:linear-gradient(90deg,var(--blue),var(--green));color:white;padding:14px 12px;text-align:center;font-size:18px;font-weight:800;border-bottom-left-radius:14px;border-bottom-right-radius:14px;position:sticky;top:0;z-index:20} .app{max-width:920px;margin:10px auto;padding:12px} .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px} @media (max-width:720px){ .controls{grid-template-columns:1fr} } .btn-primary{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--blue),var(--green));color:white;font-weight:700;font-size:15px;box-shadow:var(--shadow);width:100%} .btn-small{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--blue),var(--green));color:white;font-weight:700;cursor:pointer} .btn-ghost{padding:8px 10px;border-radius:10px;border:1px solid #e6f3f0;background:transparent;color:var(--accent);cursor:pointer} .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);margin-bottom:12px} .flex{display:flex;gap:8px;align-items:center} .flex-space{display:flex;justify-content:space-between;align-items:center} h2{margin:0;color:var(--blue);font-size:16px} .small{font-size:13px;color:var(--muted);margin-top:6px} .table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px} .table th,.table td{padding:8px;border-bottom:1px solid #eef6f1;text-align:left} .table th{font-weight:700;color:#0a3b4a} .footer{position:fixed;left:0;right:0;bottom:0;height:56px;background:linear-gradient(90deg,var(--blue),var(--green));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;border-top-left-radius:12px;border-top-right-radius:12px;z-index:10}

/* modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;padding:12px}
.modal.open{display:flex}
.modal-content{width:100%;max-width:680px;background:#fff;border-radius:12px;padding:16px;max-height:92vh;overflow:auto}
.form-row{margin-bottom:10px}
label{display:block;font-weight:700;margin-bottom:6px}
input[type="text"], input[type="time"], input[type="date"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e8f1ef;font-size:15px}
.history-item{background:#f6fffb;padding:10px;border-radius:8px;margin-bottom:8px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.kv{font-size:13px;color:#4a5a5a}
.pill-img{width:56px;height:40px;object-fit:cover;border-radius:8px;border:1px solid #e6f3f0}
.small-note{font-size:12px;color:#667}
.hidden{display:none}
.input-file-wrapper{display:flex;gap:8px;align-items:center}
.status-online, .status-offline {padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
.status-online{background:#e8f5e8;color:#2e7d32}
.status-offline{background:#ffebee;color:#c62828}
.badge{background:var(--blue);color:white;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:700}
</style>

</head> 
<body> 
<header>üíä Meu Rem√©dio</header> 
<main class="app" role="main" aria-labelledby="mainTitle"> 
<div class="controls" role="group" aria-label="A√ß√µes principais"> 
<button id="btnAddMed" class="btn-primary" aria-haspopup="dialog">‚úèÔ∏è Adicionar</button> 
<button id="btnVoiceFlow" class="btn-primary">üéôÔ∏è Preencher por voz</button> 
<button id="btnAlarm" class="btn-primary">‚è∞ Alarme/Lembrete</button> 
</div> 

<div class="card" aria-live="polite"> 
<div class="flex-space"> 
<h2>Configura√ß√µes</h2> 
<div class="flex"> 
<label><input type="checkbox" id="toggleNarrador" checked> Narrador</label> 
<label style="margin-left:10px"><input type="checkbox" id="toggleVerboso"> Modo Verboso</label> 
</div> 
</div> 
<div class="small">Ative narrador e modo verboso para que o app leia listas e hist√≥rico automaticamente.</div> 
<div class="flex" style="margin-top:8px"> 
<span id="connectionStatus" class="status-online">‚óè Online</span> 
<span id="notificationStatus" class="status-offline" style="margin-left:8px">üîï Notifica√ß√µes</span> 
</div> 
</div> 

<section class="card" aria-labelledby="medTitle" id="medSection"> 
<div class="flex-space"> 
<h2 id="medTitle">Medicamentos <span id="medCount" class="badge">0</span></h2> 
<div class="actions"> 
<button id="btnExport" class="btn-small">‚¨á Exportar</button> 
<button id="btnImport" class="btn-small">‚¨Ü Importar</button> 
</div> 
</div>
<table class="table" id="tblMeds" aria-describedby="Lista de medicamentos">
  <thead><tr><th>Foto</th><th>Paciente</th><th>Medicamento</th><th>Instru√ß√£o</th><th>Hora</th><th>A√ß√µes</th></tr></thead>
  <tbody></tbody>
</table>
<div id="emptyMeds" class="small">Nenhum medicamento cadastrado.</div>
</section> 

<section class="card" id="histSection"> 
<div class="flex-space"> 
<h2>Hist√≥rico (doses tomadas) <span id="histCount" class="badge">0</span></h2> 
<div class="actions"><button id="btnClearHist" class="btn-ghost">Limpar hist√≥rico</button></div> 
</div> 
<div id="histList" style="margin-top:10px"></div> 
</section> 

<section class="card" id="consultSection"> 
<div class="flex-space"> 
<h2>Consultas <span id="consCount" class="badge">0</span></h2> 
<div class="actions"><button id="btnAddConsult" class="btn-small">‚ûï Nova consulta</button></div> 
</div>
<table class="table" id="tblConsults">
  <thead><tr><th>Data</th><th>Profissional / Local</th><th>Observa√ß√£o</th><th>A√ß√µes</th></tr></thead>
  <tbody></tbody>
</table>
<div id="emptyConsults" class="small">Nenhuma consulta cadastrada.</div>
</section> 
</main> 

<div class="footer">Meu Rem√©dio ‚Äî Privado & Local</div> 

<!-- Modal: Medicamento Add/Edit --> 
<div id="modalMed" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMedTitle"> 
<div class="modal-content"> 
<h3 id="modalMedTitle">Adicionar medicamento</h3>
<div class="form-row">
  <label for="medPaciente">Paciente</label>
  <input id="medPaciente" type="text" placeholder="Nome do paciente">
</div>
<div class="form-row">
  <label for="medNome">Medicamento *</label>
  <input id="medNome" type="text" placeholder="Ex: Paracetamol">
</div>
<div class="form-row">
  <label for="medInstr">Instru√ß√£o</label>
  <input id="medInstr" type="text" placeholder="Ex: a cada 8h">
</div>
<div class="form-row">
  <label for="medHora">Hora inicial *</label>
  <input id="medHora" type="time">
</div>
<div class="form-row">
  <label>Foto do medicamento</label>
  <div class="input-file-wrapper">
    <input id="medFotoInput" type="file" accept="image/*" capture="environment">
    <img id="medFotoPreview" class="pill-img hidden" alt="pr√©via">
    <button id="btnRemoverFoto" class="btn-ghost hidden" type="button">Remover foto</button>
  </div>
  <div class="small-note">Use a c√¢mera para capturar o frasco ou a caixa (opcional).</div>
</div>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
  <button id="btnCancelMed" class="btn-ghost">Cancelar</button>
  <button id="btnSaveMed" class="btn-small">Salvar</button>
</div>
</div> 
</div> 

<!-- Modal: Consultas Add/Edit --> 
<div id="modalConsult" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalConsultTitle"> 
<div class="modal-content"> 
<h3 id="modalConsultTitle">Nova consulta</h3> 
<div class="form-row"><label for="consData">Data *</label><input id="consData" type="date"></div> 
<div class="form-row"><label for="consProf">Profissional / Local *</label><input id="consProf" type="text" placeholder="Ex: Dr. Fulano - Cardiologia"></div> 
<div class="form-row"><label for="consObs">Observa√ß√£o</label><textarea id="consObs" rows="3" placeholder="Observa√ß√µes"></textarea></div> 
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"> 
<button id="btnCancelCons" class="btn-ghost">Cancelar</button> 
<button id="btnSaveCons" class="btn-small">Salvar</button> 
</div> 
</div> 
</div> 

<!-- Modal: Configura√ß√µes de Notifica√ß√£o -->
<div id="modalNotifSettings" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalNotifTitle">
<div class="modal-content">
<h3 id="modalNotifTitle">‚öôÔ∏è Configura√ß√µes de Notifica√ß√£o</h3>
<div class="form-row">
  <label><input type="checkbox" id="notifMedEnabled" checked> Ativar lembretes de medicamentos</label>
</div>
<div class="form-row">
  <label><input type="checkbox" id="notifConsEnabled" checked> Ativar lembretes de consultas</label>
</div>
<div class="form-row">
  <label><input type="checkbox" id="notifSoundEnabled" checked> Som nas notifica√ß√µes</label>
</div>
<div class="form-row">
  <label for="notifAdvanceTime">Anteced√™ncia (minutos)</label>
  <select id="notifAdvanceTime">
    <option value="0">No hor√°rio exato</option>
    <option value="5">5 minutos antes</option>
    <option value="10">10 minutos antes</option>
    <option value="15" selected>15 minutos antes</option>
    <option value="30">30 minutos antes</option>
  </select>
</div>
<div class="small-note" style="margin-top:12px">
  <strong>Pr√≥ximos alarmes:</strong><br>
  <div id="nextAlarmsList"></div>
</div>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
  <button id="btnCancelNotif" class="btn-ghost">Fechar</button>
  <button id="btnTestNotif" class="btn-small">Testar Notifica√ß√£o</button>
</div>
</div>
</div>

<!-- Modal: Termos de Uso (bloqueante) --> 
<div id="modalTerms" class="modal open" role="dialog" aria-modal="true" aria-labelledby="termsTitle"> 
<div class="modal-content"> 
<h3 id="termsTitle">üìú Termos de Uso</h3> 
<div style="line-height:1.5;margin-top:8px"> 
Ao utilizar este app, voc√™ concorda que as informa√ß√µes inseridas (nomes, hor√°rios, fotos) ser√£o armazenadas apenas no seu dispositivo (localStorage). Nenhum dado √© enviado sem seu consentimento. Este app √© um aux√≠lio e n√£o substitui orienta√ß√£o m√©dica. 
</div> 
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"> 
<button id="btnReadTerms" class="btn-ghost">üîä Ouvir termos</button> 
<button id="btnAcceptTerms" class="btn-small">Aceitar</button> 
</div> 
</div> 
</div> 

<script>
/* ================= Storage keys & state ================= */
const LS_MED = 'meu_remedio_med_photos_v2';
const LS_HIST = 'meu_remedio_hist_v2';
const LS_CONS = 'meu_remedio_consults_v2';
const LS_TERMS = 'meu_remedio_termos_v2';
const LS_NOTIF_SETTINGS = 'meu_remedio_notif_settings_v2';

let meds = JSON.parse(localStorage.getItem(LS_MED) || '[]');
let hist = JSON.parse(localStorage.getItem(LS_HIST) || '[]');
let consults = JSON.parse(localStorage.getItem(LS_CONS) || '[]');
const notifSettings = JSON.parse(localStorage.getItem(LS_NOTIF_SETTINGS) || '{"medEnabled":true,"consEnabled":true,"soundEnabled":true,"advanceTime":15}');

const scheduledTimers = new Map();
let isOnline = navigator.onLine;

function uid(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

function esc(s){
  if(!s) return '';
  return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[c]);
}

function saveAll(){
  localStorage.setItem(LS_MED, JSON.stringify(meds));
  localStorage.setItem(LS_HIST, JSON.stringify(hist));
  localStorage.setItem(LS_CONS, JSON.stringify(consults));
  localStorage.setItem(LS_NOTIF_SETTINGS, JSON.stringify(notifSettings));
}

/* ================= Melhorias de Data/Hora PT-BR ================= */
function formatarDataHoraPTBR(date, includeTime = true) {
  const options = {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    ...(includeTime && {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    })
  };
  
  return new Intl.DateTimeFormat('pt-BR', options).format(date);
}

function formatarDataPTBR(dateString) {
  const date = new Date(dateString + 'T00:00:00');
  return formatarDataHoraPTBR(date, false);
}

function calcularProximaHora(horaStr, dias = 0) {
  const [hh, mm] = horaStr.split(':').map(n => parseInt(n, 10));
  const next = new Date();
  next.setHours(hh, mm, 0, 0);
  next.setDate(next.getDate() + dias);
  
  // Se j√° passou do hor√°rio hoje, agenda para amanh√£
  if (next <= new Date()) {
    next.setDate(next.getDate() + 1);
  }
  
  return next;
}

function parseHoraFromFala(texto) {
  // Suporte a formatos: "8:30", "08:30", "8 horas e 30", "8h30", "20h15"
  const regex = /(\d{1,2})[:h\s]?\s?(\d{1,2})?/;
  const match = texto.match(regex);
  
  if (match) {
    let hora = parseInt(match[1], 10);
    let minuto = match[2] ? parseInt(match[2], 10) : 0;
    
    // Valida√ß√µes
    if (hora < 0 || hora > 23) hora = new Date().getHours();
    if (minuto < 0 || minuto > 59) minuto = 0;
    
    return `${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`;
  }
  
  return null;
}

/* ================= Narrador & Recognition ================= */
function narrarEnabled(){
  return document.getElementById('toggleNarrador').checked;
}

function verboEnabled(){
  return document.getElementById('toggleVerboso').checked;
}

function speak(text){
  if(!narrarEnabled()) return;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'pt-BR';
    u.rate = 1;
    window.speechSynthesis.speak(u);
  }catch(e){
    console.warn('Erro s√≠ntese de voz:', e);
  }
}

let recognition = null;
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'pt-BR';
  recognition.continuous = false;
  recognition.interimResults = false;
}

async function safeVoice(prompt){
  if(!recognition){
    alert('Reconhecimento de voz n√£o suportado neste navegador.');
    return null;
  }
  
  if(narrarEnabled()) speak(prompt);
  
  await new Promise(r=>{
    let waited=0;
    const iv=setInterval(()=>{
      if(!window.speechSynthesis.speaking || waited>2500){
        clearInterval(iv);
        r();
      }
      waited+=200;
    },200);
  });
  
  return new Promise((resolve)=>{
    recognition.start();
    recognition.onresult = e => {
      const t = e.results[0][0].transcript.trim();
      if(narrarEnabled()) speak('Voc√™ disse: ' + t);
      recognition.onresult = null;
      recognition.onerror = null;
      resolve(t);
    };
    recognition.onerror = ev => {
      if(narrarEnabled()) speak('N√£o entendi.');
      recognition.onresult = null;
      recognition.onerror = null;
      resolve(null);
    };
  });
}

/* ================= Sistema Melhorado de Notifica√ß√µes ================= */
async function ensureNotificationPermission(){
  if(!('Notification' in window)) {
    updateNotificationStatus('unsupported');
    return false;
  }
  
  if(Notification.permission === 'granted') {
    updateNotificationStatus('granted');
    return true;
  }
  
  try{
    const p = await Notification.requestPermission();
    const granted = p === 'granted';
    updateNotificationStatus(granted ? 'granted' : 'denied');
    return granted;
  }catch(e){
    updateNotificationStatus('denied');
    return false;
  }
}

function updateNotificationStatus(status){
  const elem = document.getElementById('notificationStatus');
  if(!elem) return;
  
  switch(status){
    case 'granted':
      elem.innerHTML = 'üîî Notifica√ß√µes Ativas';
      elem.className = 'status-online';
      break;
    case 'denied':
      elem.innerHTML = 'üîï Notifica√ß√µes Bloqueadas';
      elem.className = 'status-offline';
      break;
    case 'unsupported':
      elem.innerHTML = '‚ùå Notif. N√£o Suportadas';
      elem.className = 'status-offline';
      break;
    default:
      elem.innerHTML = 'üîï Notifica√ß√µes';
      elem.className = 'status-offline';
  }
}

function clearScheduledNotifications(){
  for(const t of scheduledTimers.values()){
    clearTimeout(t);
  }
  scheduledTimers.clear();
}

function scheduleNotification(id, when, title, body, data = {}){
  const advanceTime = notifSettings.advanceTime * 60 * 1000; // converter para ms
  const notifyTime = new Date(when - advanceTime);
  const now = new Date();
  
  if(notifyTime <= now) return; // J√° passou do tempo
  
  const msUntilNotify = notifyTime - now;
  
  console.log(`Agendando notifica√ß√£o: ${title} para ${formatarDataHoraPTBR(notifyTime)}`);
  
  const timer = setTimeout(() => {
    showNotification(title, body, data);
    scheduledTimers.delete(id);
  }, msUntilNotify);
  
  scheduledTimers.set(id, timer);
}

function showNotification(title, body, data = {}){
  // Fallback para quando estiver offline ou Notification API n√£o dispon√≠vel
  if(!isOnline || !('Notification' in window) || Notification.permission !== 'granted'){
    showFallbackAlert(title, body);
    return;
  }
  
  try{
    const options = {
      body,
      icon: 'icon-192.png',
      badge: 'icon-192.png',
      tag: data.id, // Agrupa notifica√ß√µes similares
      requireInteraction: true,
      silent: !notifSettings.soundEnabled,
      data
    };
    
    // Tenta usar Service Worker se dispon√≠vel
    if('serviceWorker' in navigator && navigator.serviceWorker.controller){
      navigator.serviceWorker.controller.postMessage({
        type: 'notify',
        title,
        body,
        ...options
      });
    } else {
      new Notification(title, options);
    }
    
    // Feedback visual no app
    showInAppNotification(title, body);
    
  }catch(e){
    console.warn('Erro na notifica√ß√£o:', e);
    showFallbackAlert(title, body);
  }
}

function showFallbackAlert(title, body){
  // Cria um alerta visual na interface quando notifica√ß√µes n√£o est√£o dispon√≠veis
  const alertDiv = document.createElement('div');
  alertDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #ff6b6b;
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    max-width: 300px;
    animation: slideIn 0.3s ease;
  `;
  
  alertDiv.innerHTML = `
    <strong>${title}</strong><br>
    <small>${body}</small>
  `;
  
  document.body.appendChild(alertDiv);
  
  setTimeout(() => {
    alertDiv.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => alertDiv.remove(), 300);
  }, 5000);
}

function showInAppNotification(title, body){
  // Adiciona ao hist√≥rico visual na interface
  const histList = document.getElementById('histList');
  if(histList){
    const notifItem = document.createElement('div');
    notifItem.className = 'history-item';
    notifItem.style.background = '#fff3cd';
    notifItem.style.borderLeft = '4px solid #ffc107';
    
    notifItem.innerHTML = `
      <div class="kv">
        <strong>üîî ${title}</strong><br>
        <small>${body} - ${formatarDataHoraPTBR(new Date())}</small>
      </div>
    `;
    
    histList.insertBefore(notifItem, histList.firstChild);
    
    // Remove ap√≥s alguns segundos
    setTimeout(() => {
      if(notifItem.parentNode){
        notifItem.style.opacity = '0';
        notifItem.style.transition = 'opacity 0.3s';
        setTimeout(() => notifItem.remove(), 300);
      }
    }, 8000);
  }
}

function scheduleAllNotifications(){
  clearScheduledNotifications();
  
  if(!notifSettings.medEnabled && !notifSettings.consEnabled) return;
  
  // Agenda notifica√ß√µes de medicamentos
  if(notifSettings.medEnabled){
    meds.forEach(med => {
      if(med.hora){
        const nextTime = calcularProximaHora(med.hora);
        scheduleNotification(
          'med_' + med.id,
          nextTime,
          'üíä Hora do Rem√©dio',
          `${med.paciente ? med.paciente + ' - ' : ''}${med.nome}${med.instrucao ? ' - ' + med.instrucao : ''}`,
          { type: 'med', id: med.id }
        );
      }
    });
  }
  
  // Agenda notifica√ß√µes de consultas
  if(notifSettings.consEnabled){
    consults.forEach(cons => {
      const consultDate = new Date(cons.data + 'T00:00:00');
      if(isNaN(consultDate)) return;
      
      // Notifica√ß√£o no dia anterior √†s 9h
      const dayBefore = new Date(consultDate);
      dayBefore.setDate(consultDate.getDate() - 1);
      dayBefore.setHours(9, 0, 0, 0);
      
      // Notifica√ß√£o no mesmo dia √†s 8h
      const sameDay = new Date(consultDate);
      sameDay.setHours(8, 0, 0, 0);
      
      if(dayBefore > new Date()){
        scheduleNotification(
          'cons_' + cons.id + '_pre',
          dayBefore,
          'üìÖ Consulta Amanh√£',
          `${cons.prof} - ${formatarDataPTBR(cons.data)}`,
          { type: 'consult', id: cons.id }
        );
      }
      
      if(sameDay > new Date()){
        scheduleNotification(
          'cons_' + cons.id,
          sameDay,
          'üìÖ Consulta Hoje',
          `${cons.prof} - ${formatarDataPTBR(cons.data)}`,
          { type: 'consult', id: cons.id }
        );
      }
    });
  }
  
  updateNextAlarmsList();
}

function updateNextAlarmsList(){
  const listElem = document.getElementById('nextAlarmsList');
  if(!listElem) return;
  
  const nextAlarms = [];
  
  // Pr√≥ximos medicamentos (apenas os 3 mais pr√≥ximos)
  meds.filter(med => med.hora).forEach(med => {
    const nextTime = calcularProximaHora(med.hora);
    nextAlarms.push({
      time: nextTime,
      text: `üíä ${med.nome} - ${formatarDataHoraPTBR(nextTime)}`
    });
  });
  
  // Pr√≥ximas consultas (apenas as 3 mais pr√≥ximas)
  consults.forEach(cons => {
    const consultDate = new Date(cons.data + 'T00:00:00');
    if(consultDate >= new Date()){
      nextAlarms.push({
        time: consultDate,
        text: `üìÖ ${cons.prof} - ${formatarDataPTBR(cons.data)}`
      });
    }
  });
  
  // Ordena e pega os 3 mais pr√≥ximos
  nextAlarms.sort((a, b) => a.time - b.time);
  const nextThree = nextAlarms.slice(0, 3);
  
  if(nextThree.length === 0){
    listElem.innerHTML = '<em>Nenhum alarme agendado</em>';
  } else {
    listElem.innerHTML = nextThree.map(alarm => 
      `<div style="margin:4px 0;font-size:11px">${alarm.text}</div>`
    ).join('');
  }
}

/* ================= Monitoramento de Conectividade ================= */
function updateConnectionStatus(){
  const statusElem = document.getElementById('connectionStatus');
  if(!statusElem) return;
  
  if(isOnline){
    statusElem.innerHTML = '‚óè Online';
    statusElem.className = 'status-online';
  } else {
    statusElem.innerHTML = '‚óè Offline';
    statusElem.className = 'status-offline';
    speak('Aten√ß√£o: modo offline ativado. Algumas funcionalidades podem estar limitadas.');
  }
}

window.addEventListener('online', () => {
  isOnline = true;
  updateConnectionStatus();
  speak('Conex√£o restaurada.');
  scheduleAllNotifications(); // Reagenda notifica√ß√µes ao voltar online
});

window.addEventListener('offline', () => {
  isOnline = false;
  updateConnectionStatus();
  speak('Modo offline ativado.');
});

/* ================= Rendering UI ================= */
function renderMeds(){
  const tbody = document.querySelector('#tblMeds tbody');
  tbody.innerHTML = '';
  
  document.getElementById('medCount').textContent = meds.length;
  
  if(meds.length === 0){
    document.getElementById('emptyMeds').style.display = 'block';
  } else {
    document.getElementById('emptyMeds').style.display = 'none';
  }
  
  meds.forEach(m => {
    const tr = document.createElement('tr');
    const proximaHora = m.hora ? calcularProximaHora(m.hora) : null;
    
    tr.innerHTML = `
      <td>${m.foto ? `<img src="${m.foto}" class="pill-img" alt="foto">` : ''}</td>
      <td>${esc(m.paciente||'‚Äî')}</td>
      <td><strong>${esc(m.nome)}</strong></td>
      <td>${esc(m.instrucao||'‚Äî')}</td>
      <td>${m.hora||'‚Äî'}${proximaHora ? `<br><small>Pr√≥xima: ${formatarDataHoraPTBR(proximaHora)}</small>` : ''}</td>
      <td>
        <div class="actions">
          <button class="btn-small" data-id="${m.id}" data-act="tomou">‚úÖ Tomei</button>
          <button class="btn-ghost" data-id="${m.id}" data-act="editar">‚úèÔ∏è Editar</button>
          <button class="btn-ghost" data-id="${m.id}" data-act="excluir">üóëÔ∏è Excluir</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderHist(){
  const div = document.getElementById('histList');
  const countElem = document.getElementById('histCount');
  
  countElem.textContent = hist.length;
  div.innerHTML = '';
  
  if(hist.length === 0){
    div.innerHTML = '<div class="small">Nenhum registro.</div>';
    return;
  }
  
  // Mostra apenas os √∫ltimos 20 registros
  hist.slice(0, 20).forEach(h => {
    const el = document.createElement('div');
    el.className = 'history-item';
    el.innerHTML = `
      <div class="kv">
        ${formatarDataHoraPTBR(new Date(h.ts))} ‚Äî 
        <b>${esc(h.nome)}</b> 
        ${h.paciente ? '(' + esc(h.paciente) + ')' : ''}
      </div>`;
    div.appendChild(el);
  });
  
  if(hist.length > 20){
    const moreEl = document.createElement('div');
    moreEl.className = 'small';
    moreEl.style.textAlign = 'center';
    moreEl.style.marginTop = '8px';
    moreEl.textContent = `... e mais ${hist.length - 20} registros`;
    div.appendChild(moreEl);
  }
}

function renderConsults(){
  const tbody = document.querySelector('#tblConsults tbody');
  tbody.innerHTML = '';
  
  document.getElementById('consCount').textContent = consults.length;
  
  if(consults.length === 0){
    document.getElementById('emptyConsults').style.display = 'block';
    return;
  }
  
  document.getElementById('emptyConsults').style.display = 'none';
  
  consults.slice()
    .sort((a,b) => new Date(a.data) - new Date(b.data))
    .forEach(c => {
      const tr = document.createElement('tr');
      const hoje = new Date().toISOString().split('T')[0];
      const isHoje = c.data === hoje;
      const isFutura = c.data >= hoje;
      
      tr.innerHTML = `
        <td>
          ${formatarDataPTBR(c.data)}
          ${isHoje ? '<br><small style="color:#d32f2f;font-weight:bold">HOJE!</small>' : ''}
          ${!isFutura ? '<br><small style="color:#666">Realizada</small>' : ''}
        </td>
        <td>${esc(c.prof)}</td>
        <td>${esc(c.obs||'')}</td>
        <td>
          <div class="actions">
            <button class="btn-small" data-id="${c.id}" data-act="editCons">‚úèÔ∏è Editar</button>
            <button class="btn-ghost" data-id="${c.id}" data-act="delCons">üóëÔ∏è Excluir</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
}

function refreshUI(){
  renderMeds();
  renderHist();
  renderConsults();
  
  if(verboEnabled()){
    const nM = meds.length, nH = hist.length, nC = consults.length;
    speak(`Voc√™ tem ${nM} medicamentos cadastrados, ${nH} registros no hist√≥rico e ${nC} consultas pr√≥ximas.`);
  }
  
  updateNextAlarmsList();
}

/* ================= Wiring interactions ================= */
document.addEventListener('DOMContentLoaded', () => {
  // Inicializa status
  updateConnectionStatus();
  ensureNotificationPermission().then(granted => {
    if(granted) scheduleAllNotifications();
  });
  
  // Carrega configura√ß√µes de notifica√ß√£o
  document.getElementById('notifMedEnabled').checked = notifSettings.medEnabled;
  document.getElementById('notifConsEnabled').checked = notifSettings.consEnabled;
  document.getElementById('notifSoundEnabled').checked = notifSettings.soundEnabled;
  document.getElementById('notifAdvanceTime').value = notifSettings.advanceTime;
  
  // modal elements (med)
  const modalMed = document.getElementById('modalMed');
  const medPaciente = document.getElementById('medPaciente');
  const medNome = document.getElementById('medNome');
  const medInstr = document.getElementById('medInstr');
  const medHora = document.getElementById('medHora');
  const medFotoInput = document.getElementById('medFotoInput');
  const medFotoPreview = document.getElementById('medFotoPreview');
  const btnRemoverFoto = document.getElementById('btnRemoverFoto');
  const btnAddMed = document.getElementById('btnAddMed');
  const btnSaveMed = document.getElementById('btnSaveMed');
  const btnCancelMed = document.getElementById('btnCancelMed');
  
  // consult modal
  const modalConsult = document.getElementById('modalConsult');
  const consData = document.getElementById('consData');
  const consProf = document.getElementById('consProf');
  const consObs = document.getElementById('consObs');
  const btnAddConsult = document.getElementById('btnAddConsult');
  const btnSaveCons = document.getElementById('btnSaveCons');
  const btnCancelCons = document.getElementById('btnCancelCons');
  
  // notification settings modal
  const modalNotifSettings = document.getElementById('modalNotifSettings');
  const btnCancelNotif = document.getElementById('btnCancelNotif');
  const btnTestNotif = document.getElementById('btnTestNotif');
  
  // terms
  const modalTerms = document.getElementById('modalTerms');
  const btnReadTerms = document.getElementById('btnReadTerms');
  const btnAcceptTerms = document.getElementById('btnAcceptTerms');
  
  // others
  const btnVoiceFlow = document.getElementById('btnVoiceFlow');
  const btnAlarm = document.getElementById('btnAlarm');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const btnClearHist = document.getElementById('btnClearHist');
  
  let editMedId = null;
  let editConsId = null;
  
  // Terms modal
  btnReadTerms.onclick = () => speak('Bem-vinda ao Meu Rem√©dio. Seus dados ficam apenas no dispositivo. Este app n√£o substitui orienta√ß√£o m√©dica.');
  btnAcceptTerms.onclick = () => {
    localStorage.setItem(LS_TERMS, '1');
    modalTerms.classList.remove('open');
    speak('Termos aceitos.');
  };
  
  if(localStorage.getItem(LS_TERMS) === '1') modalTerms.classList.remove('open');
  
  // Open add med
  btnAddMed.onclick = () => {
    editMedId = null;
    medPaciente.value = '';
    medNome.value = '';
    medInstr.value = '';
    medHora.value = '';
    medFotoInput.value = '';
    medFotoPreview.src = '';
    medFotoPreview.classList.add('hidden');
    btnRemoverFoto.classList.add('hidden');
    modalMed.classList.add('open');
    speak('Abrindo formul√°rio de medicamento.');
  };
  
  btnCancelMed.onclick = () => modalMed.classList.remove('open');
  
  // Photo input preview
  medFotoInput.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f){
      medFotoPreview.src = '';
      medFotoPreview.classList.add('hidden');
      btnRemoverFoto.classList.add('hidden');
      return;
    }
    const reader = new FileReader();
    reader.onload = ev => {
      medFotoPreview.src = ev.target.result;
      medFotoPreview.classList.remove('hidden');
      btnRemoverFoto.classList.remove('hidden');
    };
    reader.readAsDataURL(f);
  });
  
  btnRemoverFoto.addEventListener('click', () => {
    medFotoInput.value = '';
    medFotoPreview.src = '';
    medFotoPreview.classList.add('hidden');
    btnRemoverFoto.classList.add('hidden');
  });
  
  // Save med (create or edit)
  btnSaveMed.onclick = () => {
    const nome = medNome.value.trim();
    if(!nome){
      alert('Preencha o nome do medicamento.');
      return;
    }
    
    const paciente = medPaciente.value.trim();
    const instr = medInstr.value.trim();
    const hora = medHora.value;
    
    // get photo as dataURL (if a new file chosen)
    if(medFotoInput.files && medFotoInput.files[0]){
      const f = medFotoInput.files[0];
      const reader = new FileReader();
      reader.onload = ev => {
        const fotoData = ev.target.result;
        commitMedSave({ paciente, nome, instr, hora, foto: fotoData });
      };
      reader.readAsDataURL(f);
    } else {
      // either keep existing photo when editing, or none
      const fotoExisting = editMedId ? (meds.find(x=>x.id===editMedId)?.foto || '') : '';
      commitMedSave({ paciente, nome, instr, hora, foto: fotoExisting });
    }
  };
  
  function commitMedSave({ paciente, nome, instr, hora, foto }){
    if(editMedId){
      const idx = meds.findIndex(x=>x.id===editMedId);
      if(idx > -1){
        meds[idx].paciente = paciente;
        meds[idx].nome = nome;
        meds[idx].instrucao = instr;
        meds[idx].hora = hora;
        meds[idx].foto = foto;
      }
      editMedId = null;
    } else {
      meds.push({
        id: uid(),
        paciente,
        nome,
        instrucao: instr,
        hora,
        foto,
        criadoEm: new Date().toISOString()
      });
    }
    
    saveAll();
    refreshUI();
    modalMed.classList.remove('open');
    speak(`${nome} salvo.`);
    
    ensureNotificationPermission().then(ok => {
      if(ok) scheduleAllNotifications();
    });
  }
  
  // Table meds actions delegation
  document.getElementById('tblMeds').addEventListener('click', (ev) => {
    const btn = ev.target.closest('button');
    if(!btn) return;
    
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const med = meds.find(m => m.id === id);
    if(!med) return;
    
    if(act === 'tomou'){
      hist.unshift({
        id: uid(),
        nome: med.nome,
        paciente: med.paciente,
        ts: Date.now()
      });
      saveAll();
      refreshUI();
      speak(`${med.nome} registrado como tomado.`);
    } else if(act === 'editar'){
      editMedId = med.id;
      medPaciente.value = med.paciente || '';
      medNome.value = med.nome || '';
      medInstr.value = med.instrucao || '';
      medHora.value = med.hora || '';
      
      if(med.foto){
        medFotoPreview.src = med.foto;
        medFotoPreview.classList.remove('hidden');
        btnRemoverFoto.classList.remove('hidden');
        medFotoInput.value = '';
      } else {
        medFotoPreview.src = '';
        medFotoPreview.classList.add('hidden');
        btnRemoverFoto.classList.add('hidden');
        medFotoInput.value = '';
      }
      modalMed.classList.add('open');
      speak('Editando medicamento ' + med.nome);
    } else if(act === 'excluir'){
      if(confirm('Remover este medicamento?')){
        meds = meds.filter(x => x.id !== id);
        saveAll();
        refreshUI();
        speak('Medicamento removido.');
        scheduleAllNotifications();
      }
    }
  });
  
  // Clear history
  btnClearHist.onclick = () => {
    if(confirm('Limpar hist√≥rico?')){
      hist = [];
      saveAll();
      refreshUI();
      speak('Hist√≥rico limpo.');
    }
  };
  
  // Export / Import
  btnExport.onclick = () => {
    const data = {
      meds,
      hist,
      consults,
      exportDate: new Date().toISOString(),
      version: '2.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `meu_remedio_backup_${formatarDataHoraPTBR(new Date()).replace(/[/:\\]/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(url);
    speak('Backup exportado.');
  };
  
  btnImport.onclick = () => {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'application/json';
    inp.onchange = e => {
      const f = e.target.files[0];
      if(!f) return;
      
      const r = new FileReader();
      r.onload = ev => {
        try{
          const obj = JSON.parse(ev.target.result);
          if(Array.isArray(obj.meds)) meds = obj.meds;
          if(Array.isArray(obj.hist)) hist = obj.hist;
          if(Array.isArray(obj.consults)) consults = obj.consults;
          
          saveAll();
          refreshUI();
          scheduleAllNotifications();
          speak('Dados importados.');
        }catch(err){
          alert('Arquivo inv√°lido ou corrompido.');
        }
      };
      r.readAsText(f);
    };
    inp.click();
  };
  
  /* CONSULTS CRUD */
  btnAddConsult.onclick = () => {
    editConsId = null;
    consData.value = '';
    consProf.value = '';
    consObs.value = '';
    modalConsult.classList.add('open');
    speak('Abrindo formul√°rio de consulta.');
  };
  
  btnCancelCons.onclick = () => modalConsult.classList.remove('open');
  
  btnSaveCons.onclick = () => {
    const data = consData.value;
    const prof = consProf.value.trim();
    const obs = consObs.value.trim();
    
    if(!data || !prof){
      alert('Preencha a data e o profissional/local.');
      return;
    }
    
    if(editConsId){
      const idx = consults.findIndex(c => c.id === editConsId);
      if(idx > -1){
        consults[idx].data = data;
        consults[idx].prof = prof;
        consults[idx].obs = obs;
      }
      editConsId = null;
    } else {
      consults.push({
        id: uid(),
        data,
        prof,
        obs,
        criadoEm: new Date().toISOString()
      });
    }
    
    saveAll();
    refreshUI();
    modalConsult.classList.remove('open');
    speak('Consulta salva.');
    
    ensureNotificationPermission().then(ok => {
      if(ok) scheduleAllNotifications();
    });
  };
  
  document.getElementById('tblConsults').addEventListener('click', (ev) => {
    const btn = ev.target.closest('button');
    if(!btn) return;
    
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const c = consults.find(x => x.id === id);
    if(!c) return;
    
    if(act === 'editCons'){
      editConsId = c.id;
      consData.value = c.data;
      consProf.value = c.prof;
      consObs.value = c.obs || '';
      modalConsult.classList.add('open');
      speak('Editando consulta.');
    }
    
    if(act === 'delCons'){
      if(confirm('Remover consulta?')){
        consults = consults.filter(x => x.id !== id);
        saveAll();
        refreshUI();
        speak('Consulta removida.');
        scheduleAllNotifications();
      }
    }
  });
  
  /* Configura√ß√µes de Notifica√ß√£o */
  document.getElementById('notificationStatus').onclick = () => {
    modalNotifSettings.classList.add('open');
    updateNextAlarmsList();
  };
  
  btnCancelNotif.onclick = () => modalNotifSettings.classList.remove('open');
  
  btnTestNotif.onclick = async () => {
    const granted = await ensureNotificationPermission();
    if(!granted){
      alert('Permiss√£o de notifica√ß√£o necess√°ria para testar.');
      return;
    }
    
    showNotification(
      'üîî Teste de Notifica√ß√£o',
      'Esta √© uma notifica√ß√£o de teste do Meu Rem√©dio. Funcionou!',
      { type: 'test' }
    );
    
    speak('Notifica√ß√£o de teste enviada.');
  };
  
  // Salvar configura√ß√µes de notifica√ß√£o quando alteradas
  document.getElementById('notifMedEnabled').addEventListener('change', (e) => {
    notifSettings.medEnabled = e.target.checked;
    saveAll();
    scheduleAllNotifications();
  });
  
  document.getElementById('notifConsEnabled').addEventListener('change', (e) => {
    notifSettings.consEnabled = e.target.checked;
    saveAll();
    scheduleAllNotifications();
  });
  
  document.getElementById('notifSoundEnabled').addEventListener('change', (e) => {
    notifSettings.soundEnabled = e.target.checked;
    saveAll();
  });
  
  document.getElementById('notifAdvanceTime').addEventListener('change', (e) => {
    notifSettings.advanceTime = parseInt(e.target.value, 10);
    saveAll();
    scheduleAllNotifications();
  });
  
  /* ALARM / LEMBRETE com voice assistance melhorado */
  btnAlarm.onclick = async () => {
    if(meds.length === 0){
      alert('Cadastre pelo menos um medicamento.');
      return;
    }
    
    // Pergunta qual medicamento
    let nome = meds[0].nome;
    const pick = await safeVoice('Para qual medicamento deseja criar o alarme? Diga o nome ou diga "primeiro" para usar o primeiro da lista.');
    
    if(pick){
      if(/primeiro/i.test(pick)){
        nome = meds[0].nome;
      } else {
        const found = meds.find(m => (m.nome||'').toLowerCase().includes(pick.toLowerCase()));
        if(found) nome = found.nome;
      }
    }
    
    const horaSpoken = await safeVoice('Qual hor√°rio? Diga por exemplo "oito e trinta" ou "14:45".');
    if(!horaSpoken){
      alert('Hor√°rio n√£o informado.');
      return;
    }
    
    const horaFormatada = parseHoraFromFala(horaSpoken);
    if(!horaFormatada){
      alert('N√£o entendi a hora. Tente formatos como "8:30" ou "14h45".');
      return;
    }
    
    const openAlarm = confirm(`Alarme para ${nome} √†s ${horaFormatada}. Abrir app de alarme do dispositivo? OK = Abrir (Android). Cancelar = lembrete interno.`);
    
    if(openAlarm){
      try{
        const intent = `intent://#Intent;action=android.intent.action.SET_ALARM;S.message=Tomar%20${encodeURIComponent(nome)};S.skipui=true;i.hour=${parseInt(horaFormatada.split(':')[0],10)};i.minutes=${parseInt(horaFormatada.split(':')[1],10)};end`;
        window.location.href = intent;
      }catch(e){
        alert('N√£o foi poss√≠vel abrir o app de alarme.');
      }
    } else {
      const perm = await ensureNotificationPermission();
      if(!perm){
        alert('Permiss√£o de notifica√ß√£o n√£o concedida.');
        return;
      }
      
      const when = calcularProximaHora(horaFormatada);
      scheduleNotification(
        'manual_' + uid(),
        when,
        '‚è∞ Lembrete de Medicamento',
        `Hora de tomar ${nome}`,
        { type: 'manual', nome, hora: horaFormatada }
      );
      
      speak(`Lembrete criado para ${horaFormatada}`);
      alert(`Lembrete criado para ${formatarDataHoraPTBR(when)}`);
    }
  };
  
  /* Voice guided form fill melhorado */
  btnVoiceFlow.onclick = async () => {
    const p = await safeVoice('Qual o nome do paciente?');
    if(p) medPaciente.value = p;
    
    const n = await safeVoice('Qual o nome do medicamento?');
    if(n) medNome.value = n;
    
    const instr = await safeVoice('Qual a instru√ß√£o? Por exemplo "a cada 8 horas"');
    if(instr) medInstr.value = instr;
    
    const hora = await safeVoice('Qual a hora inicial? Diga por exemplo "oito e trinta" ou "14:45".');
    if(hora){
      const horaFormatada = parseHoraFromFala(hora);
      if(horaFormatada) medHora.value = horaFormatada;
    }
    
    modalMed.classList.add('open');
    speak('Revise os dados e toque em salvar.');
  };
  
  // click outside modal to close (non-blocking ones)
  document.querySelectorAll('.modal').forEach(mod => {
    if(mod.id === 'modalTerms') return;
    
    mod.addEventListener('click', (e) => {
      if(e.target === mod){
        mod.classList.remove('open');
      }
    });
  });
  
  // initial render & schedule
  refreshUI();
  ensureNotificationPermission().then(ok => {
    if(ok) scheduleAllNotifications();
  });
  
  // Atualiza lista de pr√≥ximos alarmes a cada minuto
  setInterval(updateNextAlarmsList, 60000);
});

// Re-run verboso summary at load
window.addEventListener('load', () => {
  if(document.getElementById('toggleVerboso')?.checked){
    const nM = JSON.parse(localStorage.getItem(LS_MED) || '[]').length;
    const nH = JSON.parse(localStorage.getItem(LS_HIST) || '[]').length;
    const nC = JSON.parse(localStorage.getItem(LS_CONS) || '[]').length;
    
    speak(`Bem-vinda. Voc√™ tem ${nM} medicamentos, ${nH} registros no hist√≥rico e ${nC} consultas cadastradas.`);
  }
});

// Adiciona CSS para anima√ß√µes
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// ================= SISTEMA DE ALARMES PERSISTENTE =================
const LS_ALARMS = 'meu_remedio_alarms_v3';
const DB_NAME = 'MeuRemedioAlarms';
const DB_VERSION = 1;

let alarms = JSON.parse(localStorage.getItem(LS_ALARMS) || '[]');
let db = null;

// Inicializar IndexedDB para alarmes persistentes
async function initAlarmDatabase() {
    return new Promise((resolve, reject) => {
        if (!('indexedDB' in window)) {
            resolve(null); // Fallback para localStorage
            return;
        }

        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
            console.warn('IndexedDB n√£o dispon√≠vel, usando localStorage');
            resolve(null);
        };
        
        request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            const database = event.target.result;
            if (!database.objectStoreNames.contains('alarms')) {
                const store = database.createObjectStore('alarms', { keyPath: 'id' });
                store.createIndex('timestamp', 'timestamp', { unique: false });
            }
        };
    });
}

// Salvar alarme persistentemente
async function savePersistentAlarm(alarm) {
    // Salvar no localStorage (fallback b√°sico)
    alarms.push(alarm);
    localStorage.setItem(LS_ALARMS, JSON.stringify(alarms));
    
    // Salvar no IndexedDB se dispon√≠vel
    if (db) {
        return new Promise((resolve) => {
            const transaction = db.transaction(['alarms'], 'readwrite');
            const store = transaction.objectStore('alarms');
            store.put(alarm);
            transaction.oncomplete = () => resolve();
        });
    }
}

// Remover alarme persistente
async function removePersistentAlarm(alarmId) {
    alarms = alarms.filter(a => a.id !== alarmId);
    localStorage.setItem(LS_ALARMS, JSON.stringify(alarms));
    
    if (db) {
        return new Promise((resolve) => {
            const transaction = db.transaction(['alarms'], 'readwrite');
            const store = transaction.objectStore('alarms');
            store.delete(alarmId);
            transaction.oncomplete = () => resolve();
        });
    }
}

// Carregar alarmes pendentes
async function loadPendingAlarms() {
    if (db) {
        return new Promise((resolve) => {
            const transaction = db.transaction(['alarms'], 'readonly');
            const store = transaction.objectStore('alarms');
            const index = store.index('timestamp');
            const request = index.getAll();
            
            request.onsuccess = () => {
                const dbAlarms = request.result || [];
                // Mesclar com localStorage para compatibilidade
                const allAlarms = [...dbAlarms, ...alarms.filter(la => 
                    !dbAlarms.some(dba => dba.id === la.id)
                )];
                resolve(allAlarms);
            };
            
            request.onerror = () => resolve(alarms);
        });
    }
    
    return alarms;
}

// ================= SISTEMA H√çBRIDO DE NOTIFICA√á√ïES =================

// Agendamento inteligente que funciona offline/online
async function scheduleHybridNotification(id, when, title, body, data = {}) {
    const now = new Date().getTime();
    const triggerTime = when.getTime();
    
    if (triggerTime <= now) {
        // Disparar imediatamente se j√° passou do tempo
        showNotification(title, body, data);
        return;
    }

    const alarmData = {
        id,
        title,
        body,
        data,
        timestamp: triggerTime,
        createdAt: now,
        type: 'scheduled'
    };

    // 1. Tentar API de Notifica√ß√µes Agendadas (navegadores modernos)
    if ('Notification' in window && 'showTrigger' in Notification.prototype) {
        try {
            const registration = await navigator.serviceWorker?.ready;
            if (registration) {
                registration.showNotification(title, {
                    body,
                    tag: id,
                    showTrigger: new TimestampTrigger(triggerTime),
                    data: alarmData,
                    icon: 'icon-192.png',
                    requireInteraction: true
                });
                console.log('Notifica√ß√£o agendada via API nativa');
                return;
            }
        } catch (e) {
            console.warn('API de notifica√ß√µes agendadas n√£o suportada:', e);
        }
    }

    // 2. Agendamento tradicional (funciona online)
    const advanceTime = notifSettings.advanceTime * 60 * 1000;
    const notifyTime = new Date(triggerTime - advanceTime);
    const msUntilNotify = notifyTime - now;

    if (msUntilNotify > 0 && msUntilNotify < 2147483647) { // Max value for setTimeout
        const timer = setTimeout(() => {
            showNotification(title, body, data);
            removePersistentAlarm(id);
            scheduledTimers.delete(id);
        }, msUntilNotify);
        
        scheduledTimers.set(id, timer);
    }

    // 3. Sempre salvar persistentemente para verifica√ß√£o offline
    await savePersistentAlarm(alarmData);
    startBackgroundAlarmCheck();
}

// Verifica√ß√£o em background para alarmes offline
let backgroundCheckInterval = null;
function startBackgroundAlarmCheck() {
    if (backgroundCheckInterval) return;
    
    backgroundCheckInterval = setInterval(async () => {
        const pendingAlarms = await loadPendingAlarms();
        const now = new Date().getTime();
        
        for (const alarm of pendingAlarms) {
            if (alarm.timestamp <= now) {
                // Hora do alarme!
                showNotification(alarm.title, alarm.body, alarm.data);
                await removePersistentAlarm(alarm.id);
                
                // Feedback visual
                showInAppNotification(alarm.title, alarm.body);
            }
        }
        
        // Parar verifica√ß√£o se n√£o houver mais alarmes
        if (pendingAlarms.length === 0) {
            stopBackgroundAlarmCheck();
        }
    }, 30000); // Verificar a cada 30 segundos
}

function stopBackgroundAlarmCheck() {
    if (backgroundCheckInterval) {
        clearInterval(backgroundCheckInterval);
        backgroundCheckInterval = null;
    }
}

// ================= SERVICE WORKER PARA BACKGROUND SYNC =================

// Registrar Service Worker para funcionalidades em background
async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) return null;
    
    try {
        const registration = await navigator.serviceWorker.register('/sw.js', {
            scope: '/'
        });
        
        console.log('Service Worker registrado com sucesso');
        
        // Verificar se h√° alarmes pendentes quando o SW estiver pronto
        navigator.serviceWorker.ready.then(() => {
            checkPendingAlarmsOnWake();
        });
        
        return registration;
    } catch (error) {
        console.warn('Service Worker n√£o p√¥de ser registrado:', error);
        return null;
    }
}

// Verificar alarmes pendentes quando o app "acordar"
function checkPendingAlarmsOnWake() {
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible') {
            const pendingAlarms = await loadPendingAlarms();
            const now = new Date().getTime();
            
            // Disparar alarmes que venceram enquanto o app estava inativo
            for (const alarm of pendingAlarms) {
                if (alarm.timestamp <= now) {
                    showNotification(alarm.title, alarm.body, alarm.data);
                    await removePersistentAlarm(alarm.id);
                }
            }
        }
    });
}

// ================= ATUALIZAR FUN√á√ïES EXISTENTES =================

// Substituir a fun√ß√£o scheduleAllNotifications
function scheduleAllNotifications() {
    clearScheduledNotifications();
    stopBackgroundCheck();
    
    if (!notifSettings.medEnabled && !notifSettings.consEnabled) return;
    
    // Agenda notifica√ß√µes de medicamentos
    if (notifSettings.medEnabled) {
        meds.forEach(med => {
            if (med.hora) {
                const nextTime = calcularProximaHora(med.hora);
                scheduleHybridNotification(
                    'med_' + med.id,
                    nextTime,
                    'üíä Hora do Rem√©dio',
                    `${med.paciente ? med.paciente + ' - ' : ''}${med.nome}${med.instrucao ? ' - ' + med.instrucao : ''}`,
                    { type: 'med', id: med.id }
                );
            }
        });
    }
    
    // Agenda notifica√ß√µes de consultas
    if (notifSettings.consEnabled) {
        consults.forEach(cons => {
            const consultDate = new Date(cons.data + 'T00:00:00');
            if (isNaN(consultDate)) return;
            
            // Notifica√ß√£o no dia anterior √†s 9h
            const dayBefore = new Date(consultDate);
            dayBefore.setDate(consultDate.getDate() - 1);
            dayBefore.setHours(9, 0, 0, 0);
            
            // Notifica√ß√£o no mesmo dia √†s 8h
            const sameDay = new Date(consultDate);
            sameDay.setHours(8, 0, 0, 0);
            
            if (dayBefore > new Date()) {
                scheduleHybridNotification(
                    'cons_' + cons.id + '_pre',
                    dayBefore,
                    'üìÖ Consulta Amanh√£',
                    `${cons.prof} - ${formatarDataPTBR(cons.data)}`,
                    { type: 'consult', id: cons.id }
                );
            }
            
            if (sameDay > new Date()) {
                scheduleHybridNotification(
                    'cons_' + cons.id,
                    sameDay,
                    'üìÖ Consulta Hoje',
                    `${cons.prof} - ${formatarDataPTBR(cons.data)}`,
                    { type: 'consult', id: cons.id }
                );
            }
        });
    }
    
    updateNextAlarmsList();
}

// Inicializa√ß√£o melhorada
document.addEventListener('DOMContentLoaded', async () => {
    // Inicializar sistemas persistentes
    await initAlarmDatabase();
    await registerServiceWorker();
    
    // Verificar alarmes pendentes ao carregar
    const pendingAlarms = await loadPendingAlarms();
    if (pendingAlarms.length > 0) {
        startBackgroundAlarmCheck();
    }
    
    // Resto da inicializa√ß√£o...
});

// Service Worker (sw.js) - Criar este arquivo separado
self.addEventListener('install', (event) => {
    self.skipWaiting();
});

self.addEventListener('activate', (event) => {
    event.waitUntil(self.clients.claim());
});

self.addEventListener('notificationclick', (event) => {
    event.notification.close();
    
    // Focar na aba do app se estiver aberta, ou abrir nova
    event.waitUntil(
        self.clients.matchAll({ type: 'window' }).then((clientList) => {
            for (const client of clientList) {
                if (client.url.includes('/') && 'focus' in client) {
                    return client.focus();
                }
            }
            if (self.clients.openWindow) {
                return self.clients.openWindow('/');
            }
        })
    );
});
</script>
</body>
</html>
